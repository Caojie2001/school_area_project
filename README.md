# 高校建筑面积缺口测算系统

[![Node.js](https://img.shields.io/badge/Node.js-16+-green.svg)](https://nodejs.org/)
[![MySQL](https://img.shields.io/badge/MySQL-8.0+-blue.svg)](https://www.mysql.com/)
[![HTTPS](https://img.shields.io/badge/HTTPS-Enabled-green.svg)](https://developer.mozilla.org/en-US/docs/Web/HTTP/HTTPS)
[![Security](https://img.shields.io/badge/Security-Hardened-blue.svg)](./SECURITY_IMPLEMENTATION.md)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

一个现代化的Web应用程序，用于高校建筑面积缺口分析与计算。支持在线数据录入、自动标准化计算、智能缺口分析和专业报告生成。

**🔒 安全特性**: 全站HTTPS加密、安全会话管理、URL重定向保护、防止路径遍历攻击

## 核心功能

### 学校信息管理
- **多类型学校支持** - 综合、师范、工科、医学、农林、政法、财经、外语、艺术、体育等十种院校类型
- **学生数据统计** - 全日制学生、留学生分类管理
- **建筑面积录入** - 现有建筑面积详细记录
- **统一年份管理** - 使用统一的测算年份进行数据管理

### 智能测算分析
- **标准化计算** - 基于教育部标准的自动化面积计算
- **五类建筑分析** - 教学、办公、宿舍、生活、后勤用房全覆盖
- **缺口分析** - 精确计算各类建筑面积缺口
- **达标评估** - 自动判断各类用房达标情况
- **特殊补助** - 支持特殊用房补助项目动态添加

### 用户权限管理
- **多角色系统** - 管理员、基建中心、学校用户三级权限
- **安全认证** - 基于Session的用户认证机制
- **数据隔离** - 不同角色用户数据访问权限控制
- **用户管理** - 完整的用户增删改查功能

### 统计分析功能
- **多维度筛选** - 按年份、用户类型灵活筛选数据
- **汇总统计** - 自动计算总面积、缺口等关键指标
- **趋势分析** - 支持历史数据对比分析

### 数据管理
- **历史记录** - 完整的数据修改历史追踪
- **批量操作** - 支持数据批量导入导出
- **数据验证** - 完善的数据完整性检查
- **备份恢复** - 支持数据备份和恢复功能

## 技术架构

### 后端技术栈
```
Node.js 16+              服务器运行环境
Express.js 4.18+         Web应用框架
MySQL 8.0+               关系型数据库
mysql2 3.14+             MySQL连接驱动
bcrypt 6.0+              密码加密
express-session          会话管理
https                    HTTPS服务器支持
fs                       文件系统操作
xlsx 0.18+               Excel文件处理
cors 2.8+                跨域资源共享
dotenv 17.2+             环境变量管理
```

### 安全特性
```
SSL/TLS 加密             HTTPS协议全站加密
强制重定向               HTTP自动重定向到HTTPS
安全会话管理              httpOnly + secure cookies
URL重定向保护            防止恶意重定向攻击
路径遍历防护              防止目录遍历攻击
输入验证                 严格的数据验证机制
会话固化防护              安全的会话管理
```

### 前端技术栈
```
HTML5                    语义化页面结构
CSS3                     现代化样式设计
JavaScript ES6+          原生JS交互逻辑
Fetch API                异步数据通信
响应式设计               多设备屏幕适配
模块化架构               按功能拆分的组件结构
```

### 数据库设计
```
school_info              学校信息与测算结果主表
special_subsidies        特殊补助信息表
users                    用户信息与权限表
索引优化                 查询性能优化
```

## 项目结构

```
school_area_project/
├── 核心服务文件
│   ├── server.js                    Express服务器主文件
│   ├── db.sql                       数据库初始化脚本
│   └── install.sh                   自动安装配置脚本
│
├── 配置模块
│   └── config/
│       ├── database.js              MySQL数据库连接配置
│       ├── authService.js           用户认证服务
│       ├── dataService.js           数据访问层服务
│       ├── routes.js                路由配置
│       ├── appConfig.js             应用配置
│       ├── .env.example             环境变量配置模板
│       └── certs/                   SSL证书目录
│           ├── key.pem              SSL私钥文件
│           ├── cert.pem             SSL证书文件
│           ├── generate_cert.sh     证书生成脚本
│           └── README.md            证书使用说明
│
├── 前端资源
│   └── public/
│       ├── index.html               主应用界面（SPA架构）
│       ├── login.html               用户登录页面
│       ├── html/                    页面组件
│       │   ├── calculation-standards.html  面积标准配置页面组件
│       │   ├── data-entry.html      数据录入页面组件
│       │   ├── data-management.html 数据管理页面组件
│       │   ├── statistics.html      统计分析页面组件
│       │   └── user-management.html 用户管理页面
│       │
│       ├── css/                     模块化样式文件
│       │   ├── main.css             主样式文件（导入所有模块）
│       │   ├── base.css             基础样式（重置、字体、颜色）
│       │   ├── layout.css           布局样式（侧边栏、页面结构）
│       │   ├── components.css       组件样式（按钮、卡片、提示）
│       │   ├── forms.css            表单样式（输入框、选择器）
│       │   ├── student-fields.css   学生字段专用样式
│       │   ├── tables.css           表格样式（数据表格、冻结列）
│       │   ├── frozen-table.css     冻结表格专用样式
│       │   ├── results.css          结果显示样式（分析图表）
│       │   └── responsive.css       响应式样式（移动端适配）
│       │
│       ├── js/                      JavaScript模块
│       │   ├── main.js              主交互脚本
│       │   ├── api.js               API接口封装
│       │   ├── auth.js              认证相关功能
│       │   ├── componentManager.js  组件管理器
│       │   ├── dataEntry.js         数据录入功能
│       │   ├── dataManagement.js    数据管理功能
│       │   ├── statistics.js        统计分析功能
│       │   ├── userManagement.js    用户管理功能
│       │   ├── progressManager.js   进度管理器
│       │   └── utils.js             工具函数
│       │
│       ├── components/              可复用组件（预留）
│       │
│       └── assets/                  静态资源
│           └── login_background.jpg 登录背景图片
│
├── 数据文件
│   ├── data/                        基础数据文件
│   ├── output/                      Excel报告输出目录
│   └── backups/                     备份文件目录
│
├── 项目配置
│   ├── package.json                 项目依赖和脚本配置
│   ├── package-lock.json            依赖版本锁定文件
│   ├── .env                         环境变量配置文件
│   ├── .env.example                 环境变量配置模板
│   ├── .gitignore                   Git版本控制忽略规则
│   ├── Dockerfile                   Docker容器化配置
│   ├── .dockerignore               Docker构建忽略文件
│   ├── README.md                    项目说明文档
│   └── SECURITY_IMPLEMENTATION.md  安全实施报告
│
└── node_modules/                    依赖包目录
```

## 快速开始

### 环境要求
- **Node.js**: 16.0 或更高版本
- **npm**: 8.0 或更高版本  
- **MySQL**: 8.0 或更高版本
- **OpenSSL**: 1.1.1 或更高版本 (SSL证书生成)
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+

### 安装步骤

#### 方式一：自动安装（推荐）
```bash
# 1. 克隆或下载项目
git clone <repository-url>
cd school_area_project

# 2. 初始化数据库（必须先执行）
mysql -u root -p < db.sql

# 3. 生成SSL证书（生产环境可使用CA签名证书）
cd config/certs
chmod +x generate_cert.sh
./generate_cert.sh

# 4. 运行自动安装脚本
cd ../..
chmod +x install.sh
./install.sh
```

#### 方式二：手动安装
```bash
# 1. 初始化数据库（必须先执行）
mysql -u root -p < db.sql

# 2. 生成SSL证书
cd config/certs
chmod +x generate_cert.sh
./generate_cert.sh
cd ../..

# 3. 安装项目依赖
npm install

# 4. 复制环境配置文件
cp config/.env.example .env

# 5. 编辑配置文件
nano .env
```

### 环境配置

**重要提示：** 必须先执行 `db.sql` 文件来创建数据库和表结构，然后再配置环境变量。

**配置环境变量** (.env)
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=school_area_management

# 安全配置
SESSION_SECRET=your_strong_256_bit_secret_key_here

# SSL/HTTPS配置
SSL_KEY_PATH=./config/certs/key.pem
SSL_CERT_PATH=./config/certs/cert.pem
HTTPS_PORT=3443
HTTPS_FORCE_REDIRECT=true

# 服务器配置
PORT=3000
NODE_ENV=production
```

### 启动应用

```bash
# 生产环境启动
npm start

# 开发环境启动（需要安装nodemon）
npm run dev
```

**访问地址:**
- HTTP: http://localhost:3000 (自动重定向到HTTPS)
- HTTPS: https://localhost:3443 (推荐使用)

**首次访问说明:**  
由于使用自签名证书，浏览器会显示安全警告，请点击"高级"→"继续访问"即可。生产环境建议使用CA签名的正式SSL证书。

## 使用指南

### 安全访问
系统采用全站HTTPS加密，确保数据传输安全：
- **HTTPS强制重定向**: 所有HTTP请求自动重定向到HTTPS
- **安全会话管理**: 使用httpOnly和secure cookies
- **SSL证书支持**: 支持自签名证书和CA签名证书
- **URL重定向保护**: 防止恶意重定向攻击

### 数据录入流程
1. **安全登录** - 通过HTTPS加密通道使用学校用户账号登录
2. **选择学校类型** - 根据实际情况选择院校类型
3. **录入学生数据** - 分类录入全日制和留学生人数
4. **录入建筑面积** - 填写现有建筑面积数据
5. **添加特殊补助** - 根据需要添加特殊用房补助
6. **自动计算** - 系统自动计算缺口并生成分析结果
7. **生成报告** - 导出Excel格式的详细分析报告（含4个工作表）

### 数据管理功能
- **数据查询** - 支持多条件组合查询
- **数据编辑** - 在线编辑已保存的数据
- **数据删除** - 安全删除不需要的记录
- **批量操作** - 批量导入导出数据
- **历史追踪** - 完整的数据修改历史记录

### 统计分析功能
- **年份筛选** - 按测算年份查看数据
- **用户筛选** - 按用户类型分析数据
- **汇总统计** - 查看总体统计指标
- **趋势分析** - 多年数据对比分析
- **Excel报告** - 生成包含测算数据、特殊补助明细、测算明细和学生数明细的综合报告

## 系统配置

### 计算标准配置

系统基于国家教育部相关标准进行自动化面积计算，采用分类别、分层次的计算方法。

#### 基础面积配置标准

以下为各类院校的基础面积配置标准（平方米/人）：

| 院校类别 | 类别代码 | 教学及辅助用房(A) | 办公用房(B) | 学生宿舍(C1) | 其他生活用房(C2) | 后勤辅助用房(D) |
|---------|---------|------------------|-------------|-------------|----------------|----------------|
| 综合类 | A | 12.50 | 2.00 | 10.00 | 2.00 | 1.50 |
| 师范类 | B | 13.40 | 2.00 | 10.00 | 2.00 | 1.60 |
| 工科类 | C | 16.50 | 2.00 | 10.00 | 2.00 | 1.70 |
| 医学类 | D | 15.20 | 2.00 | 10.00 | 2.00 | 1.50 |
| 农林类 | E | 15.70 | 2.00 | 10.00 | 2.00 | 1.55 |
| 政法类 | F | 7.50 | 2.00 | 10.00 | 2.00 | 1.50 |
| 财经类 | G | 8.20 | 2.00 | 10.00 | 2.00 | 1.55 |
| 外语类 | H | 8.10 | 2.00 | 10.00 | 2.00 | 1.60 |
| 艺术类 | I | 53.50 | 3.50 | 10.00 | 2.50 | 2.00 |
| 体育类 | J | 22.00 | 2.20 | 10.00 | 2.00 | 1.80 |

#### 补贴面积配置标准

针对硕士生、博士生、留学生的额外补贴标准（平方米/人）：

**教学及辅助用房(A)补贴标准：**
| 院校类别 | 硕士生 | 博士生 | 留学生 |
|---------|-------|-------|-------|
| 综合类(A) | 3.00 | 3.00 | 0.00 |
| 师范类(B) | 3.00 | 3.00 | 0.00 |
| 工科类(C) | 3.00 | 3.00 | 0.00 |
| 医学类(D) | 3.00 | 3.00 | 0.00 |
| 农林类(E) | 3.00 | 3.00 | 0.00 |
| 政法类(F) | 3.00 | 3.00 | 0.00 |
| 财经类(G) | 3.00 | 3.00 | 0.00 |
| 外语类(H) | 3.00 | 3.00 | 0.00 |
| 艺术类(I) | 3.00 | 3.00 | 0.00 |
| 体育类(J) | 3.00 | 3.00 | 0.00 |

**办公用房(B)补贴标准：**
| 院校类别 | 硕士生 | 博士生 | 留学生 |
|---------|-------|-------|-------|
| 综合类(A) | 2.00 | 2.00 | 0.00 |
| 师范类(B) | 2.00 | 2.00 | 0.00 |
| 工科类(C) | 2.00 | 2.00 | 0.00 |
| 医学类(D) | 2.00 | 2.00 | 0.00 |
| 农林类(E) | 2.00 | 2.00 | 0.00 |
| 政法类(F) | 2.00 | 2.00 | 0.00 |
| 财经类(G) | 2.00 | 2.00 | 0.00 |
| 外语类(H) | 2.00 | 2.00 | 0.00 |
| 艺术类(I) | 2.00 | 2.00 | 0.00 |
| 体育类(J) | 2.00 | 2.00 | 0.00 |

**学生宿舍(C1)补贴标准：**
| 院校类别 | 硕士生 | 博士生 | 留学生 |
|---------|-------|-------|-------|
| 综合类(A) | 5.00 | 14.00 | 0.00 |
| 师范类(B) | 5.00 | 14.00 | 0.00 |
| 工科类(C) | 5.00 | 14.00 | 0.00 |
| 医学类(D) | 5.00 | 14.00 | 0.00 |
| 农林类(E) | 5.00 | 14.00 | 0.00 |
| 政法类(F) | 5.00 | 14.00 | 0.00 |
| 财经类(G) | 5.00 | 14.00 | 0.00 |
| 外语类(H) | 5.00 | 14.00 | 0.00 |
| 艺术类(I) | 5.00 | 14.00 | 0.00 |
| 体育类(J) | 5.00 | 14.00 | 0.00 |

**其他生活用房(C2)补贴标准：**
| 院校类别 | 硕士生 | 博士生 | 留学生 |
|---------|-------|-------|-------|
| 综合类(A) | 0.00 | 0.00 | 19.00 |
| 师范类(B) | 0.00 | 0.00 | 19.00 |
| 工科类(C) | 0.00 | 0.00 | 19.00 |
| 医学类(D) | 0.00 | 0.00 | 19.00 |
| 农林类(E) | 0.00 | 0.00 | 19.00 |
| 政法类(F) | 0.00 | 0.00 | 19.00 |
| 财经类(G) | 0.00 | 0.00 | 19.00 |
| 外语类(H) | 0.00 | 0.00 | 19.00 |
| 艺术类(I) | 0.00 | 0.00 | 19.00 |
| 体育类(J) | 0.00 | 0.00 | 19.00 |

**后勤辅助用房(D)补贴标准：**
| 院校类别 | 硕士生 | 博士生 | 留学生 |
|---------|-------|-------|-------|
| 所有类别 | 0.00 | 0.00 | 0.00 |

#### 计算公式说明

**基础计算公式：**
- 教学及辅助用房应配面积 = (专科生+本科生+硕士生+博士生+留学生) × 基础标准(A)
- 办公用房应配面积 = (专科生+本科生+硕士生+博士生+留学生) × 基础标准(B)
- 学生宿舍应配面积 = (专科生+本科生+硕士生+博士生+留学生) × 基础标准(C1)
- 其他生活用房应配面积 = (专科生+本科生+硕士生+博士生+留学生) × 基础标准(C2)
- 后勤辅助用房应配面积 = (专科生+本科生+硕士生+博士生+留学生) × 基础标准(D)

**补贴计算公式：**
- 各类用房补贴面积 = 硕士生数×硕士补贴标准 + 博士生数×博士补贴标准 + 留学生数×留学生补贴标准

**总应配面积：**
- 总应配面积 = 基础应配面积 + 补贴面积

**缺口计算：**
- 面积缺口 = 总应配面积 - 现有面积 (负值表示达标)

### 权限配置说明
- **管理员**: 完全权限，包括用户管理和系统配置
- **基建中心**: 数据审核和统计分析权限
- **学校用户**: 数据录入和查看权限

### 安全配置说明

#### SSL证书管理
```bash
# 生成新的SSL证书（有效期365天）
cd config/certs
./generate_cert.sh

# 检查证书有效期
openssl x509 -in cert.pem -text -noout | grep "Not After"

# 验证证书是否正确
openssl verify -CAfile cert.pem cert.pem
```

#### 安全配置项
- **SESSION_SECRET**: 建议使用256位随机密钥
- **HTTPS_FORCE_REDIRECT**: 生产环境建议设置为true
- **SSL证书路径**: 确保key.pem和cert.pem文件存在且权限正确
- **安全cookies**: 在HTTPS环境下自动启用

#### 生产环境建议
1. **使用CA签名证书**: 替换自签名证书避免浏览器警告
2. **配置防火墙**: 限制不必要的端口访问
3. **启用日志记录**: 监控异常访问行为
4. **定期更新**: 及时更新依赖包和证书

## 安全特性

### 已修复的安全漏洞
✅ **URL重定向漏洞** (CVSS: 6.5) - 已通过白名单验证完全修复  
✅ **用户凭证明文传输** (CVSS: 5.3) - 已通过HTTPS加密完全修复

详细的安全实施报告请查看: [SECURITY_IMPLEMENTATION.md](./SECURITY_IMPLEMENTATION.md)

### 安全防护措施
- **全站HTTPS加密**: 所有数据传输使用SSL/TLS加密
- **强制重定向**: HTTP请求自动重定向到HTTPS
- **URL重定向保护**: 防止恶意重定向攻击
- **路径遍历防护**: 防止目录遍历攻击
- **安全会话管理**: httpOnly + secure cookies
- **输入验证**: 严格的数据验证和过滤

## 故障排除

### 常见问题

**1. SSL证书相关问题**
```bash
# 检查证书文件是否存在
ls -la config/certs/

# 重新生成证书
cd config/certs && ./generate_cert.sh

# 检查证书权限
chmod 600 config/certs/key.pem
chmod 644 config/certs/cert.pem
```

**2. HTTPS连接问题**
- 浏览器显示"不安全"警告是正常的（自签名证书）
- 点击"高级" → "继续访问"即可
- 生产环境建议使用CA签名证书

**3. 数据库连接失败**
**4. 数据库连接失败**
```bash
# 检查MySQL服务状态
sudo systemctl status mysql

# 检查环境变量配置
cat .env
```

**5. 端口被占用**
```bash
# 查找占用端口的进程
lsof -i :3000
lsof -i :3443

# 终止进程
kill -9 <PID>
```

**6. 依赖安装失败**
```bash
# 清除npm缓存
npm cache clean --force

# 重新安装依赖
rm -rf node_modules package-lock.json
npm install
```
