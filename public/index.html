<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高校建筑面积缺口测算系统 - v2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* 左侧菜单样式 */
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid #34495e;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ecf0f1;
            line-height: 1.4;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #95a5a6;
            font-style: italic;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: block;
            padding: 18px 25px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #34495e;
            color: #ecf0f1;
            border-left-color: #3498db;
            transform: translateX(5px);
        }

        .menu-item.active {
            background: #34495e;
            color: #3498db;
            border-left-color: #3498db;
            font-weight: 600;
        }

        .menu-item .icon {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
            display: inline-block;
        }

        /* 下拉菜单样式 */
        .menu-dropdown {
            position: relative;
        }

        .menu-dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .menu-dropdown-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .menu-dropdown.open .menu-dropdown-arrow {
            transform: rotate(180deg);
        }

        .menu-dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #34495e;
        }

        .menu-dropdown.open .menu-dropdown-content {
            max-height: 200px;
        }

        .submenu-item {
            display: block;
            padding: 12px 25px 12px 45px;
            color: #95a5a6;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            border-left: 4px solid transparent;
        }

        .submenu-item:hover {
            background: #2c3e50;
            color: #ecf0f1;
            border-left-color: #3498db;
            transform: translateX(5px);
        }

        .submenu-item.active {
            background: #2c3e50;
            color: #3498db;
            border-left-color: #3498db;
            font-weight: 600;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .content-header {
            background: white;
            padding: 25px 30px;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header-left h2 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .content-header-left p {
            color: #6c757d;
            font-size: 16px;
            margin: 0;
        }

        .content-header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #2c3e50;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-role {
            font-size: 12px;
            color: #6c757d;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .content-body {
            padding: 30px;
            max-width: 1200px;
        }

        /* 页面内容区域 */
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f3f4;
            font-size: 20px;
            font-weight: 600;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 第一行三个字段的特殊布局 */
        .form-row:first-child {
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
        }

        .form-group-school-name {
            min-width: 0; /* 允许收缩 */
        }

        .form-group-year,
        .form-group-base-year {
            min-width: 120px; /* 年份字段最小宽度 */
        }

        /* 移动端响应式调整 */
        @media (max-width: 768px) {
            .form-row:first-child {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-group-year,
            .form-group-base-year {
                min-width: auto;
            }
        }

        /* 按钮样式 */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-download {
            background: white !important;
            color: #3498db !important;
            border: 2px solid #3498db !important;
        }

        .btn-download:hover {
            background: #3498db !important;
            color: white !important;
            border: 2px solid #3498db !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* 统计卡片样式 - 用于数据录入页面的分析结果显示 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            color: #2c3e50;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #3498db;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .stat-card h4 {
            font-size: 11px;
            margin-bottom: 12px;
            color: #2c3e50;
            font-weight: 600;
        }

        .stat-card .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .stat-card .stat-unit {
            font-size: 10px;
            color: #6c757d;
        }

        /* 表格样式 */
        .table-container {
            overflow: visible; /* 移除整体滚动条 */
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
        }

        .data-table {
            width: 100%;
            min-width: 1400px; /* 设置最小宽度以适应更多列 */
            border-collapse: separate; /* 改为separate以支持sticky定位 */
            border-spacing: 0;
            background: white;
            position: relative;
        }

        /* 数据列滚动区域 */
        .data-table-wrapper {
            position: relative;
            overflow: hidden;
        }

        /* 数据列滚动区域 */
        .data-table-wrapper {
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .data-table-scroll-area {
            margin-left: 240px; /* 左侧冻结列宽度 */
            margin-right: 260px; /* 右侧操作列宽度 */
            overflow-x: auto; /* 只在数据列区域添加水平滚动 */
            overflow-y: hidden;
        }

        /* 新的分栏表格结构 */
        .frozen-left-columns {
            position: absolute;
            left: 0;
            top: 0;
            width: 240px;
            z-index: 20;
            background: #f8f9fa;
            border-right: 2px solid #dee2e6;
        }

        .scrollable-middle-columns {
            margin-left: 240px;
            margin-right: 200px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .frozen-right-columns {
            position: absolute;
            right: 0;
            top: 0;
            width: 200px;
            z-index: 20;
            background: #f8f9fa;
            border-left: 2px solid #dee2e6;
        }

        .data-table-frozen-left,
        .data-table-scrollable,
        .data-table-frozen-right {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
        }

        .data-table-frozen-left th,
        .data-table-frozen-left td,
        .data-table-scrollable th,
        .data-table-scrollable td,
        .data-table-frozen-right th,
        .data-table-frozen-right td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            border-right: 1px solid #e9ecef;
            font-size: 12px;
            white-space: nowrap;
            background: white;
        }

        /* 冻结列单元格使用灰色背景 */
        .data-table-frozen-left th,
        .data-table-frozen-left td,
        .data-table-frozen-right th,
        .data-table-frozen-right td {
            background: #f8f9fa;
        }

        .data-table-frozen-left th,
        .data-table-scrollable th,
        .data-table-frozen-right th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 11px;
            letter-spacing: 0.3px;
            position: sticky;
            top: 0;
            z-index: 25;
        }

        /* 中间滚动区域的表头保持原色 */
        .data-table-scrollable th {
            background: #f8f9fa;
        }

        .data-table-frozen-left tr:hover,
        .data-table-scrollable tr:hover,
        .data-table-frozen-right tr:hover {
            background: #f8f9fa;
        }

        /* 冻结列hover效果 */
        .data-table-frozen-left tr:hover td,
        .data-table-frozen-right tr:hover td {
            background: #e9ecef;
        }

        /* 中间滚动区域hover效果 */
        .data-table-scrollable tr:hover td {
            background: #f8f9fa;
        }

        /* 左侧冻结列特殊样式 */
        .data-table-frozen-left th:first-child,
        .data-table-frozen-left td:first-child {
            width: 80px;
            min-width: 80px;
        }

        .data-table-frozen-left th:last-child,
        .data-table-frozen-left td:last-child {
            width: 160px;
            min-width: 160px;
            text-align: left;
            padding-left: 12px;
        }

        /* 中间滚动列统一宽度 */
        .data-table-scrollable th,
        .data-table-scrollable td {
            width: 140px;
            min-width: 140px;
        }

        .data-table-scrollable td:nth-child(1),
        .data-table-scrollable td:nth-child(2),
        .data-table-scrollable td:nth-child(3),
        .data-table-scrollable td:nth-child(4),
        .data-table-scrollable td:nth-child(5) {
            text-align: right;
            padding-right: 12px;
        }

        .data-table-scrollable td:nth-child(6),
        .data-table-scrollable td:nth-child(7) {
            width: 120px;
            min-width: 120px;
        }

        /* 右侧操作列样式 */
        .data-table-frozen-right th,
        .data-table-frozen-right td {
            width: 200px;
            min-width: 200px;
        }

        .data-table th,
        .data-table td {
            padding: 10px 8px; /* 减少左右padding以节省空间 */
            text-align: center; /* 居中对齐提高可读性 */
            border-bottom: 1px solid #e9ecef;
            border-right: 1px solid #e9ecef;
            font-size: 12px; /* 略微减小字体 */
            white-space: nowrap; /* 防止换行 */
            background: white; /* 确保背景色 */
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 11px;
            letter-spacing: 0.3px;
            position: sticky; /* 使表头固定 */
            top: 0;
            z-index: 20;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* hover状态下的冻结列特殊处理 */
        .data-table tr:hover td:nth-child(1),
        .data-table tr:hover td:nth-child(2),
        .data-table tr:hover td:last-child {
            background: #e9ecef; /* 冻结列hover时使用稍深的背景色 */
        }

        /* 冻结左侧列：测算年份和学校名称 */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 15;
            background: #f8f9fa;
            border-right: 2px solid #dee2e6;
            font-weight: bold;
            text-align: center;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            position: sticky;
            left: 80px; /* 第一列的宽度 */
            z-index: 15;
            background: #f8f9fa;
            border-right: 2px solid #dee2e6;
            font-weight: bold;
            text-align: left; /* 学校名称左对齐 */
            padding-left: 12px;
        }

        /* 冻结右侧操作列 */
        .data-table th:last-child,
        .data-table td:last-child {
            position: sticky;
            right: 0;
            z-index: 15;
            background: #f8f9fa;
            border-left: 2px solid #dee2e6;
            min-width: 260px;
        }

        /* 表头特殊样式 */
        .data-table th:nth-child(1),
        .data-table th:nth-child(2),
        .data-table th:last-child {
            z-index: 25; /* 表头优先级更高 */
        }

        /* 数据列特殊样式 */
        .data-table td:nth-child(3),
        .data-table td:nth-child(4),
        .data-table td:nth-child(5),
        .data-table td:nth-child(6),
        .data-table td:nth-child(7) {
            text-align: right;
            padding-right: 12px;
        }

        /* 设置列宽 */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            width: 80px;
            min-width: 80px;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            width: 160px;
            min-width: 160px;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3),
        .data-table th:nth-child(4),
        .data-table td:nth-child(4),
        .data-table th:nth-child(5),
        .data-table td:nth-child(5),
        .data-table th:nth-child(6),
        .data-table td:nth-child(6),
        .data-table th:nth-child(7),
        .data-table td:nth-child(7) {
            width: 140px;
            min-width: 140px;
        }

        .data-table th:nth-child(8),
        .data-table td:nth-child(8) {
            width: 120px;
            min-width: 120px;
        }

        /* 搜索栏 */
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: #f8f9fa;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
        }

        /* 加载动画 */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 16px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e9ecef;
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-left: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 消息提示 */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 100%;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block !important;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .search-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .content-header {
                padding: 20px;
            }

            .content-body {
                padding: 20px;
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* 特殊补助动态表单 */
        .subsidy-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .subsidy-item input {
            flex: 1;
        }

        .remove-subsidy {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
        }

        .school-type-display {
            color: #3498db;
            font-weight: 500;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        /* 表单相关样式 */
        .form-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 25px;
        }

        .data-form {
            max-width: 100%;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f3f4;
            font-size: 18px;
            font-weight: 600;
        }

        .student-category {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .subsidy-item {
            margin-bottom: 0;
        }

        .subsidy-item .form-group {
            margin-bottom: 0;
            min-width: 0; /* 确保宽度正确计算 */
        }

        .subsidy-item .form-row {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) auto;
            gap: 15px;
            align-items: end;
            width: 100%;
        }

        .subsidy-item .form-group:last-child {
            display: flex;
            align-items: flex-end;
        }

        /* 为没有标签的form-group添加顶部间距，使其与有标签的输入框对齐 */
        /* 注释掉，因为我们希望所有补助项紧密排列 */
        /*
        .subsidy-item .form-group:not(:last-child):not(:has(label)) {
            margin-top: 28px;
        }

        .subsidy-item .form-group.no-label {
            margin-top: 28px;
        }
        */

        /* 确保汇总行与明细行完全对齐 */
        .subsidy-summary.subsidy-item .form-row {
            display: grid !important;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) auto !important;
            gap: 15px !important;
            align-items: end !important;
            width: 100% !important;
        }

        .subsidy-summary.subsidy-item .form-group {
            margin-bottom: 0 !important;
        }

        .subsidy-summary.subsidy-item .form-group:last-child {
            display: flex !important;
            align-items: flex-end !important;
        }

        .calculated-field {
            background: #f1f3f4 !important;
            cursor: not-allowed;
        }

        .school-type-display {
            display: block;
            margin-top: 5px;
            color: #3498db;
            font-weight: 600;
            font-size: 12px;
        }

        /* 按钮样式增强 */
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: #3498db;
            border: 2px solid #3498db;
        }

        .btn-outline:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .form-actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .form-actions .btn {
            margin: 0 10px;
        }

        /* 进度条样式 */
        .progress-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin: 25px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f1f3f4;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 结果显示样式 */
        .result-section,
        .school-info-section,
        .analysis-results-section {
            margin: 25px 0;
        }

        /* 优化的计算结果样式 */
        .result-section .card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
        }

        .result-section h3 {
            color: #0c4a6e;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-section h3::before {
            content: '';
            font-size: 0;
        }

        /* 学校信息卡片优化 */
        .school-info-section .card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #22c55e;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
        }

        .school-info-section h3 {
            color: #14532d;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .school-info-section h3::before {
            content: '';
            font-size: 0;
        }

        .school-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .school-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .school-name {
            color: #1f2937;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        .school-type {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .school-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            margin-bottom: 6px;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .stat-value {
            color: #1f2937;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .stat-group {
            grid-column: 1 / -1;
            background: #fafafa;
            border-radius: 8px;
            padding: 15px;
            margin: 8px 0;
        }

        .stat-group-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-group-title::before {
            content: '';
            font-size: 0;
        }

        .stat-group .stat-item {
            margin-bottom: 6px;
            border-left-color: #10b981;
        }

        /* 分析结果卡片优化 */
        .analysis-results-section .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .analysis-results-section h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-results-section h3::before {
            content: '';
            font-size: 0;
        }

        .analysis-summary {
            margin-bottom: 30px;
        }

        .analysis-summary h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: none;
            padding-bottom: 0;
        }

        /* 概况统计卡片样式 - 用于数据录入页面的分析结果显示 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            color: #2c3e50;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #3498db;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .stat-card h4 {
            font-size: 11px;
            margin-bottom: 12px;
            color: #2c3e50;
            font-weight: 600;
        }

        .stat-card .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .stat-card .stat-unit {
            font-size: 10px;
            color: #6c757d;
        }

        /* 直接分析内容样式，不使用标题和大框 */
        .direct-analysis-content {
            margin-top: 20px;
        }

        .school-analysis-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f3f4f6;
        }

        .school-title {
            color: #1f2937;
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
        }

        .compliance-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .compliance-badge.compliant {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
        }

        .compliance-badge.non-compliant {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .area-type-analysis {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .area-type-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #374151;
        }

        .area-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .area-status.compliant {
            background: #dcfce7;
            color: #166534;
        }

        .area-status.non-compliant {
            background: #fecaca;
            color: #991b1b;
        }

        .area-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .area-details > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: white;
            border-radius: 5px;
            border-left: 2px solid #64748b;
            font-size: 0.75rem;
        }

        .gap-highlight {
            color: #dc2626;
            font-weight: 700;
        }

        .surplus-highlight {
            color: #16a34a;
            font-weight: 700;
        }

        .special-subsidy-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #0ea5e9;
        }

        .special-subsidy-info h5 {
            color: #0c4a6e;
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .subsidy-details {
            display: grid;
            gap: 10px;
        }

        .subsidy-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 4px 16px;
            font-size: 0.9rem;
        }

        .subsidy-details-table {
            max-width: 60%;
        }

        .subsidy-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .subsidy-table th,
        .subsidy-table td {
            padding: 6px 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .subsidy-table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #374151;
        }

        .no-subsidy {
            color: #6b7280;
            font-style: italic;
            font-size: 0.9rem;
        }

        .download-link {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .download-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            /* 特殊补助行在移动端仍保持三列布局 */
            .subsidy-item .form-row {
                grid-template-columns: 2fr 1fr auto;
                gap: 10px;
            }
            
            .form-actions .btn {
                width: 100%;
                margin: 5px 0;
            }

            /* 移动端结果显示优化 */
            .school-stats {
                grid-template-columns: 1fr;
            }

            .stat-group {
                grid-column: 1;
            }

            .summary-stats {
                grid-template-columns: 1fr;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .school-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .analysis-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .subsidy-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 10px 12px;
            }

            .subsidy-details-table {
                max-width: 100%;
            }

            .area-details > div {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                padding: 5px 8px;
                font-size: 0.7rem;
            }
        }

        /* 年份选择器样式 */
        .year-selector-container {
            position: relative;
        }

        .year-input {
            cursor: pointer;
            background: white !important;
        }

        .year-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .year-grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .year-grid-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .year-grid-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .year-nav-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .year-nav-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .year-nav-btn:active {
            transform: scale(0.95);
        }

        .year-range-text {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .year-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .year-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            color: #495057;
            transition: all 0.3s ease;
            position: relative;
        }

        .year-item:hover {
            background: #e3f2fd;
            border-color: #3498db;
            color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .year-item.current {
            background: #3498db;
            border-color: #2980b9;
            color: white;
        }

        .year-item.current:hover {
            background: #2980b9;
            border-color: #1e6091;
            color: white;
        }

        .year-item.selected {
            background: #27ae60;
            border-color: #219a52;
            color: white;
        }

        .year-item.selected:hover {
            background: #219a52;
            border-color: #1e8449;
        }

        .year-grid-footer {
            text-align: center;
        }

        .year-close-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .year-close-btn:hover {
            background: #5a6268;
        }

        /* 移动端年份选择器优化 */
        @media (max-width: 768px) {
            .year-grid-container {
                width: 95%;
                padding: 15px;
            }

            .year-grid {
                gap: 8px;
            }

            .year-item {
                padding: 12px 8px;
                font-size: 14px;
            }

            .year-nav-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }

        /* 学生人数统计字段样式 */
        .calculated-field {
            font-weight: bold !important;
            text-align: center !important;
        }

        .calculated-field[style*="background: #e8f4fd"] {
            color: #2980b9 !important;
            font-size: 16px !important;
        }

        .calculated-field[style*="background: #e8f5e8"] {
            color: #27ae60 !important;
            font-size: 16px !important;
        }

        .calculated-field[style*="background: #f8f9fa"] {
            color: #2c3e50 !important;
            font-size: 18px !important;
            font-weight: 900 !important;
        }

        /* 学生人数输入字段紧凑布局 */
        .student-category .form-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .student-category .form-group {
            flex: 1;
            min-width: 140px;
            max-width: 180px;
        }

        .student-category .form-group label {
            font-size: 13px;
            line-height: 1.2;
            margin-bottom: 6px;
            display: block;
        }

        .student-category .form-group input {
            font-size: 14px;
            padding: 8px 10px;
            height: auto;
        }

        /* 留学生行特殊样式 - 4个字段与5个全日制字段总宽度一致 */
        .student-category .international-row .form-group {
            flex: 1.25; /* 4个字段 * 1.25 = 5，与全日制5个字段总比例一致 */
            min-width: 175px; /* 稍微增加最小宽度 */
            max-width: 245px; /* 稍微增加最大宽度 */
        }

        .student-category .form-group small {
            font-size: 11px;
            line-height: 1.2;
            margin-top: 3px;
        }

        /* 总计字段特殊样式 */
        .student-category .form-group:last-child {
            flex: 1.2;
            max-width: 200px;
        }

        .student-category .form-group:last-child input {
            font-weight: bold;
            text-align: center;
            font-size: 15px;
        }

        /* 学生人数字段响应式调整 */
        @media (max-width: 1200px) {
            .student-category .form-group {
                min-width: 120px;
                max-width: 160px;
            }
            
            .student-category .form-group label {
                font-size: 12px;
            }
            
            .student-category .form-group input {
                font-size: 13px;
                padding: 6px 8px;
            }
        }

        @media (max-width: 768px) {
            .student-category .form-row {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .student-category .form-group {
                min-width: calc(50% - 4px);
                max-width: calc(50% - 4px);
                margin-bottom: 10px;
            }
            
            .student-category .form-group:last-child {
                min-width: 100%;
                max-width: 100%;
            }
        }

        /* 批量导出样式 */
        .export-controls {
            margin-top: 15px;
        }
        
        .export-progress {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #495057;
            font-weight: 500;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            border: 1px solid #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
            border-color: #1e7e34;
        }
        
        .btn-success:disabled {
            background: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }

        /* 缺口显示样式 */
        .gap-positive {
            font-weight: 600;
        }
        
        .gap-negative {
            font-weight: 600;
        }

    </style>
</head>
<body>
    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
    
    <div class="app-container">
        <!-- 左侧菜单 -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>高校建筑面积缺口测算系统</h1>
                <p>Building Area Gap Analysis System</p>
            </div>
            
            <div class="sidebar-menu">
                <a class="menu-item active" onclick="showPage('data-entry')" id="menu-data-entry">
                    数据填报
                </a>
                <a class="menu-item" onclick="showPage('data-management')" id="menu-data-management">
                    数据管理
                </a>
                <!-- 统计分析菜单项（仅基建中心和管理员可见） -->
                <a class="menu-item" onclick="showPage('statistics')" id="menu-statistics" style="display: none;">
                    统计分析
                </a>
                <!-- 用户管理菜单项（仅管理员可见） -->
                <a class="menu-item" onclick="showPage('user-management')" id="menu-user-management" style="display: none;">
                    用户管理
                </a>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 数据填报页面 -->
            <div id="page-data-entry" class="page-content active">
                <div class="content-header">
                    <div class="content-header-left">
                        <h2>数据填报</h2>
                        <p>填写学校基本信息和建筑面积数据，自动计算建筑面积缺口</p>
                    </div>
                    <div class="content-header-right">
                        <div class="user-info" id="userInfo">
                            <div class="user-avatar" id="userAvatar">A</div>
                            <div class="user-details">
                                <div class="user-name" id="userName">加载中...</div>
                                <div class="user-role" id="userRole">用户</div>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout()">退出登录</button>
                    </div>
                </div>
                <div class="content-body">
                    <!-- 在线数据填写表单 -->
                    <div class="online-form-section" id="onlineFormSection">
                        <div class="form-container">
                        <form id="onlineDataForm" class="data-form">
                            <div class="form-row">
                                <div class="form-group form-group-school-name">
                                    <label for="schoolName">学校名称 *</label>
                                    <select id="schoolName" name="schoolName" required class="form-control" style="background: white;" onchange="updateSchoolType()">
                                        <option value="">请选择学校</option>
                                        <option value="上海大学">上海大学</option>
                                        <option value="上海交通大学医学院">上海交通大学医学院</option>
                                        <option value="上海理工大学">上海理工大学</option>
                                        <option value="上海师范大学">上海师范大学</option>
                                        <option value="上海科技大学">上海科技大学</option>
                                        <option value="华东政法大学">华东政法大学</option>
                                        <option value="上海海事大学">上海海事大学</option>
                                        <option value="上海海洋大学">上海海洋大学</option>
                                        <option value="上海中医药大学">上海中医药大学</option>
                                        <option value="上海体育大学">上海体育大学</option>
                                        <option value="上海音乐学院">上海音乐学院</option>
                                        <option value="上海戏剧学院">上海戏剧学院</option>
                                        <option value="上海电力大学">上海电力大学</option>
                                        <option value="上海对外经贸大学">上海对外经贸大学</option>
                                        <option value="上海应用技术大学">上海应用技术大学</option>
                                        <option value="上海立信会计金融学院">上海立信会计金融学院</option>
                                        <option value="上海工程技术大学">上海工程技术大学</option>
                                        <option value="上海第二工业大学">上海第二工业大学</option>
                                        <option value="上海商学院">上海商学院</option>
                                        <option value="上海电机学院">上海电机学院</option>
                                        <option value="上海政法学院">上海政法学院</option>
                                        <option value="上海健康医学院">上海健康医学院</option>
                                        <option value="上海出版印刷高等专科学校">上海出版印刷高等专科学校</option>
                                        <option value="上海旅游高等专科学校">上海旅游高等专科学校</option>
                                        <option value="上海城建职业学院">上海城建职业学院</option>
                                        <option value="上海电子信息职业技术学院">上海电子信息职业技术学院</option>
                                        <option value="上海工艺美术职业学院">上海工艺美术职业学院</option>
                                        <option value="上海农林职业技术学院">上海农林职业技术学院</option>
                                        <option value="上海健康医学院附属卫生学校(上海健康护理职业学院(筹))">上海健康医学院附属卫生学校(上海健康护理职业学院(筹))</option>
                                    </select>
                                    <small class="school-type-display" id="schoolTypeDisplay"></small>
                                </div>
                                <div class="form-group form-group-year">
                                    <label for="year">测算年份 *</label>
                                    <div class="year-selector-container">
                                        <input type="text" id="year" name="year" value="2025" readonly required class="form-control year-input" onclick="showYearGrid()">
                                        <div class="year-grid-overlay" id="yearGridOverlay" style="display: none;">
                                            <div class="year-grid-container">
                                                <div class="year-grid-header">
                                                    <button type="button" class="year-nav-btn" id="yearPrevBtn" onclick="moveYearGrid(-1)">‹</button>
                                                    <span class="year-range-text" id="yearRangeText"></span>
                                                    <button type="button" class="year-nav-btn" id="yearNextBtn" onclick="moveYearGrid(1)">›</button>
                                                </div>
                                                <div class="year-grid" id="yearGrid">
                                                    <!-- 年份九宫格将在这里动态生成 -->
                                                </div>
                                                <div class="year-grid-footer">
                                                    <button type="button" class="year-close-btn" onclick="hideYearGrid()">关闭</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>学生人数信息</h3>
                                <div class="form-row" style="margin-bottom: 20px;">
                                    <div class="form-group form-group-student-year">
                                        <label for="student_stat_year">学生统计年份 *</label>
                                        <div class="year-selector-container">
                                            <input type="text" id="student_stat_year" name="student_stat_year" value="2025" readonly required class="form-control year-input" onclick="showStudentYearGrid()">
                                            <div class="year-grid-overlay" id="studentYearGridOverlay" style="display: none;">
                                                <div class="year-grid-container">
                                                    <div class="year-grid-header">
                                                        <button type="button" class="year-nav-btn" id="studentYearPrevBtn" onclick="moveStudentYearGrid(-1)">‹</button>
                                                        <span class="year-range-text" id="studentYearRangeText"></span>
                                                        <button type="button" class="year-nav-btn" id="studentYearNextBtn" onclick="moveStudentYearGrid(1)">›</button>
                                                    </div>
                                                    <div class="year-grid" id="studentYearGrid">
                                                        <!-- 学生统计年份九宫格将在这里动态生成 -->
                                                    </div>
                                                    <div class="year-grid-footer">
                                                        <button type="button" class="year-close-btn" onclick="hideStudentYearGrid()">关闭</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="student-category">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>全日制学生总数(人)</label>
                                            <input type="text" id="fullTimeTotal" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="fullTimeSpecialist">专科全日制学生数(人)</label>
                                            <input type="number" id="fullTimeSpecialist" name="fullTimeSpecialist" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="fullTimeUndergraduate">本科全日制学生数(人)</label>
                                            <input type="number" id="fullTimeUndergraduate" name="fullTimeUndergraduate" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="fullTimeMaster">硕士全日制学生数(人)</label>
                                            <input type="number" id="fullTimeMaster" name="fullTimeMaster" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="fullTimeDoctor">博士全日制学生数(人)</label>
                                            <input type="number" id="fullTimeDoctor" name="fullTimeDoctor" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd; font-weight: normal; text-align: left;">
                                        </div>
                                    </div>
                                    <div class="form-row international-row">
                                        <div class="form-group">
                                            <label>留学生总数(人)</label>
                                            <input type="text" id="internationalTotal" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="internationalUndergraduate">本科留学生数(人)</label>
                                            <input type="number" id="internationalUndergraduate" name="internationalUndergraduate" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="internationalMaster">硕士留学生数(人)</label>
                                            <input type="number" id="internationalMaster" name="internationalMaster" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="internationalDoctor">博士留学生数(人)</label>
                                            <input type="number" id="internationalDoctor" name="internationalDoctor" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd; font-weight: normal; text-align: left;">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>学生总人数(人)</label>
                                        <input type="text" id="totalStudents" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd; font-weight: bold;">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>现状建筑面积信息</h3>
                                <div class="form-row" style="margin-bottom: 20px;">
                                    <div class="form-group form-group-building-year">
                                        <label for="building_stat_year">建筑面积统计年份 *</label>
                                        <div class="year-selector-container">
                                            <input type="text" id="building_stat_year" name="building_stat_year" value="2025" readonly required class="form-control year-input" onclick="showBuildingYearGrid()">
                                            <div class="year-grid-overlay" id="buildingYearGridOverlay" style="display: none;">
                                                <div class="year-grid-container">
                                                    <div class="year-grid-header">
                                                        <button type="button" class="year-nav-btn" id="buildingYearPrevBtn" onclick="moveBuildingYearGrid(-1)">‹</button>
                                                        <span class="year-range-text" id="buildingYearRangeText"></span>
                                                        <button type="button" class="year-nav-btn" id="buildingYearNextBtn" onclick="moveBuildingYearGrid(1)">›</button>
                                                    </div>
                                                    <div class="year-grid" id="buildingYearGrid">
                                                        <!-- 建筑面积统计年份九宫格将在这里动态生成 -->
                                                    </div>
                                                    <div class="year-grid-footer">
                                                        <button type="button" class="year-close-btn" onclick="hideBuildingYearGrid()">关闭</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1; margin-right: 15px;">
                                        <label for="teachingArea">教学及辅助用房面积(m²)</label>
                                        <input type="number" id="teachingArea" name="teachingArea" min="0" step="0.01" value="0" class="form-control" oninput="calculateTotalBuildingArea()" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">包括教室、实验室、图书馆等</small>
                                    </div>
                                    <div class="form-group" style="flex: 1; margin-right: 15px;">
                                        <label for="officeArea">办公用房面积(m²)</label>
                                        <input type="number" id="officeArea" name="officeArea" min="0" step="0.01" value="0" class="form-control" oninput="calculateTotalBuildingArea()" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">行政办公、教师办公等</small>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="logisticsArea">后勤辅助用房面积(m²)</label>
                                        <input type="number" id="logisticsArea" name="logisticsArea" min="0" step="0.01" value="0" class="form-control" oninput="calculateTotalBuildingArea()" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">设备用房、仓库等</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1; margin-right: 15px;">
                                        <label for="totalLivingArea">生活用房总面积(m²)</label>
                                        <input type="number" id="totalLivingArea" name="totalLivingArea" min="0" step="0.01" value="0" class="form-control" oninput="calculateOtherLivingArea(); calculateTotalBuildingArea();" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">所有生活用房的总面积</small>
                                    </div>
                                    <div class="form-group" style="flex: 1; margin-right: 15px;">
                                        <label for="dormitoryArea">其中:学生宿舍面积(m²)</label>
                                        <input type="number" id="dormitoryArea" name="dormitoryArea" min="0" step="0.01" value="0" class="form-control" oninput="calculateOtherLivingArea(); calculateTotalBuildingArea();" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">学生住宿用房面积</small>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>其中:其他生活用房面积(m²)</label>
                                        <input type="text" id="otherLivingArea" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">自动计算：生活用房总面积 - 学生宿舍面积</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>建筑总面积(m²)</label>
                                        <input type="text" id="totalBuildingArea" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd; font-weight: bold;">
                                        <small style="color: #6c757d; font-size: 12px;">自动计算：教学及辅助用房面积+办公用房面积+生活用房总面积+后勤辅助用房面积</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>特殊用房补助信息</h3>
                                <div id="specialSubsidies">
                                    <!-- 特殊补助项将在这里动态添加 -->
                                </div>
                                <button type="button" class="btn btn-outline" onclick="addSubsidy()" style="background: transparent; color: #3498db; border: 2px solid #3498db; padding: 12px 20px; border-radius: 6px; cursor: pointer;">添加特殊补助</button>
                            </div>
                            
                            <div class="card">
                                <div class="form-group">
                                    <label for="remarks">备注</label>
                                    <textarea id="remarks" name="remarks" rows="3" placeholder="其他需要说明的信息" class="form-control" style="background: white; border: 1px solid #ddd;"></textarea>
                                </div>
                            </div>
                            
                            <div class="form-actions" style="text-align: center; margin-top: 30px;">
                                <button type="button" class="btn btn-outline" onclick="resetForm()" style="background: white; color: #3498db; border: 2px solid #3498db; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin-right: 15px;">重置表单</button>
                                <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: 600;">计算分析</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 计算进度显示 -->
                <div class="progress-section" id="progressSection" style="display: none;">
                    <div class="card">
                        <h3>计算进度</h3>
                        <div class="progress-bar" style="width: 100%; height: 20px; background: #f1f3f4; border-radius: 10px; overflow: hidden; margin: 15px 0;">
                            <div class="progress-fill" id="progressFill" style="height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <p id="progressText" style="text-align: center; color: #6c757d;">准备计算...</p>
                    </div>
                </div>

                <!-- 计算结果显示 -->
                <div class="result-section" id="resultSection" style="display: none;">
                    <div class="card">
                        <h3>计算结果</h3>
                        <div class="result-content" id="resultContent"></div>
                    </div>
                </div>

                <!-- 学校信息显示 -->
                <div class="school-info-section" id="schoolInfoSection" style="display: none;">
                    <div class="card">
                        <h3>学校信息</h3>
                        <div class="school-info-content" id="schoolInfoContent"></div>
                    </div>
                </div>

                <!-- 分析结果详情 -->
                <div class="analysis-results-section" id="analysisResultsSection" style="display: none;">
                    <div class="card">
                        <div class="analysis-results-content" id="analysisResultsContent"></div>
                    </div>
                </div>
                </div>
            </div>

            <!-- 数据管理页面 -->
            <div id="page-data-management" class="page-content">
                <div class="content-header">
                    <div class="content-header-left">
                        <h2>数据管理</h2>
                        <p>查看、编辑和管理已提交的测算数据记录</p>
                    </div>
                    <div class="content-header-right">
                        <div class="user-info" id="userInfo2">
                            <div class="user-avatar" id="userAvatar2">A</div>
                            <div class="user-details">
                                <div class="user-name" id="userName2">加载中...</div>
                                <div class="user-role" id="userRole2">用户</div>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout()">退出登录</button>
                    </div>
                </div>
                <div class="content-body">
                    <!-- 学校历史查询 -->
                    <div class="card">
                        <div class="search-bar">
                            <select id="dataYearFilter" class="search-input" style="width: 12%; min-width: 100px;">
                                <option value="all">所有测算年份</option>
                            </select>
                            <select id="dataSchoolNameFilter" class="search-input" style="width: 28%; min-width: 150px;">
                                <option value="all">所有学校</option>
                                <option value="上海大学">上海大学</option>
                                <option value="上海交通大学医学院">上海交通大学医学院</option>
                                <option value="上海理工大学">上海理工大学</option>
                                <option value="上海师范大学">上海师范大学</option>
                                <option value="上海科技大学">上海科技大学</option>
                                <option value="华东政法大学">华东政法大学</option>
                                <option value="上海海事大学">上海海事大学</option>
                                <option value="上海海洋大学">上海海洋大学</option>
                                <option value="上海中医药大学">上海中医药大学</option>
                                <option value="上海体育大学">上海体育大学</option>
                                <option value="上海音乐学院">上海音乐学院</option>
                                <option value="上海戏剧学院">上海戏剧学院</option>
                                <option value="上海电力大学">上海电力大学</option>
                                <option value="上海对外经贸大学">上海对外经贸大学</option>
                                <option value="上海应用技术大学">上海应用技术大学</option>
                                <option value="上海立信会计金融学院">上海立信会计金融学院</option>
                                <option value="上海工程技术大学">上海工程技术大学</option>
                                <option value="上海第二工业大学">上海第二工业大学</option>
                                <option value="上海商学院">上海商学院</option>
                                <option value="上海电机学院">上海电机学院</option>
                                <option value="上海政法学院">上海政法学院</option>
                                <option value="上海健康医学院">上海健康医学院</option>
                                <option value="上海出版印刷高等专科学校">上海出版印刷高等专科学校</option>
                                <option value="上海旅游高等专科学校">上海旅游高等专科学校</option>
                                <option value="上海城建职业学院">上海城建职业学院</option>
                                <option value="上海电子信息职业技术学院">上海电子信息职业技术学院</option>
                                <option value="上海工艺美术职业学院">上海工艺美术职业学院</option>
                                <option value="上海农林职业技术学院">上海农林职业技术学院</option>
                                <option value="上海健康医学院附属卫生学校(上海健康护理职业学院(筹))">上海健康医学院附属卫生学校(上海健康护理职业学院(筹))</option>
                            </select>
                            <select id="dataUserFilter" class="search-input" style="width: 15%; min-width: 100px;">
                                <option value="all">所有测算用户</option>
                            </select>

                            <button class="btn btn-primary" onclick="searchDataRecords()" style="width: 10%; min-width: 70px; margin-left: 8px;">查找</button>
                            <button class="btn btn-secondary" onclick="batchDownloadSearchResults()" id="batchDownloadBtn" style="background: #28a745; color: white; width: 13%; min-width: 90px; margin-left: 8px;" disabled>批量下载</button>
                        </div>
                        
                        <div id="dataHistoryResults">
                            <div class="alert alert-info">请选择筛选条件并点击查找按钮</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计分析页面 -->
            <div id="page-statistics" class="page-content">
                <div class="content-header">
                    <div class="content-header-left">
                        <h2>统计分析</h2>
                        <p>查看各学校数据填报情况的总体概览</p>
                    </div>
                    <div class="content-header-right">
                        <div class="user-info" id="userInfo3">
                            <div class="user-avatar" id="userAvatar3">A</div>
                            <div class="user-details">
                                <div class="user-name" id="userName3">加载中...</div>
                                <div class="user-role" id="userRole3">用户</div>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout()">退出登录</button>
                    </div>
                </div>
                <div class="content-body">
                    <!-- 数据统计卡片 -->
                    <div class="stats-cards-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="stat-card">
                            <h4>现状建筑总面积</h4>
                            <div class="stat-value" id="overviewCurrentArea">0.00</div>
                            <div class="stat-unit">(m²)</div>
                        </div>
                        <div class="stat-card">
                            <h4>学生规模测算建筑总面积</h4>
                            <div class="stat-value" id="overviewRequiredArea">0.00</div>
                            <div class="stat-unit">(m²)</div>
                        </div>
                        <div class="stat-card">
                            <h4>学生规模测算建筑面积总缺额(不含补助)</h4>
                            <div class="stat-value" id="overviewGapWithoutSubsidy">0.00</div>
                            <div class="stat-unit">(m²)</div>
                        </div>
                        <div class="stat-card">
                            <h4>学生规模测算建筑面积总缺额(含补助)</h4>
                            <div class="stat-value" id="overviewGapWithSubsidy">0.00</div>
                            <div class="stat-unit">(m²)</div>
                        </div>
                    </div>

                    <!-- 筛选区域 -->
                    <div class="card">
                        <div class="search-bar">
                            <select id="overviewYearFilter" class="search-input" style="width: 20%; min-width: 120px;">
                                <!-- 年份选项将通过JavaScript动态加载 -->
                            </select>
                            <select id="overviewUserTypeFilter" class="search-input" style="width: 25%; min-width: 150px;">
                                <option value="school">所有学校用户</option>
                                <option value="construction_center" selected>所有基建中心用户</option>
                            </select>
                            <button class="btn btn-primary" onclick="searchOverviewRecords()" style="width: 10%; min-width: 70px; margin-left: 8px;">查找</button>
                        </div>
                        
                        <!-- 记录总数显示 -->
                        <div id="overviewRecordCount" class="record-count" style="display: none; margin-top: 15px; padding: 8px 12px; background: #e8f4fd; border-radius: 6px; border-left: 4px solid #3498db; font-size: 14px; color: #333;">
                            共找到 <span id="overviewTotalCount">0</span> 条记录
                        </div>
                        
                        <!-- 数据表格 -->
                        <div id="overviewDataResults" style="margin-top: 20px;">
                            <div class="alert alert-info">请选择筛选条件并点击查找按钮</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 用户管理页面 -->
            <div id="page-user-management" class="page-content">
                <div class="content-header">
                    <div class="content-header-left">
                        <h2>用户管理</h2>
                        <p>管理系统用户账户和权限</p>
                    </div>
                    <div class="content-header-right">
                        <div class="user-info" id="userInfo4">
                            <div class="user-avatar" id="userAvatar4">A</div>
                            <div class="user-details">
                                <div class="user-name" id="userName4">加载中...</div>
                                <div class="user-role" id="userRole4">用户</div>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout()">退出登录</button>
                    </div>
                </div>
                <div class="content-body">
                    <!-- 操作按钮 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="showCreateUserModal()">
                                <span>+</span>
                                新增用户
                            </button>
                        </div>
                    </div>

                    <!-- 用户管理卡片 -->
                    <div class="card">
                        <div id="userManagementAlert" style="display: none; margin-bottom: 20px;"></div>
                        
                        <div class="loading" id="userManagementLoading" style="text-align: center; padding: 40px; color: #6c757d;">
                            <p>正在加载用户数据...</p>
                        </div>
                        
                        <div id="userTableContainer" style="display: none;">
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">UID</th>
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">真实姓名</th>
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">邮箱</th>
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">角色</th>
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">学校名称</th>
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">状态</th>
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">创建时间</th>
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">最后登录</th>
                                            <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #2c3e50; font-size: 12px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="userEmptyState" style="display: none; text-align: center; padding: 60px 30px; color: #6c757d;">
                            <h3 style="margin-bottom: 10px; color: #2c3e50; font-size: 16px;">暂无用户数据</h3>
                            <p style="font-size: 12px;">系统中还没有任何用户，点击上方按钮创建第一个用户。</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计分析页面已被完全移除 -->
        </main>

        <!-- 用户管理模态框 -->
        <div id="createUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; border-radius: 12px; max-width: 500px; margin: 10% auto; padding: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div style="padding: 20px 30px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #2c3e50; font-size: 18px;">新增用户</h3>
                    <span style="font-size: 20px; font-weight: bold; color: #999; cursor: pointer;" onclick="hideCreateUserModal()">&times;</span>
                </div>
                <div style="padding: 30px;">
                    <form id="createUserForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500; font-size: 12px;">UID *</label>
                            <input type="text" id="createUsername" name="username" style="width: 100%; padding: 12px 15px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 12px;" required>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500; font-size: 12px;">密码 *</label>
                            <input type="password" id="createPassword" name="password" style="width: 100%; padding: 12px 15px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 12px;" required>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500; font-size: 12px;">真实姓名</label>
                            <input type="text" id="createRealName" name="real_name" style="width: 100%; padding: 12px 15px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 12px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500; font-size: 12px;">邮箱</label>
                            <input type="email" id="createEmail" name="email" style="width: 100%; padding: 12px 15px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 12px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500; font-size: 12px;">角色 *</label>
                            <select id="createRole" name="role" style="width: 100%; padding: 12px 15px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 12px;" required onchange="toggleSchoolNameField()">
                                <option value="">请选择角色</option>
                                <option value="admin">管理员</option>
                                <option value="construction_center">基建中心</option>
                                <option value="school">学校用户</option>
                            </select>
                        </div>
                        <div id="schoolNameGroup" style="margin-bottom: 20px; display: none;">
                            <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 500; font-size: 12px;">学校名称 *</label>
                            <select id="createSchoolName" name="school_name" style="width: 100%; padding: 12px 15px; border: 1px solid #e9ecef; border-radius: 6px; font-size: 12px;">
                                <option value="">请选择学校</option>
                                <option value="上海大学">上海大学</option>
                                <option value="上海交通大学医学院">上海交通大学医学院</option>
                                <option value="上海理工大学">上海理工大学</option>
                                <option value="上海师范大学">上海师范大学</option>
                                <option value="上海科技大学">上海科技大学</option>
                                <option value="华东政法大学">华东政法大学</option>
                                <option value="上海海事大学">上海海事大学</option>
                                <option value="上海海洋大学">上海海洋大学</option>
                                <option value="上海中医药大学">上海中医药大学</option>
                                <option value="上海体育大学">上海体育大学</option>
                                <option value="上海音乐学院">上海音乐学院</option>
                                <option value="上海戏剧学院">上海戏剧学院</option>
                                <option value="上海电力大学">上海电力大学</option>
                                <option value="上海对外经贸大学">上海对外经贸大学</option>
                                <option value="上海应用技术大学">上海应用技术大学</option>
                                <option value="上海立信会计金融学院">上海立信会计金融学院</option>
                                <option value="上海工程技术大学">上海工程技术大学</option>
                                <option value="上海第二工业大学">上海第二工业大学</option>
                                <option value="上海商学院">上海商学院</option>
                                <option value="上海电机学院">上海电机学院</option>
                                <option value="上海政法学院">上海政法学院</option>
                                <option value="上海健康医学院">上海健康医学院</option>
                                <option value="上海出版印刷高等专科学校">上海出版印刷高等专科学校</option>
                                <option value="上海旅游高等专科学校">上海旅游高等专科学校</option>
                                <option value="上海城建职业学院">上海城建职业学院</option>
                                <option value="上海电子信息职业技术学院">上海电子信息职业技术学院</option>
                                <option value="上海工艺美术职业学院">上海工艺美术职业学院</option>
                                <option value="上海农林职业技术学院">上海农林职业技术学院</option>
                                <option value="上海健康医学院附属卫生学校(上海健康护理职业学院(筹))">上海健康医学院附属卫生学校(上海健康护理职业学院(筹))</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div style="padding: 20px 30px; border-top: 1px solid #e9ecef; text-align: right;">
                    <button type="button" style="padding: 10px 20px; border-radius: 6px; border: 1px solid #6c757d; background: #6c757d; color: white; cursor: pointer; margin-right: 10px; font-size: 12px;" onclick="hideCreateUserModal()">取消</button>
                    <button type="button" style="padding: 10px 20px; border-radius: 6px; border: none; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; cursor: pointer; font-size: 12px;" onclick="createUser()">创建用户</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入外部脚本 -->
    <script src="script.js"></script>
    
    <script>
        // 页面加载时检查用户登录状态
        document.addEventListener('DOMContentLoaded', async function() {
            await checkUserStatus();
        });

        // 检查用户登录状态
        async function checkUserStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const result = await response.json();
                
                if (result.success && result.isLoggedIn) {
                    updateUserInfo(result.user);
                } else {
                    // 如果未登录，重定向到登录页
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('检查用户状态失败:', error);
                // 网络错误时也重定向到登录页
                window.location.href = '/login.html';
            }
        }

        // 更新用户信息显示
        function updateUserInfo(user) {
            // 保存当前用户信息到全局变量
            currentUser = user;
            
            const userElements = [
                { avatar: 'userAvatar', name: 'userName', role: 'userRole' },
                { avatar: 'userAvatar2', name: 'userName2', role: 'userRole2' }
            ];

            userElements.forEach(elements => {
                const avatarEl = document.getElementById(elements.avatar);
                const nameEl = document.getElementById(elements.name);
                const roleEl = document.getElementById(elements.role);

                if (avatarEl) {
                    avatarEl.textContent = (user.real_name || user.username || 'U').charAt(0).toUpperCase();
                }
                if (nameEl) {
                    nameEl.textContent = user.real_name || user.username || '未知用户';
                }
                if (roleEl) {
                    let roleText = '用户';
                    if (user.role === 'admin') {
                        roleText = '管理员';
                    } else if (user.role === 'construction_center') {
                        roleText = '基建中心';
                    } else if (user.role === 'school') {
                        roleText = '学校用户';
                    }
                    roleEl.textContent = roleText;
                }
            });

            // 根据用户角色显示/隐藏用户管理菜单
            const userManagementMenu = document.getElementById('menu-user-management');
            if (userManagementMenu && user.role === 'admin') {
                userManagementMenu.style.display = 'block';
            }

            // 根据用户角色显示/隐藏统计分析菜单
            const statisticsMenu = document.getElementById('menu-statistics');
            if (statisticsMenu && (user.role === 'admin' || user.role === 'construction_center')) {
                statisticsMenu.style.display = 'block';
            }

            // 根据用户角色调整界面
            adjustInterfaceByRole(user);
            
            // 初始化年份数据（适用于有权限访问统计分析的用户）
            if (user.role === 'admin' || user.role === 'construction_center') {
                setTimeout(() => {
                    console.log('初始化年份数据...');
                    loadOverviewAvailableYears();
                }, 500);
            }
        }

        // 登出功能
        async function logout() {
            if (!confirm('确定要退出登录吗？')) {
                return;
            }

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // 清除本地状态
                    window.location.href = '/login.html';
                } else {
                    alert('退出登录失败: ' + result.message);
                }
            } catch (error) {
                console.error('退出登录失败:', error);
                alert('网络错误，请稍后重试');
            }
        }

        // 根据用户角色调整界面
        function adjustInterfaceByRole(user) {
            // 如果是学校用户，自动选择并锁定学校名称
            if (user.role === 'school' && user.school_name) {
                const schoolNameSelect = document.getElementById('schoolName');
                if (schoolNameSelect) {
                    schoolNameSelect.value = user.school_name;
                    // 不使用disabled，而是通过样式和事件阻止更改，保持表单提交时的值
                    schoolNameSelect.style.backgroundColor = '#f5f5f5';
                    schoolNameSelect.style.cursor = 'not-allowed';
                    schoolNameSelect.style.pointerEvents = 'none';
                    // 添加只读属性标记
                    schoolNameSelect.setAttribute('data-locked', 'true');
                    // 更新学校类型显示
                    updateSchoolType();
                }
            }
            
            // 根据角色隐藏某些菜单项
            if (user.role === 'school') {
                // 学校用户隐藏统计分析菜单
                const statsMenu = document.getElementById('menu-statistics');
                if (statsMenu) {
                    statsMenu.style.display = 'none';
                }
            }
            
            // 基建中心用户不能访问用户管理
            if (user.role === 'construction_center') {
                const userManagementMenu = document.getElementById('menu-user-management');
                if (userManagementMenu) {
                    userManagementMenu.style.display = 'none';
                }
            }
        }

        // 添加缺少的hideOnlineForm函数
        function hideOnlineForm() {
            // 此函数不需要实际功能，因为表单已经直接嵌入页面
            console.log('Form is embedded, no need to hide');
        }

        // 更新学校类型显示
        async function updateSchoolType() {
            const schoolNameSelect = document.getElementById('schoolName');
            const schoolTypeDisplay = document.getElementById('schoolTypeDisplay');
            
            if (!schoolNameSelect || !schoolTypeDisplay) {
                return;
            }
            
            const selectedSchool = schoolNameSelect.value;
            if (!selectedSchool) {
                schoolTypeDisplay.textContent = '';
                return;
            }
            
            try {
                const response = await fetch(`/api/school-type/${encodeURIComponent(selectedSchool)}`);
                const data = await response.json();
                
                if (data.success) {
                    schoolTypeDisplay.textContent = `院校类别: ${data.schoolType}`;
                } else {
                    schoolTypeDisplay.textContent = '院校类别: 未指定';
                }
            } catch (error) {
                console.error('获取学校类型失败:', error);
                schoolTypeDisplay.textContent = '院校类别: 获取失败';
            }
        }

        // 计算学生总数
        function calculateTotalStudents() {
            console.log('开始计算学生总数...');
            
            // 全日制学生
            const fullTimeSpecialistEl = document.getElementById('fullTimeSpecialist');
            const fullTimeUndergraduateEl = document.getElementById('fullTimeUndergraduate');
            const fullTimeMasterEl = document.getElementById('fullTimeMaster');
            const fullTimeDoctorEl = document.getElementById('fullTimeDoctor');
            
            const fullTimeSpecialist = parseInt(fullTimeSpecialistEl ? fullTimeSpecialistEl.value : 0) || 0;
            const fullTimeUndergraduate = parseInt(fullTimeUndergraduateEl ? fullTimeUndergraduateEl.value : 0) || 0;
            const fullTimeMaster = parseInt(fullTimeMasterEl ? fullTimeMasterEl.value : 0) || 0;
            const fullTimeDoctor = parseInt(fullTimeDoctorEl ? fullTimeDoctorEl.value : 0) || 0;
            
            const fullTimeTotal = fullTimeSpecialist + fullTimeUndergraduate + fullTimeMaster + fullTimeDoctor;
            
            // 留学生（不包括专科生）
            const internationalUndergraduateEl = document.getElementById('internationalUndergraduate');
            const internationalMasterEl = document.getElementById('internationalMaster');
            const internationalDoctorEl = document.getElementById('internationalDoctor');
            
            const internationalUndergraduate = parseInt(internationalUndergraduateEl ? internationalUndergraduateEl.value : 0) || 0;
            const internationalMaster = parseInt(internationalMasterEl ? internationalMasterEl.value : 0) || 0;
            const internationalDoctor = parseInt(internationalDoctorEl ? internationalDoctorEl.value : 0) || 0;
            
            const internationalTotal = internationalUndergraduate + internationalMaster + internationalDoctor;
            
            // 更新显示
            const fullTimeTotalEl = document.getElementById('fullTimeTotal');
            if (fullTimeTotalEl) {
                fullTimeTotalEl.value = fullTimeTotal;
                console.log('设置全日制总数:', fullTimeTotal);
            }
            
            const internationalTotalEl = document.getElementById('internationalTotal');
            if (internationalTotalEl) {
                internationalTotalEl.value = internationalTotal;
                console.log('设置留学生总数:', internationalTotal);
            }
            
            // 计算总学生数
            const totalStudents = fullTimeTotal + internationalTotal;
            const totalStudentsEl = document.getElementById('totalStudents');
            if (totalStudentsEl) {
                totalStudentsEl.value = totalStudents;
                console.log('设置学生总人数:', totalStudents);
            }
            
            console.log('计算完成:', { fullTimeTotal, internationalTotal, totalStudents });
            
            return {
                fullTimeTotal,
                internationalTotal,
                totalStudents
            };
        }

        // 页面切换函数
        function showPage(pageId) {
            // 隐藏所有页面
            const allPages = document.querySelectorAll('.page-content');
            allPages.forEach(page => page.classList.remove('active'));
            
            // 移除所有菜单项的活动状态
            const allMenuItems = document.querySelectorAll('.menu-item, .submenu-item');
            allMenuItems.forEach(item => item.classList.remove('active'));
            
            // 显示选中的页面
            const targetPage = document.getElementById(`page-${pageId}`);
            const targetMenu = document.getElementById(`menu-${pageId}`);
            
            if (targetPage) targetPage.classList.add('active');
            if (targetMenu) targetMenu.classList.add('active');
            
            // 根据页面类型加载相应内容
            if (pageId === 'data-management') {
                setTimeout(() => loadDataManagementContent(), 300);
            } else if (pageId === 'statistics') {
                // 加载统计分析内容
                setTimeout(() => {
                    loadOverviewAvailableYears();
                    searchOverviewRecords();
                    // 更新用户信息
                    if (currentUser) {
                        updateStatisticsUserInfo(currentUser);
                    }
                }, 300);
            } else if (pageId === 'user-management') {
                // 加载用户管理内容
                setTimeout(() => {
                    loadUserManagementContent();
                    // 更新用户信息
                    if (currentUser) {
                        updateUserManagementUserInfo(currentUser);
                    }
                }, 300);
            }
            
            // 移动端自动关闭菜单
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        }

        // 移动端菜单切换
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('open');
        }

        // 更新统计分析页面的用户信息
        function updateStatisticsUserInfo(user) {
            const avatarEl = document.getElementById('userAvatar3');
            const nameEl = document.getElementById('userName3');
            const roleEl = document.getElementById('userRole3');
            
            if (avatarEl && nameEl && roleEl) {
                avatarEl.textContent = user.real_name ? user.real_name.charAt(0).toUpperCase() : user.username.charAt(0).toUpperCase();
                nameEl.textContent = user.real_name || user.username;
                
                let roleText = '用户';
                if (user.role === 'admin') roleText = '管理员';
                else if (user.role === 'construction_center') roleText = '基建中心';
                else if (user.role === 'school') roleText = '学校用户';
                
                roleEl.textContent = roleText;
            }
        }

        // ========== 填报概览页面功能 ==========
        
        // 搜索填报概览记录
        async function searchOverviewRecords() {
            const yearFilter = document.getElementById('overviewYearFilter');
            const userTypeFilter = document.getElementById('overviewUserTypeFilter');
            const year = yearFilter ? yearFilter.value : '2025';
            const userType = userTypeFilter ? userTypeFilter.value : 'construction_center';
            
            console.log('开始搜索填报概览记录，筛选条件:', { year, userType });
            
            const resultsContainer = document.getElementById('overviewDataResults');
            const recordCount = document.getElementById('overviewRecordCount');
            
            resultsContainer.innerHTML = '<div class="loading">正在搜索...</div>';
            
            // 隐藏记录计数
            if (recordCount) recordCount.style.display = 'none';
            
            try {
                // 构建查询参数
                let queryParams = [];
                if (year !== 'all') queryParams.push(`year=${encodeURIComponent(year)}`);
                if (userType !== 'all') queryParams.push(`userType=${encodeURIComponent(userType)}`);
                
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                const response = await fetch(`/api/overview/records${queryString}`);
                const result = await response.json();
                
                if (result.success) {
                    displayOverviewResults(result.data);
                    updateOverviewSummary(result.data);
                    
                    // 显示记录计数
                    if (recordCount) {
                        const totalCount = document.getElementById('overviewTotalCount');
                        if (totalCount) totalCount.textContent = result.data.length;
                        recordCount.style.display = 'block';
                    }
                } else {
                    console.error('搜索失败:', result.error);
                    resultsContainer.innerHTML = `<div class="alert alert-danger">搜索失败: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('搜索填报概览记录失败:', error);
                resultsContainer.innerHTML = '<div class="alert alert-danger">网络错误，请稍后重试</div>';
            }
        }
        
        // 显示填报概览搜索结果
        function displayOverviewResults(data) {
            const resultsContainer = document.getElementById('overviewDataResults');
            
            if (data.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-info">未找到符合条件的记录</div>';
                return;
            }
            
            // 复用数据管理的表格结构，但去掉操作列和右侧空间
            let html = '<div class="table-container">';
            html += '<div class="data-table-wrapper">';
            
            // 左侧冻结列
            html += '<div class="frozen-left-columns">';
            html += '<table class="data-table-frozen-left"><thead><tr>';
            html += '<th>测算年份</th>';
            html += '<th>学校名称</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(record => {
                html += `<tr>
                    <td><strong>${record.year || '未知'}</strong></td>
                    <td><strong>${record.school_name || '未知'}</strong></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // 中间滚动数据列（去掉右侧margin，占满剩余空间）
            html += '<div class="scrollable-middle-columns" style="margin-left: 240px; margin-right: 0; overflow-x: auto; overflow-y: hidden;">';
            html += '<table class="data-table-scrollable"><thead><tr>';
            html += '<th>现状建筑总面积(m²)</th>';
            html += '<th>学生规模测算建筑总面积(m²)</th>';
            html += '<th>学生规模测算建筑面积总缺额(不含补助)(m²)</th>';
            html += '<th>补助建筑总面积(m²)</th>';
            html += '<th>学生规模测算建筑面积总缺额(含补助)(m²)</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(record => {
                // 直接使用API返回的正确值
                const gapWithoutSubsidy = record.gap_without_subsidy || 0;
                const gapWithSubsidy = record.gap_with_subsidy || 0;
                
                html += `<tr>
                    <td>${formatNumber(record.current_total_area || 0)}</td>
                    <td>${formatNumber(record.required_total_area || 0)}</td>
                    <td>${gapWithoutSubsidy > 0 ? '+' : ''}${formatNumber(gapWithoutSubsidy)}</td>
                    <td>${formatNumber(record.total_subsidy_area || 0)}</td>
                    <td>${gapWithSubsidy > 0 ? '+' : ''}${formatNumber(gapWithSubsidy)}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // 不需要右侧操作列，直接结束
            html += '</div>'; // data-table-wrapper
            html += '</div>'; // table-container
            
            html += `<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #3498db;">
                <p style="margin: 0; color: #6c757d; font-size: 14px;">
                    <strong>共找到 ${data.length} 条记录</strong>
                </p>
            </div>`;
            
            resultsContainer.innerHTML = html;
            
            // 更新汇总数据
            updateOverviewSummary(data);
            
            // 同步表格行高度和滚动
            setTimeout(() => {
                syncOverviewTableRows();
                syncOverviewTableScroll();
            }, 0);
        }
        
        // 同步填报概览表格行高度
        function syncOverviewTableRows() {
            const leftRows = document.querySelectorAll('.data-table-frozen-left tbody tr');
            const middleRows = document.querySelectorAll('.data-table-scrollable tbody tr');
            
            if (leftRows.length === middleRows.length) {
                for (let i = 0; i < leftRows.length; i++) {
                    const maxHeight = Math.max(
                        leftRows[i].offsetHeight,
                        middleRows[i].offsetHeight
                    );
                    
                    leftRows[i].style.height = maxHeight + 'px';
                    middleRows[i].style.height = maxHeight + 'px';
                }
            }
        }

        // 同步填报概览表格垂直滚动
        function syncOverviewTableScroll() {
            const leftTable = document.querySelector('.frozen-left-columns');
            const middleTable = document.querySelector('.scrollable-middle-columns');
            
            if (!leftTable || !middleTable) return;
            
            let isScrolling = false;
            
            function syncScroll(source, targets) {
                if (isScrolling) return;
                isScrolling = true;
                
                targets.forEach(target => {
                    target.scrollTop = source.scrollTop;
                });
                
                setTimeout(() => {
                    isScrolling = false;
                }, 10);
            }
            
            leftTable.addEventListener('scroll', () => {
                syncScroll(leftTable, [middleTable]);
            });
            
            middleTable.addEventListener('scroll', () => {
                syncScroll(middleTable, [leftTable]);
            });
        }
        
        // 更新填报概览汇总数据
        function updateOverviewSummary(data) {
            const currentAreaEl = document.getElementById('overviewCurrentArea');
            const requiredAreaEl = document.getElementById('overviewRequiredArea');
            const gapWithoutSubsidyEl = document.getElementById('overviewGapWithoutSubsidy');
            const gapWithSubsidyEl = document.getElementById('overviewGapWithSubsidy');
            
            let totalCurrent = 0;
            let totalRequired = 0;
            let totalGapWithoutSubsidy = 0;
            let totalGapWithSubsidy = 0;
            
            data.forEach(record => {
                totalCurrent += parseFloat(record.current_total_area) || 0;
                totalRequired += parseFloat(record.required_total_area) || 0;
                totalGapWithoutSubsidy += parseFloat(record.gap_without_subsidy) || 0;
                totalGapWithSubsidy += parseFloat(record.gap_with_subsidy) || 0;
            });
            
            if (currentAreaEl) currentAreaEl.textContent = formatNumber(totalCurrent);
            if (requiredAreaEl) requiredAreaEl.textContent = formatNumber(totalRequired);
            if (gapWithoutSubsidyEl) gapWithoutSubsidyEl.textContent = (totalGapWithoutSubsidy > 0 ? '+' : '') + formatNumber(totalGapWithoutSubsidy);
            if (gapWithSubsidyEl) gapWithSubsidyEl.textContent = (totalGapWithSubsidy > 0 ? '+' : '') + formatNumber(totalGapWithSubsidy);
        }
        
        // 加载填报概览可用年份
        async function loadOverviewAvailableYears() {
            console.log('开始加载年份数据...');
            try {
                const response = await fetch('/api/years');
                const result = await response.json();
                console.log('API响应:', result);
                
                if (result.success && result.years) {
                    const yearFilter = document.getElementById('overviewYearFilter');
                    console.log('年份筛选器元素:', yearFilter);
                    if (yearFilter) {
                        console.log('清空前的选项:', yearFilter.innerHTML);
                        
                        // 清空现有选项
                        yearFilter.innerHTML = '';
                        
                        // 添加年份选项，按降序排列
                        const sortedYears = result.years.sort((a, b) => b - a);
                        console.log('排序后的年份:', sortedYears);
                        
                        sortedYears.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = `${year}年`;
                            yearFilter.appendChild(option);
                            console.log(`添加年份选项: ${year}年`);
                        });
                        
                        console.log('添加后的选项:', yearFilter.innerHTML);
                        
                        // 默认选择最新年份
                        if (sortedYears.length > 0) {
                            yearFilter.value = sortedYears[0];
                            console.log(`设置默认选择年份: ${sortedYears[0]}`);
                            console.log('当前选择的值:', yearFilter.value);
                        }
                    } else {
                        console.error('找不到年份筛选器元素');
                    }
                } else {
                    console.error('API响应格式错误:', result);
                }
            } catch (error) {
                console.error('加载年份失败:', error);
            }
        }

        // 格式化数字显示
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0.00';
            return parseFloat(num).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // 格式化日期时间显示
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // 加载统计分析内容 - 已注释
        /*
        async function loadStatisticsContent() {
            await loadAvailableYears();
            // 默认加载当前测算年份的统计数据
            const currentYear = new Date().getFullYear();
            await loadStatistics(currentYear.toString());
        }
        */

        // 加载统计数据 - 已注释
        /*
        async function loadStatistics(year = null) {
            try {
                const yearFilter = document.getElementById('statsYearFilter');
                const selectedYear = year || (yearFilter ? yearFilter.value : 'all');
                
                const url = selectedYear === 'all' ? '/api/statistics' : `/api/statistics?year=${selectedYear}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayStatistics(result.data);
                    updateStatisticsTable(selectedYear);
                } else {
                    console.error('获取统计数据失败:', result.error);
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }
        */

        // 显示统计数据 - 已注释
        /*
        function displayStatistics(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            if (statsGrid) {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h4>学校总数</h4>
                        <div class="stat-value">${stats.total_schools || 0}</div>
                        <div class="stat-unit">所学校</div>
                    </div>
                    <div class="stat-card">
                        <h4>学生总数</h4>
                        <div class="stat-value">${stats.total_students_sum ? Math.round(stats.total_students_sum).toLocaleString() : 0}</div>
                        <div class="stat-unit">名学生</div>
                    </div>
                    <div class="stat-card">
                        <h4>平均学生数</h4>
                        <div class="stat-value">${stats.avg_students ? Math.round(stats.avg_students).toLocaleString() : 0}</div>
                        <div class="stat-unit">人/校</div>
                    </div>
                    <div class="stat-card">
                        <h4>总教学面积</h4>
                        <div class="stat-value">${stats.total_teaching_area_sum ? Math.round(stats.total_teaching_area_sum).toLocaleString() : 0}</div>
                        <div class="stat-unit">平方米</div>
                    </div>
                `;
            }
        }
        */

        // 更新统计表格 - 已注释
        /*
        async function updateStatisticsTable(year) {
            try {
                const url = year === 'all' ? '/api/schools/latest' : `/api/schools/latest?year=${year}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    const content = document.getElementById('statisticsContent');
                    if (result.data.length === 0) {
                        content.innerHTML = '<div class="alert alert-info">暂无数据记录</div>';
                    } else {
                        let tableHtml = '<div class="table-container"><table class="data-table"><thead><tr>';
                        tableHtml += '<th>学校名称</th><th>院校类别</th><th>测算年份</th><th>学生统计年份</th><th>建筑面积统计年份</th><th>学生总数</th><th>教学面积</th><th>最后更新</th>';
                        tableHtml += '</tr></thead><tbody>';
                        
                        result.data.forEach(school => {
                            const updateDate = new Date(school.created_at).toLocaleDateString('zh-CN');
                            tableHtml += `<tr>
                                <td><strong>${school.school_name || '未知'}</strong></td>
                                <td>${school.school_type || '未指定'}</td>
                                <td>${school.year || '未知'}</td>
                                <td>${school.student_stat_year || school.year || '未知'}</td>
                                <td>${school.building_stat_year || school.year || '未知'}</td>
                                <td>${(school.total_students || 0).toLocaleString()}人</td>
                                <td>${(school.teaching_area || 0).toLocaleString()}㎡</td>
                                <td>${updateDate}</td>
                            </tr>`;
                        });
                        
                        tableHtml += '</tbody></table></div>';
                        content.innerHTML = tableHtml;
                    }
                }
            } catch (error) {
                console.error('更新统计表格失败:', error);
                const content = document.getElementById('statisticsContent');
                content.innerHTML = '<div class="alert alert-danger">加载数据失败</div>';
            }
        }
        */

        // 加载可用年份 - 统计分析专用，已注释
        /*
        async function loadAvailableYears() {
            try {
                const response = await fetch('/api/years');
                const result = await response.json();
                
                if (result.success) {
                    const yearSelect = document.getElementById('statsYearFilter');
                    if (yearSelect) {
                        const currentYear = new Date().getFullYear();
                        yearSelect.innerHTML = '<option value="all">所有测算年份</option>';
                        
                        result.data.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year + '年';
                            // 默认选中当前测算年份
                            if (year === currentYear) {
                                option.selected = true;
                            }
                            yearSelect.appendChild(option);
                        });
                        
                        // 添加年份变化事件
                        yearSelect.onchange = function() {
                            loadStatistics(this.value);
                        };
                    }
                }
            } catch (error) {
                console.error('加载年份失败:', error);
            }
        }
        */

        // 检查数据库连接状态 - 统计分析专用，已注释
        /*
        async function checkDatabaseStatus() {
            try {
                const response = await fetch('/api/statistics');
                const dbStatusEl = document.getElementById('dbStatus');
                if (dbStatusEl) {
                    if (response.ok) {
                        dbStatusEl.textContent = '数据库已连接';
                        dbStatusEl.className = 'btn btn-success';
                    } else {
                        dbStatusEl.textContent = '数据库连接异常';
                        dbStatusEl.className = 'btn btn-danger';
                    }
                }
            } catch (error) {
                const dbStatusEl = document.getElementById('dbStatus');
                if (dbStatusEl) {
                    dbStatusEl.textContent = '数据库离线';
                    dbStatusEl.className = 'btn btn-danger';
                }
            }
        }
        */

        // ========== 数据管理页面功能 ==========
        let allDataSchoolsData = []; // 存储所有学校数据
        let currentUser = null; // 存储当前用户信息

        // 加载数据管理页面内容
        async function loadDataManagementContent() {
            // 初始化时隐藏汇总栏
            const summarySection = document.getElementById('dataSummarySection');
            if (summarySection) {
                summarySection.style.display = 'none';
            }
            
            await loadDataAvailableYears();
            await loadDataAvailableUsers();
            
            // 如果是学校用户，自动锁定学校筛选器和用户筛选器
            if (currentUser && currentUser.role === 'school') {
                // 锁定学校筛选器
                const schoolFilter = document.getElementById('dataSchoolNameFilter');
                if (schoolFilter && currentUser.school_name) {
                    // 检查是否存在对应的学校选项
                    let schoolOptionExists = false;
                    for (let i = 0; i < schoolFilter.options.length; i++) {
                        if (schoolFilter.options[i].value === currentUser.school_name) {
                            schoolOptionExists = true;
                            break;
                        }
                    }
                    
                    // 如果不存在，添加学校选项
                    if (!schoolOptionExists) {
                        const option = document.createElement('option');
                        option.value = currentUser.school_name;
                        option.textContent = currentUser.school_name;
                        schoolFilter.appendChild(option);
                    }
                    
                    // 设置选中当前学校
                    schoolFilter.value = currentUser.school_name;
                    // 禁用筛选器，防止学校用户修改
                    schoolFilter.disabled = true;
                    // 添加样式提示这是被锁定的
                    schoolFilter.style.backgroundColor = '#f5f5f5';
                    schoolFilter.style.cursor = 'not-allowed';
                }
                
                // 锁定用户筛选器
                const userFilter = document.getElementById('dataUserFilter');
                if (userFilter) {
                    // 设置选中当前用户（使用真实姓名）
                    userFilter.value = currentUser.real_name || currentUser.username;
                    // 禁用筛选器，防止学校用户修改
                    userFilter.disabled = true;
                    // 添加样式提示这是被锁定的
                    userFilter.style.backgroundColor = '#f5f5f5';
                    userFilter.style.cursor = 'not-allowed';
                }
            }
            
            // 自动搜索加载所有数据
            setTimeout(() => {
                searchDataRecords();
            }, 100);
        }

        // 搜索数据记录
        async function searchDataRecords() {
            const yearFilter = document.getElementById('dataYearFilter');
            const schoolFilter = document.getElementById('dataSchoolNameFilter');
            const userFilter = document.getElementById('dataUserFilter');
            const year = yearFilter ? yearFilter.value : 'all';
            const school = schoolFilter ? schoolFilter.value : 'all';
            const user = userFilter ? userFilter.value : 'all';
            
            console.log('开始搜索数据记录，筛选条件:', { year, school, user });
            
            const resultsContainer = document.getElementById('dataHistoryResults');
            const batchDownloadBtn = document.getElementById('batchDownloadBtn');
            resultsContainer.innerHTML = '<div class="loading">正在搜索...</div>';
            
            // 搜索时隐藏汇总栏
            const summarySection = document.getElementById('dataSummarySection');
            if (summarySection) {
                summarySection.style.display = 'none';
            }
            
            // 禁用批量下载按钮
            if (batchDownloadBtn) {
                batchDownloadBtn.disabled = true;
            }
            
            try {
                let url = '/api/schools/latest';
                const params = [];
                
                if (year !== 'all') {
                    params.push(`year=${year}`);
                }
                
                if (school !== 'all') {
                    params.push(`school=${encodeURIComponent(school)}`);
                }
                
                if (user !== 'all') {
                    params.push(`user=${encodeURIComponent(user)}`);
                }
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                console.log('请求URL:', url);
                
                const response = await fetch(url, {
                    cache: 'no-cache',  // 禁用缓存
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();
                
                console.log('搜索API响应:', result);
                
                if (result.success) {
                    allDataSchoolsData = result.data;
                    console.log('搜索成功，加载了', result.data.length, '条记录');
                    console.log('记录ID列表:', result.data.map(r => r.id));
                    displayDataSchoolsResults(result.data);
                    
                    // 如果有搜索结果，启用批量下载按钮
                    if (batchDownloadBtn && result.data.length > 0) {
                        batchDownloadBtn.disabled = false;
                    }
                } else {
                    console.error('搜索失败:', result.error);
                    showDataError('搜索失败: ' + result.error);
                }
            } catch (error) {
                console.error('搜索失败:', error);
                showDataError('搜索失败: ' + error.message);
            }
        }

        // 加载可用年份
        async function loadDataAvailableYears() {
            try {
                const response = await fetch('/api/years');
                const result = await response.json();
                
                if (result.success) {
                    const yearSelect = document.getElementById('dataYearFilter');
                    if (yearSelect) {
                        yearSelect.innerHTML = '<option value="all">所有测算年份</option>';
                        
                        result.data.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year + '年';
                            yearSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('加载年份失败:', error);
            }
        }

        // 加载可用的测算用户
        async function loadDataAvailableUsers() {
            try {
                const response = await fetch('/api/users');
                const result = await response.json();
                
                if (result.success) {
                    const userSelect = document.getElementById('dataUserFilter');
                    if (userSelect) {
                        userSelect.innerHTML = '<option value="all">所有测算用户</option>';
                        
                        result.data.forEach(user => {
                            const option = document.createElement('option');
                            // 使用真实姓名作为value进行筛选
                            option.value = user.real_name || user.username || user;
                            // 只显示真实姓名，不显示用户名
                            option.textContent = user.real_name || user.username || user;
                            userSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('加载测算用户失败:', error);
            }
        }

        // 加载学校数据（保留但不自动调用）
        async function loadDataSchoolsData() {
            // 该函数已被 searchDataRecords 替代
            console.log('使用 searchDataRecords 函数进行搜索');
        }

        // 按学校名称筛选（已不再使用）
        function filterDataSchools() {
            // 该函数已被移除，使用下拉选择器替代
            console.log('使用下拉选择器进行筛选');
        }

        // 清空筛选
        function clearDataFilter() {
            document.getElementById('dataYearFilter').value = 'all';
            document.getElementById('dataSchoolNameFilter').value = 'all';
            document.getElementById('dataUserFilter').value = 'all';
            
            // 清空结果显示
            const resultsContainer = document.getElementById('dataHistoryResults');
            resultsContainer.innerHTML = '<div class="alert alert-info">请选择筛选条件并点击查找按钮</div>';
            
            // 清空数据
            allDataSchoolsData = [];
            
            // 禁用批量下载按钮
            const batchDownloadBtn = document.getElementById('batchDownloadBtn');
            if (batchDownloadBtn) {
                batchDownloadBtn.disabled = true;
            }
        }

        // 批量下载搜索结果
        async function batchDownloadSearchResults() {
            const yearFilter = document.getElementById('dataYearFilter');
            const schoolFilter = document.getElementById('dataSchoolNameFilter');
            const userFilter = document.getElementById('dataUserFilter');
            const batchDownloadBtn = document.getElementById('batchDownloadBtn');
            
            const year = yearFilter ? yearFilter.value : 'all';
            const school = schoolFilter ? schoolFilter.value : 'all';
            const user = userFilter ? userFilter.value : 'all';
            
            if (!allDataSchoolsData || allDataSchoolsData.length === 0) {
                showMessage('没有可下载的数据，请先进行搜索', 'error');
                return;
            }
            
            try {
                // 显示加载状态
                const originalText = batchDownloadBtn.textContent;
                batchDownloadBtn.disabled = true;
                batchDownloadBtn.textContent = '下载中...';
                
                // 构建请求参数
                const requestBody = {
                    exportType: 'filtered'
                };
                
                if (year !== 'all') {
                    requestBody.year = year;
                }
                if (school !== 'all') {
                    requestBody.school = school;
                }
                if (user !== 'all') {
                    requestBody.user = user;
                }
                
                console.log('批量下载请求参数:', requestBody);
                
                // 发送批量导出请求
                const response = await fetch('/api/batch-export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '批量下载失败');
                }
                
                // 成功后自动下载文件
                if (result.success) {
                    // 直接触发下载
                    window.location.href = result.downloadUrl;
                    
                    // 显示成功消息
                    showMessage(`批量下载成功！共下载 ${result.recordCount} 条记录`, 'info');
                } else {
                    throw new Error(result.error || '批量下载失败');
                }
                
            } catch (error) {
                console.error('批量下载失败:', error);
                showMessage('批量下载失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                batchDownloadBtn.disabled = false;
                batchDownloadBtn.textContent = '批量下载';
            }
        }

        // 显示消息提示
        function showMessage(message, type = 'info') {
            // 创建消息提示元素
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                z-index: 9999;
                font-weight: 500;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: opacity 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // 根据类型设置颜色
            switch (type) {
                case 'success':
                    messageDiv.style.background = '#28a745';
                    break;
                case 'error':
                    messageDiv.style.background = '#dc3545';
                    break;
                case 'warning':
                    messageDiv.style.background = '#ffc107';
                    messageDiv.style.color = '#212529';
                    break;
                default:
                    messageDiv.style.background = '#17a2b8';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3秒后自动消失
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        // 显示数据错误
        function showDataError(message) {
            const container = document.getElementById('dataHistoryResults');
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
            
            // 隐藏汇总栏
            const summarySection = document.getElementById('dataSummarySection');
            if (summarySection) {
                summarySection.style.display = 'none';
            }
        }

        // 更新数据汇总
        function updateDataSummary(schoolsData) {
            if (!schoolsData || schoolsData.length === 0) {
                // 隐藏汇总栏
                const summarySection = document.getElementById('dataSummarySection');
                if (summarySection) {
                    summarySection.style.display = 'none';
                }
                return;
            }
            
            // 计算汇总数据
            let totalSchools = schoolsData.length;
            let totalCurrentArea = 0;
            let totalRequiredArea = 0;
            let totalGapWithoutSubsidy = 0;
            let totalGapWithSubsidy = 0;
            
            schoolsData.forEach(school => {
                // 解析数字，确保是有效的数值
                const currentArea = parseFloat(school.current_building_area) || 0;
                const requiredArea = parseFloat(school.required_building_area) || 0;
                const gapWithSubsidy = parseFloat(school.total_area_gap_with_subsidy) || 0;
                const subsidyTotal = parseFloat(school.special_subsidy_total) || 0;
                const gapWithoutSubsidy = school.total_area_gap_without_subsidy ? parseFloat(school.total_area_gap_without_subsidy) : (gapWithSubsidy - subsidyTotal);
                
                totalCurrentArea += currentArea;
                totalRequiredArea += requiredArea;
                totalGapWithoutSubsidy += gapWithoutSubsidy;
                totalGapWithSubsidy += gapWithSubsidy;
            });
            
            // 格式化数字为两位小数
            const formatNumber = (num) => {
                return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };
            
            // 更新显示
            const summarySection = document.getElementById('dataSummarySection');
            if (summarySection) {
                summarySection.style.display = 'block';
                
                const schoolCountEl = document.getElementById('summarySchoolCount');
                const currentAreaEl = document.getElementById('summaryCurrentArea');
                const requiredAreaEl = document.getElementById('summaryRequiredArea');
                const gapWithoutSubsidyEl = document.getElementById('summaryGapWithoutSubsidy');
                const gapWithSubsidyEl = document.getElementById('summaryGapWithSubsidy');
                
                if (schoolCountEl) schoolCountEl.textContent = totalSchools;
                if (currentAreaEl) currentAreaEl.textContent = formatNumber(totalCurrentArea);
                if (requiredAreaEl) requiredAreaEl.textContent = formatNumber(totalRequiredArea);
                if (gapWithoutSubsidyEl) {
                    gapWithoutSubsidyEl.textContent = formatNumber(totalGapWithoutSubsidy);
                }
                if (gapWithSubsidyEl) {
                    gapWithSubsidyEl.textContent = formatNumber(totalGapWithSubsidy);
                }
            }
        }

        // 显示学校数据结果
        function displayDataSchoolsResults(schoolsData) {
            const container = document.getElementById('dataHistoryResults');
            
            if (!schoolsData || schoolsData.length === 0) {
                container.innerHTML = '<div class="alert alert-info">没有找到相关数据</div>';
                // 隐藏汇总栏
                const summarySection = document.getElementById('dataSummarySection');
                if (summarySection) {
                    summarySection.style.display = 'none';
                }
                return;
            }
            
            // 计算并显示汇总信息
            updateDataSummary(schoolsData);
            
            let html = '<div class="table-container">';
            html += '<div class="data-table-wrapper">';
            
            // 左侧冻结列
            html += '<div class="frozen-left-columns">';
            html += '<table class="data-table-frozen-left"><thead><tr>';
            html += '<th>测算年份</th>';
            html += '<th>学校名称</th>';
            html += '</tr></thead><tbody>';
            
            schoolsData.forEach(school => {
                html += `<tr>
                    <td><strong>${school.year || '未知'}</strong></td>
                    <td><strong>${school.school_name || '未知'}</strong></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // 中间滚动数据列
            html += '<div class="scrollable-middle-columns">';
            html += '<table class="data-table-scrollable"><thead><tr>';
            html += '<th>现状建筑总面积(m²)</th>';
            html += '<th>学生规模测算建筑总面积(m²)</th>';
            html += '<th>学生规模测算建筑面积总缺额(不含补助)(m²)</th>';
            html += '<th>补助建筑总面积(m²)</th>';
            html += '<th>学生规模测算建筑面积总缺额(含补助)(m²)</th>';
            html += '<th>测算时间</th>';
            html += '<th>测算用户</th>';
            html += '</tr></thead><tbody>';
            
            schoolsData.forEach(school => {
                const date = new Date(school.created_at).toLocaleDateString('zh-CN');
                const time = new Date(school.created_at).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
                
                // 计算不含补助的缺口
                const gapWithoutSubsidy = school.total_area_gap_without_subsidy ? parseFloat(school.total_area_gap_without_subsidy) : ((school.total_area_gap_with_subsidy || 0) - (school.special_subsidy_total || 0));
                
                html += `<tr>
                    <td>${school.current_building_area || '0.00'}</td>
                    <td>${school.required_building_area || '0.00'}</td>
                    <td>${gapWithoutSubsidy.toFixed ? gapWithoutSubsidy.toFixed(2) : '0.00'}</td>
                    <td>${school.special_subsidy_total || '0.00'}</td>
                    <td>${school.total_area_gap_with_subsidy || '0.00'}</td>
                    <td>${date} ${time}</td>
                    <td>${school.submitter_real_name || school.submitter_username || '未知用户'}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // 右侧冻结操作列
            html += '<div class="frozen-right-columns">';
            html += '<table class="data-table-frozen-right"><thead><tr>';
            html += '<th>操作</th>';
            html += '</tr></thead><tbody>';
            
            schoolsData.forEach(school => {
                html += `<tr>
                    <td>
                        <button style="background: none; color: #3498db; border: none; padding: 4px 8px; cursor: pointer; margin-right: 8px; font-size: 12px; text-decoration: underline;" onclick="viewDataSchoolDetails(${school.id})" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">详情</button>
                        <button style="background: none; color: #3498db; border: none; padding: 4px 8px; cursor: pointer; margin-right: 8px; font-size: 12px; text-decoration: underline;" onclick="downloadRecord(${school.id})" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">下载</button>
                        <button style="background: none; color: #f39c12; border: none; padding: 4px 8px; cursor: pointer; margin-right: 8px; font-size: 12px; text-decoration: underline;" onclick="editDataRecord(${school.id})" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">编辑</button>
                        <button style="background: none; color: #e74c3c; border: none; padding: 4px 8px; cursor: pointer; font-size: 12px; text-decoration: underline;" onclick="deleteSchoolCombination('${school.school_name}', ${school.year}, '${school.submitter_username || '未知用户'}')" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">删除</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            html += '</div>'; // data-table-wrapper
            html += '</div>'; // table-container
            
            html += `<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #3498db;">
                <p style="margin: 0; color: #6c757d; font-size: 14px;">
                    <strong>共找到 ${schoolsData.length} 条记录</strong> | 
                    可以使用上方的"批量下载"按钮下载所有搜索结果
                </p>
            </div>`;
            container.innerHTML = html;
            
            // 同步表格行高度和滚动
            setTimeout(() => {
                syncTableRows();
                syncTableScroll();
            }, 0);
        }

        // 同步表格行高度
        function syncTableRows() {
            const leftRows = document.querySelectorAll('.data-table-frozen-left tbody tr');
            const middleRows = document.querySelectorAll('.data-table-scrollable tbody tr');
            const rightRows = document.querySelectorAll('.data-table-frozen-right tbody tr');
            
            if (leftRows.length === middleRows.length && middleRows.length === rightRows.length) {
                for (let i = 0; i < leftRows.length; i++) {
                    const maxHeight = Math.max(
                        leftRows[i].offsetHeight,
                        middleRows[i].offsetHeight,
                        rightRows[i].offsetHeight
                    );
                    
                    leftRows[i].style.height = maxHeight + 'px';
                    middleRows[i].style.height = maxHeight + 'px';
                    rightRows[i].style.height = maxHeight + 'px';
                }
            }
        }

        // 同步表格垂直滚动
        function syncTableScroll() {
            const leftTable = document.querySelector('.frozen-left-columns');
            const middleTable = document.querySelector('.scrollable-middle-columns');
            const rightTable = document.querySelector('.frozen-right-columns');
            
            if (!leftTable || !middleTable || !rightTable) return;
            
            let isScrolling = false;
            
            function syncScroll(source, targets) {
                if (isScrolling) return;
                isScrolling = true;
                
                targets.forEach(target => {
                    target.scrollTop = source.scrollTop;
                });
                
                setTimeout(() => {
                    isScrolling = false;
                }, 10);
            }
            
            leftTable.addEventListener('scroll', () => {
                syncScroll(leftTable, [middleTable, rightTable]);
            });
            
            middleTable.addEventListener('scroll', () => {
                syncScroll(middleTable, [leftTable, rightTable]);
            });
            
            rightTable.addEventListener('scroll', () => {
                syncScroll(rightTable, [leftTable, middleTable]);
            });
        }

        // 显示最近分析记录
        function loadDataRecentAnalysis(recentData) {
            // 已移除最近分析记录功能
        }

        // 查看学校详情
        function viewDataSchoolDetails(schoolId) {
            const school = allDataSchoolsData.find(s => s.id === schoolId);
            if (!school) {
                alert('找不到学校详情');
                return;
            }
            
            // 解析计算结果JSON
            let calculationResults = {};
            if (school.calculation_results) {
                try {
                    calculationResults = JSON.parse(school.calculation_results);
                } catch (e) {
                    console.error('解析计算结果失败:', e);
                }
            }
            
            // 解析特殊补助数据
            let specialSubsidies = [];
            if (school.special_subsidies) {
                try {
                    specialSubsidies = JSON.parse(school.special_subsidies);
                } catch (e) {
                    console.error('解析特殊补助数据失败:', e);
                }
            }
            
            // 计算不含补助的缺口
            const gapWithoutSubsidy = school.total_area_gap_without_subsidy ? parseFloat(school.total_area_gap_without_subsidy) : ((school.total_area_gap_with_subsidy || 0) - (school.special_subsidy_total || 0));
            
            // 创建与Excel第一个sheet完全一致的表格
            let detailsHtml = `
                <div style="max-width: 900px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2c3e50; margin: 0;">学校详情</h2>
                        <button onclick="closeDetailsModal()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">关闭</button>
                    </div>
                    
                    <!-- Excel表格样式 -->
                    <div style="border: 1px solid #000; background: white;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr>
                                <td colspan="4" style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; background: #f0f0f0;">高校测算</td>
                            </tr>
                            <tr>
                                <td colspan="4" style="border: 1px solid #000; padding: 6px; background: #f8f8f8;">基本办学条件缺口（"－"表示超额，"+"表示缺额）</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="border: 1px solid #000; padding: 6px;"></td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">测算时间：${new Date(school.created_at).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/\//g, '-')}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">测算年份</td>
                                <td colspan="3" style="border: 1px solid #000; padding: 6px;">${school.year}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">学生统计年份</td>
                                <td style="border: 1px solid #000; padding: 6px;">${school.student_stat_year || school.year}</td>
                                <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">建筑面积统计年份</td>
                                <td style="border: 1px solid #000; padding: 6px;">${school.building_stat_year || school.year}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">单位/学校(机构)名称(章)</td>
                                <td style="border: 1px solid #000; padding: 6px;">${school.school_name}</td>
                                <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">院校类型</td>
                                <td style="border: 1px solid #000; padding: 6px;">${school.school_type ? school.school_type.substring(5) : ''}</td>
                            </tr>
                            <tr>
                                <td colspan="4" style="border: 1px solid #000; padding: 6px;"></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="border: 1px solid #000; padding: 6px; font-weight: bold; background: #f8f8f8;">规划学生数</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">专科全日制学生数(人)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${school.full_time_specialist || 0}</td>
                                <td style="border: 1px solid #000; padding: 6px;">本科全日制学生数(人)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${school.full_time_undergraduate || 0}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">硕士全日制学生数(人)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${school.full_time_master || 0}</td>
                                <td style="border: 1px solid #000; padding: 6px;">博士全日制学生数(人)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${school.full_time_doctor || 0}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">本科留学生数(人)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${school.international_undergraduate || 0}</td>
                                <td style="border: 1px solid #000; padding: 6px;">硕士留学生数(人)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${school.international_master || 0}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">博士留学生(人)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${school.international_doctor || 0}</td>
                                <td style="border: 1px solid #000; padding: 6px;"></td>
                                <td style="border: 1px solid #000; padding: 6px;"></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="border: 1px solid #000; padding: 6px;"></td>
                            </tr>
                            <tr>
                                <td colspan="4" style="border: 1px solid #000; padding: 6px; font-weight: bold; background: #f8f8f8;">测算结果</td>
                            </tr>
                            <tr style="font-weight: bold; background: #f0f0f0;">
                                <td style="border: 1px solid #000; padding: 6px;">用房类型</td>
                                <td style="border: 1px solid #000; padding: 6px;">现状建筑面积(m²)</td>
                                <td style="border: 1px solid #000; padding: 6px;">学生规模测算建筑面积(m²)</td>
                                <td style="border: 1px solid #000; padding: 6px;">学生规模测算建筑面积缺额(m²)</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">教学及辅助用房</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.teaching_area || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(calculationResults['总应配教学及辅助用房(A)'] || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.teaching_area_gap || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">办公用房</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.office_area || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(calculationResults['总应配办公用房(B)'] || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.office_area_gap || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">生活配套用房</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.total_living_area || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${(parseFloat(calculationResults['总应配学生宿舍(C1)'] || 0) + parseFloat(calculationResults['总应配其他生活用房(C2)'] || 0)).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${(parseFloat(school.dormitory_area_gap || 0) + parseFloat(school.other_living_area_gap || 0)).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">其中:学生宿舍</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.dormitory_area || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(calculationResults['总应配学生宿舍(C1)'] || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.dormitory_area_gap || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">其中:其他生活用房</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat((school.total_living_area || 0) - (school.dormitory_area || 0)).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(calculationResults['总应配其他生活用房(C2)'] || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.other_living_area_gap || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">后勤补助用房</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.logistics_area || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(calculationResults['总应配后勤辅助用房(D)'] || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.logistics_area_gap || 0).toFixed(2)}</td>
                            </tr>
                            <tr style="font-weight: bold; background: #f0f0f0;">
                                <td style="border: 1px solid #000; padding: 6px;">小计</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.current_building_area || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(school.required_building_area || 0).toFixed(2)}</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(gapWithoutSubsidy || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="border: 1px solid #000; padding: 6px; font-weight: bold;">学生规模测算建筑面积总缺额（不含补助）(m²)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right; font-weight: bold;">${parseFloat(gapWithoutSubsidy || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="border: 1px solid #000; padding: 6px; font-weight: bold;">补助建筑总面积(m²)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right; font-weight: bold;">${parseFloat(school.special_subsidy_total || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="border: 1px solid #000; padding: 6px; font-weight: bold;">学生规模测算建筑面积总缺额（含补助）(m²)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: right; font-weight: bold;">${parseFloat(school.total_area_gap_with_subsidy || 0).toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
            `;
            
            // 如果有特殊补助，显示补助明细
            if (specialSubsidies && specialSubsidies.length > 0) {
                detailsHtml += `
                    <div style="margin-top: 20px; border: 1px solid #000;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr>
                                <td colspan="2" style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; background: #f0f0f0;">特殊补助明细</td>
                            </tr>
                            <tr style="font-weight: bold; background: #f8f8f8;">
                                <td style="border: 1px solid #000; padding: 6px;">补助名称</td>
                                <td style="border: 1px solid #000; padding: 6px;">补助面积(㎡)</td>
                            </tr>
                `;
                
                specialSubsidies.forEach(subsidy => {
                    detailsHtml += `
                        <tr>
                            <td style="border: 1px solid #000; padding: 6px;">${subsidy['特殊用房补助名称'] || subsidy.name || '未命名项目'}</td>
                            <td style="border: 1px solid #000; padding: 6px; text-align: right;">${parseFloat(subsidy['补助面积（m²）'] || subsidy.area || 0).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                detailsHtml += `
                        </table>
                    </div>
                `;
            }
            
            detailsHtml += `
                </div>
            `;
            
            // 创建模态框显示详情
            const modal = document.createElement('div');
            modal.id = 'detailsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                overflow-y: auto;
                padding: 20px 0;
            `;
            modal.innerHTML = detailsHtml;
            document.body.appendChild(modal);
            
            // 点击背景关闭模态框
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeDetailsModal();
                }
            });
        }
        
        // 关闭详情模态框
        function closeDetailsModal() {
            const modal = document.getElementById('detailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // 编辑记录 - 将数据回填到数据填报界面
        function editDataRecord(recordId) {
            const school = allDataSchoolsData.find(s => s.id === recordId);
            if (!school) {
                alert('找不到记录数据');
                return;
            }
            
            // 直接切换到数据填报页面
            showPage('data-entry');
            
            // 等待页面切换完成后填充数据
            setTimeout(() => {
                fillFormWithData(school);
            }, 100);
        }

        // 将历史数据填充到表单中
        function fillFormWithData(school) {
            try {
                // 先确保表单已经完全初始化
                console.log('开始填充表单数据，学校:', school.school_name);
                
                // 等待表单完全加载
                setTimeout(() => {
                    // 确保表单初始化完成
                    if (typeof initializeOnlineForm === 'function') {
                        console.log('重新初始化表单');
                        initializeOnlineForm();
                    }
                    
                    // 基本信息
                    const schoolNameEl = document.getElementById('schoolName');
                    if (schoolNameEl) schoolNameEl.value = school.school_name || '';
                    
                    const yearEl = document.getElementById('year');
                    if (yearEl) yearEl.value = school.year || 2025;
                    
                    // 新增字段：学生统计年份和建筑面积统计年份
                    const studentStatYearEl = document.getElementById('student_stat_year');
                    if (studentStatYearEl) studentStatYearEl.value = school.student_stat_year || school.year || 2025;
                    
                    const buildingStatYearEl = document.getElementById('building_stat_year');
                    if (buildingStatYearEl) buildingStatYearEl.value = school.building_stat_year || school.year || 2025;
                    
                    // 学生人数信息
                    // 对于历史数据的本专科生，优先放到本科生字段，专科生字段为0
                    const fullTimeUndergraduateEl = document.getElementById('fullTimeUndergraduate');
                    if (fullTimeUndergraduateEl) fullTimeUndergraduateEl.value = school.full_time_undergraduate || 0;
                    
                    const fullTimeSpecialistEl = document.getElementById('fullTimeSpecialist');
                    if (fullTimeSpecialistEl) fullTimeSpecialistEl.value = 0; // 历史数据没有单独的专科生字段
                    
                    const fullTimeMasterEl = document.getElementById('fullTimeMaster');
                    if (fullTimeMasterEl) fullTimeMasterEl.value = school.full_time_master || 0;
                    
                    const fullTimeDoctorEl = document.getElementById('fullTimeDoctor');
                    if (fullTimeDoctorEl) fullTimeDoctorEl.value = school.full_time_doctor || 0;
                    
                    const internationalUndergraduateEl = document.getElementById('internationalUndergraduate');
                    if (internationalUndergraduateEl) internationalUndergraduateEl.value = school.international_undergraduate || 0;
                    
                    const internationalMasterEl = document.getElementById('internationalMaster');
                    if (internationalMasterEl) internationalMasterEl.value = school.international_master || 0;
                    
                    const internationalDoctorEl = document.getElementById('internationalDoctor');
                    if (internationalDoctorEl) internationalDoctorEl.value = school.international_doctor || 0;
                    
                    // 建筑面积信息
                    const teachingAreaEl = document.getElementById('teachingArea');
                    if (teachingAreaEl) teachingAreaEl.value = school.teaching_area || 0;
                    
                    const officeAreaEl = document.getElementById('officeArea');
                    if (officeAreaEl) officeAreaEl.value = school.office_area || 0;
                    
                    const totalLivingAreaEl = document.getElementById('totalLivingArea');
                    if (totalLivingAreaEl) totalLivingAreaEl.value = school.total_living_area || 0;
                    
                    const dormitoryAreaEl = document.getElementById('dormitoryArea');
                    if (dormitoryAreaEl) dormitoryAreaEl.value = school.dormitory_area || 0;
                    
                    const logisticsAreaEl = document.getElementById('logisticsArea');
                    if (logisticsAreaEl) logisticsAreaEl.value = school.logistics_area || 0;
                    
                    // 备注
                    const remarksEl = document.getElementById('remarks');
                    if (remarksEl) remarksEl.value = school.remarks || '';
                    
                    // 触发学校名称变化事件（更新院校类别显示）
                    if (schoolNameEl) {
                        updateSchoolType();
                    }
                    
                    // 触发学生人数和面积计算
                    calculateTotalStudents();
                    calculateOtherLivingArea();
                    calculateTotalBuildingArea();
                    
                    // 延迟一点再处理特殊补助，确保基本表单已经完全填充
                    setTimeout(() => {
                        fillSpecialSubsidies(school);
                    }, 300);
                    
                    // 滚动到页面顶部
                    window.scrollTo(0, 0);
                    
                }, 200);
                
            } catch (error) {
                console.error('填充表单数据失败:', error);
                // 静默处理错误，不显示弹窗
            }
        }

        // 填充特殊补助信息 - 独立函数
        function fillSpecialSubsidies(school) {
            // 填充特殊补助信息
            console.log('开始填充特殊补助，原始数据:', school.special_subsidies);
            
            if (school.special_subsidies) {
                let subsidiesData = [];
                
                // 尝试解析特殊补助数据
                try {
                    if (typeof school.special_subsidies === 'string') {
                        subsidiesData = JSON.parse(school.special_subsidies);
                    } else if (Array.isArray(school.special_subsidies)) {
                        subsidiesData = school.special_subsidies;
                    }
                    
                    console.log('解析后的特殊补助数据:', subsidiesData);
                    
                    if (subsidiesData && subsidiesData.length > 0) {
                        // 先清空现有的特殊补助
                        const subsidiesContainer = document.getElementById('specialSubsidies');
                        if (subsidiesContainer) {
                            console.log('清空现有特殊补助容器');
                            subsidiesContainer.innerHTML = '';
                        }
                        
                        // 添加历史的特殊补助项 - 使用递归确保时序正确
                        function addSubsidyRecursively(index) {
                            if (index >= subsidiesData.length) {
                                // 所有补助项都处理完成，更新汇总
                                console.log('所有特殊补助项处理完成，更新汇总');
                                if (typeof updateSubsidySummary === 'function') {
                                    updateSubsidySummary();
                                }
                                return;
                            }
                            
                            const subsidy = subsidiesData[index];
                            console.log(`处理第${index + 1}个特殊补助项:`, subsidy);
                            
                            if (typeof addSubsidy === 'function') {
                                addSubsidy();
                                
                                    // 使用更长的延迟确保DOM更新完成
                                    setTimeout(() => {
                                        // 查找所有补助项，排除汇总行
                                        const subsidyItems = document.querySelectorAll('.subsidy-item:not(.subsidy-summary)');
                                        console.log(`当前页面上的补助项数量（排除汇总）: ${subsidyItems.length}`);
                                        console.log('所有补助项元素（排除汇总）:', subsidyItems);
                                        
                                        if (subsidyItems.length > 0) {
                                            const lastItem = subsidyItems[subsidyItems.length - 1];
                                            console.log('最后一个补助项元素（排除汇总）:', lastItem);
                                            console.log('最后一个补助项的HTML:', lastItem.outerHTML);
                                            
                                            // 尝试多种选择器
                                            const nameInput1 = lastItem.querySelector('input[name="subsidyName[]"]');
                                            const nameInput2 = lastItem.querySelector('input[placeholder*="重点实验室"]');
                                            const nameInput3 = lastItem.querySelector('input[type="text"]:not([readonly])');
                                            const allInputs = lastItem.querySelectorAll('input:not([readonly])');
                                            
                                            console.log('查找名称输入框的多种尝试:');
                                            console.log('  by name属性:', nameInput1);
                                            console.log('  by placeholder:', nameInput2);
                                            console.log('  by type=text非readonly:', nameInput3);
                                            console.log('  所有非readonly input元素:', allInputs);
                                            
                                            const areaInput1 = lastItem.querySelector('input[name="subsidyArea[]"]');
                                            const areaInput2 = lastItem.querySelector('input[type="number"]:not([readonly])');
                                            
                                            console.log('查找面积输入框的多种尝试:');
                                            console.log('  by name属性:', areaInput1);
                                            console.log('  by type=number非readonly:', areaInput2);
                                            
                                            // 使用找到的元素 - 优先使用name属性
                                            const nameInput = nameInput1 || nameInput3 || nameInput2 || (allInputs.length > 0 ? allInputs[0] : null);
                                            const areaInput = areaInput1 || areaInput2 || (allInputs.length > 1 ? allInputs[1] : null);
                                            
                                            console.log('最终选择的输入元素:', { nameInput, areaInput });                                        // 尝试不同的字段名，使用多种访问方式
                                        console.log('补助项的所有字段:', Object.keys(subsidy));
                                        console.log('补助项完整内容:', JSON.stringify(subsidy, null, 2));
                                        
                                        // 尝试多种方式获取名称
                                        let name = '';
                                        const nameFields = ['特殊用房补助名称', 'subsidy_name', 'name', '补助名称', '名称'];
                                        for (const field of nameFields) {
                                            if (subsidy[field] !== undefined && subsidy[field] !== null && subsidy[field] !== '') {
                                                name = subsidy[field];
                                                console.log(`名称匹配字段: ${field} = "${name}"`);
                                                break;
                                            }
                                        }
                                        
                                        // 尝试多种方式获取面积
                                        let area = 0;
                                        const areaFields = ['补助面积（m²）', 'subsidy_area', 'area', '补助面积', '面积'];
                                        for (const field of areaFields) {
                                            if (subsidy[field] !== undefined && subsidy[field] !== null) {
                                                area = subsidy[field];
                                                console.log(`面积匹配字段: ${field} = "${area}"`);
                                                break;
                                            }
                                        }
                                        
                                        console.log(`最终匹配结果 - 名称: "${name}", 面积: "${area}"`);
                                        
                                        if (nameInput) {
                                            console.log(`设置前名称输入框值: "${nameInput.value}"`);
                                            console.log(`名称输入框placeholder: "${nameInput.placeholder}"`);
                                            console.log(`名称输入框类型: ${nameInput.type}`);
                                            
                                            nameInput.value = String(name || '');
                                            console.log(`设置后名称输入框值: "${nameInput.value}"`);
                                            
                                            // 强制刷新显示 - 多种方式
                                            nameInput.setAttribute('value', String(name || ''));
                                            
                                            // 触发多种事件
                                            nameInput.dispatchEvent(new Event('input', { bubbles: true }));
                                            nameInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            nameInput.dispatchEvent(new Event('keyup', { bubbles: true }));
                                            
                                            // 强制触发重绘
                                            nameInput.style.display = 'none';
                                            nameInput.offsetHeight; // 触发重排
                                            nameInput.style.display = '';
                                            
                                            console.log(`最终检查名称输入框值: "${nameInput.value}"`);
                                        } else {
                                            console.error('所有尝试都未找到名称输入框！');
                                            console.error('补助项HTML结构:', lastItem ? lastItem.outerHTML : '无lastItem');
                                        }
                                        
                                        if (areaInput) {
                                            console.log(`设置前面积输入框值: "${areaInput.value}"`);
                                            console.log(`面积输入框类型: ${areaInput.type}`);
                                            
                                            // 格式化面积值为两位小数
                                            const formattedArea = parseFloat(area || 0).toFixed(2);
                                            areaInput.value = formattedArea;
                                            console.log(`设置后面积输入框值: "${areaInput.value}"`);
                                            
                                            // 强制刷新显示 - 多种方式
                                            areaInput.setAttribute('value', formattedArea);
                                            
                                            // 触发多种事件
                                            areaInput.dispatchEvent(new Event('input', { bubbles: true }));
                                            areaInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            areaInput.dispatchEvent(new Event('keyup', { bubbles: true }));
                                            
                                            // 强制触发重绘
                                            areaInput.style.display = 'none';
                                            areaInput.offsetHeight; // 触发重排
                                            areaInput.style.display = '';
                                            
                                            console.log(`最终检查面积输入框值: "${areaInput.value}"`);
                                        } else {
                                            console.error('所有尝试都未找到面积输入框！');
                                            console.error('补助项HTML结构:', lastItem ? lastItem.outerHTML : '无lastItem');
                                        }
                                    } else {
                                        console.error('未找到任何补助项元素');
                                    }
                                    
                                    // 处理下一个补助项
                                    addSubsidyRecursively(index + 1);
                                }, 500); // 增加延迟时间确保DOM完全更新
                            } else {
                                console.error('addSubsidy 函数不存在');
                                addSubsidyRecursively(index + 1);
                            }
                        }
                        
                        // 开始递归处理
                        addSubsidyRecursively(0);
                    }
                } catch (error) {
                    console.error('解析特殊补助数据失败:', error);
                    console.log('原始数据类型:', typeof school.special_subsidies);
                    console.log('原始数据内容:', school.special_subsidies);
                }
            }
        }

        // 删除学校组合记录
        async function deleteSchoolCombination(schoolName, year, submitterUsername) {
            const confirmMessage = `确定要删除"${schoolName} - ${year}年测算 - 测算用户:${submitterUsername}"的所有记录吗？\n\n此操作将删除该组合的所有历史记录，不可恢复。`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            console.log('开始删除学校组合记录:', { schoolName, year, submitterUsername });
            
            // 显示删除进度
            const progressDiv = document.createElement('div');
            progressDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                            z-index: 2000; text-align: center;">
                    <h4>正在删除记录...</h4>
                    <p>请稍候，正在删除该组合的所有记录</p>
                </div>
            `;
            document.body.appendChild(progressDiv);
            
            try {
                const response = await fetch('/api/school-combination', {
                    method: 'DELETE',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    body: JSON.stringify({
                        schoolName: schoolName,
                        year: year,
                        submitterUsername: submitterUsername
                    })
                });
                
                const result = await response.json();
                console.log('删除API响应:', result);
                
                // 移除进度提示
                progressDiv.remove();
                
                if (result.success) {
                    console.log(`删除成功！共删除了 ${result.deletedCount} 条记录`);
                    console.log('删除成功，开始刷新数据列表...');
                    
                    // 清空当前显示的数据
                    allDataSchoolsData = [];
                    
                    // 立即显示加载状态
                    const resultsContainer = document.getElementById('dataHistoryResults');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '<div class="loading">正在刷新数据列表...</div>';
                    }
                    
                    // 延迟一点时间再刷新，确保数据库操作完成
                    setTimeout(() => {
                        console.log('执行数据刷新...');
                        searchDataRecords().then(() => {
                            console.log('数据刷新完成');
                        }).catch(err => {
                            console.error('刷新数据失败:', err);
                            alert('刷新数据失败，请手动点击"查找"按钮重新加载。');
                        });
                    }, 1000);
                } else {
                    console.error('删除失败:', result.error);
                    showDataError('删除失败: ' + result.error);
                }
            } catch (error) {
                // 移除进度提示
                progressDiv.remove();
                console.error('删除失败:', error);
                showDataError('删除失败: ' + error.message);
            }
        }

        // 删除记录（保留原功能用于其他地方）
        async function deleteDataRecord(recordId) {
            if (!confirm('确定要删除这条记录吗？此操作不可恢复。')) {
                return;
            }
            
            console.log('开始删除记录ID:', recordId);
            
            // 显示删除进度
            const progressDiv = document.createElement('div');
            progressDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                            z-index: 2000; text-align: center;">
                    <h4>正在删除记录...</h4>
                    <p>请稍候，正在处理删除请求</p>
                </div>
            `;
            document.body.appendChild(progressDiv);
            
            try {
                const response = await fetch(`/api/school-record/${recordId}`, {
                    method: 'DELETE',
                    cache: 'no-cache',  // 禁用缓存
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                const result = await response.json();
                console.log('删除API响应:', result);
                
                // 移除进度提示
                progressDiv.remove();
                
                if (result.success) {
                    console.log('记录删除成功！');
                    console.log('删除成功，开始刷新数据列表...');
                    
                    // 清空当前显示的数据
                    allDataSchoolsData = [];
                    
                    // 立即显示加载状态
                    const resultsContainer = document.getElementById('dataHistoryResults');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '<div class="loading">正在刷新数据列表...</div>';
                    }
                    
                    // 延迟一点时间再刷新，确保数据库操作完成
                    setTimeout(() => {
                        console.log('执行数据刷新...');
                        searchDataRecords().then(() => {
                            console.log('数据刷新完成');
                        }).catch(err => {
                            console.error('刷新数据失败:', err);
                            alert('刷新数据失败，请手动点击"查找"按钮重新加载。');
                        });
                    }, 1000);
                } else {
                    console.error('删除失败:', result.error);
                    showDataError('删除失败: ' + result.error);
                }
            } catch (error) {
                // 移除进度提示
                progressDiv.remove();
                console.error('删除失败:', error);
                showDataError('删除失败: ' + error.message);
            }
        }

        // 下载记录
        async function downloadRecord(recordId) {
            try {
                const response = await fetch(`/api/download-record/${recordId}`);
                
                if (!response.ok) {
                    throw new Error('下载失败');
                }
                
                // 解析JSON响应
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || '下载失败');
                }
                
                // 将base64数据转换为二进制
                const binaryString = atob(result.fileData);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // 创建Blob并下载，完美支持中文文件名
                const blob = new Blob([bytes], { type: result.mimeType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = result.fileName; // 直接使用返回的中文文件名
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('文件下载成功:', result.fileName);
                
            } catch (error) {
                console.error('下载失败:', error);
                alert('下载失败: ' + error.message);
            }
        }

        // 显示错误信息
        function showDataError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;
            
            // 插入到数据管理页面顶部
            const container = document.querySelector('#page-data-management .content-body');
            if (container) {
                container.insertBefore(errorDiv, container.firstChild);
                
                // 3秒后自动移除
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 3000);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查数据库状态
            checkDatabaseStatus();
            
            // 移动端点击外部关闭菜单
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const menuBtn = document.querySelector('.mobile-menu-btn');
                    
                    if (sidebar && menuBtn && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                        closeSidebar();
                    }
                }
            });

            // 初始加载统计数据（如果在统计页面） - 已注释，统计页面已被禁用
            // const currentPage = document.querySelector('.page-content.active');
            // if (currentPage && currentPage.id === 'page-statistics') {
            //     loadStatisticsContent();
            // }
        });

        // ========== 年份选择器功能 ==========
        let currentYearGridIndex = 0; // 当前显示的年份组索引
        const currentYear = new Date().getFullYear(); // 当前年份
        const selectedYear = currentYear; // 已选择的年份

        // 显示年份选择器
        function showYearGrid() {
            const overlay = document.getElementById('yearGridOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
                
                // 计算当前年份应该在哪个组
                const yearInput = document.getElementById('year');
                const inputYear = parseInt(yearInput.value) || currentYear;
                currentYearGridIndex = Math.floor((inputYear - (currentYear - 4)) / 9);
                
                updateYearGrid();
                
                // 添加键盘事件监听
                document.addEventListener('keydown', handleYearGridKeyboard);
            }
        }

        // 隐藏年份选择器
        function hideYearGrid() {
            const overlay = document.getElementById('yearGridOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                
                // 移除键盘事件监听
                document.removeEventListener('keydown', handleYearGridKeyboard);
            }
        }

        // 移动年份网格
        function moveYearGrid(direction) {
            currentYearGridIndex += direction;
            updateYearGrid();
        }

        // 更新年份网格显示
        function updateYearGrid() {
            const yearGrid = document.getElementById('yearGrid');
            const yearRangeText = document.getElementById('yearRangeText');
            const yearInput = document.getElementById('year');
            const inputYear = parseInt(yearInput.value) || currentYear;
            
            if (!yearGrid || !yearRangeText) return;
            
            // 计算当前组的起始年份（以当前年份为中心，前后各4年，总共9年一组）
            const baseYear = currentYear - 4 + (currentYearGridIndex * 9);
            const years = [];
            
            for (let i = 0; i < 9; i++) {
                years.push(baseYear + i);
            }
            
            // 更新范围文本
            yearRangeText.textContent = `${years[0]} - ${years[8]}`;
            
            // 生成年份网格
            yearGrid.innerHTML = '';
            years.forEach(year => {
                const yearItem = document.createElement('div');
                yearItem.className = 'year-item';
                yearItem.textContent = year;
                yearItem.onclick = () => selectYear(year);
                
                // 标记当前年份
                if (year === currentYear) {
                    yearItem.classList.add('current');
                }
                
                // 标记已选择的年份
                if (year === inputYear) {
                    yearItem.classList.add('selected');
                }
                
                yearGrid.appendChild(yearItem);
            });
        }

        // 选择年份
        function selectYear(year) {
            const yearInput = document.getElementById('year');
            if (yearInput) {
                yearInput.value = year;
                
                // 触发change事件，如果有其他逻辑依赖年份变化
                const event = new Event('change', { bubbles: true });
                yearInput.dispatchEvent(event);
            }
            
            hideYearGrid();
        }

        // 处理键盘事件
        function handleYearGridKeyboard(e) {
            switch(e.key) {
                case 'Escape':
                    hideYearGrid();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    moveYearGrid(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    moveYearGrid(1);
                    break;
            }
        }

        // 点击遮罩层关闭年份选择器
        document.addEventListener('click', function(e) {
            const overlay = document.getElementById('yearGridOverlay');
            if (e.target === overlay) {
                hideYearGrid();
            }
        });

        // ========== 学生统计年份选择器功能 ==========
        let currentStudentYearGridIndex = 0; // 当前显示的学生统计年份组索引

        // 显示学生统计年份选择器
        function showStudentYearGrid() {
            const overlay = document.getElementById('studentYearGridOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
                
                // 计算当前年份应该在哪个组
                const yearInput = document.getElementById('student_stat_year');
                const inputYear = parseInt(yearInput.value) || currentYear;
                currentStudentYearGridIndex = Math.floor((inputYear - (currentYear - 4)) / 9);
                
                updateStudentYearGrid();
                
                // 添加键盘事件监听
                document.addEventListener('keydown', handleStudentYearGridKeyboard);
            }
        }

        // 隐藏学生统计年份选择器
        function hideStudentYearGrid() {
            const overlay = document.getElementById('studentYearGridOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                
                // 移除键盘事件监听
                document.removeEventListener('keydown', handleStudentYearGridKeyboard);
            }
        }

        // 移动学生统计年份网格
        function moveStudentYearGrid(direction) {
            currentStudentYearGridIndex += direction;
            updateStudentYearGrid();
        }

        // 更新学生统计年份网格显示
        function updateStudentYearGrid() {
            const yearGrid = document.getElementById('studentYearGrid');
            const yearRangeText = document.getElementById('studentYearRangeText');
            const yearInput = document.getElementById('student_stat_year');
            const inputYear = parseInt(yearInput.value) || currentYear;
            
            if (!yearGrid || !yearRangeText) return;
            
            // 计算当前组的起始年份（以当前年份为中心，前后各4年，总共9年一组）
            const baseYear = currentYear - 4 + (currentStudentYearGridIndex * 9);
            const years = [];
            
            for (let i = 0; i < 9; i++) {
                years.push(baseYear + i);
            }
            
            // 更新范围文本
            yearRangeText.textContent = `${years[0]} - ${years[8]}`;
            
            // 生成年份网格
            yearGrid.innerHTML = '';
            years.forEach(year => {
                const yearItem = document.createElement('div');
                yearItem.className = 'year-item';
                yearItem.textContent = year;
                yearItem.onclick = () => selectStudentYear(year);
                
                // 标记当前年份
                if (year === currentYear) {
                    yearItem.classList.add('current');
                }
                
                // 标记已选择的年份
                if (year === inputYear) {
                    yearItem.classList.add('selected');
                }
                
                yearGrid.appendChild(yearItem);
            });
        }

        // 选择学生统计年份
        function selectStudentYear(year) {
            const yearInput = document.getElementById('student_stat_year');
            if (yearInput) {
                yearInput.value = year;
                
                // 触发change事件，如果有其他逻辑依赖年份变化
                const event = new Event('change', { bubbles: true });
                yearInput.dispatchEvent(event);
            }
            
            hideStudentYearGrid();
        }

        // 处理学生统计年份键盘事件
        function handleStudentYearGridKeyboard(e) {
            switch(e.key) {
                case 'Escape':
                    hideStudentYearGrid();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    moveStudentYearGrid(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    moveStudentYearGrid(1);
                    break;
            }
        }

        // 点击遮罩层关闭学生统计年份选择器
        document.addEventListener('click', function(e) {
            const overlay = document.getElementById('studentYearGridOverlay');
            if (e.target === overlay) {
                hideStudentYearGrid();
            }
        });

        // ========== 建筑面积统计年份选择器功能 ==========
        let currentBuildingYearGridIndex = 0; // 当前显示的建筑面积统计年份组索引

        // 显示建筑面积统计年份选择器
        function showBuildingYearGrid() {
            const overlay = document.getElementById('buildingYearGridOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
                
                // 计算当前年份应该在哪个组
                const yearInput = document.getElementById('building_stat_year');
                const inputYear = parseInt(yearInput.value) || currentYear;
                currentBuildingYearGridIndex = Math.floor((inputYear - (currentYear - 4)) / 9);
                
                updateBuildingYearGrid();
                
                // 添加键盘事件监听
                document.addEventListener('keydown', handleBuildingYearGridKeyboard);
            }
        }

        // 隐藏建筑面积统计年份选择器
        function hideBuildingYearGrid() {
            const overlay = document.getElementById('buildingYearGridOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                
                // 移除键盘事件监听
                document.removeEventListener('keydown', handleBuildingYearGridKeyboard);
            }
        }

        // 移动建筑面积统计年份网格
        function moveBuildingYearGrid(direction) {
            currentBuildingYearGridIndex += direction;
            updateBuildingYearGrid();
        }

        // 更新建筑面积统计年份网格显示
        function updateBuildingYearGrid() {
            const yearGrid = document.getElementById('buildingYearGrid');
            const yearRangeText = document.getElementById('buildingYearRangeText');
            const yearInput = document.getElementById('building_stat_year');
            const inputYear = parseInt(yearInput.value) || currentYear;
            
            if (!yearGrid || !yearRangeText) return;
            
            // 计算当前组的起始年份（以当前年份为中心，前后各4年，总共9年一组）
            const baseYear = currentYear - 4 + (currentBuildingYearGridIndex * 9);
            const years = [];
            
            for (let i = 0; i < 9; i++) {
                years.push(baseYear + i);
            }
            
            // 更新范围文本
            yearRangeText.textContent = `${years[0]} - ${years[8]}`;
            
            // 生成年份网格
            yearGrid.innerHTML = '';
            years.forEach(year => {
                const yearItem = document.createElement('div');
                yearItem.className = 'year-item';
                yearItem.textContent = year;
                yearItem.onclick = () => selectBuildingYear(year);
                
                // 标记当前年份
                if (year === currentYear) {
                    yearItem.classList.add('current');
                }
                
                // 标记已选择的年份
                if (year === inputYear) {
                    yearItem.classList.add('selected');
                }
                
                yearGrid.appendChild(yearItem);
            });
        }

        // 选择建筑面积统计年份
        function selectBuildingYear(year) {
            const yearInput = document.getElementById('building_stat_year');
            if (yearInput) {
                yearInput.value = year;
                
                // 触发change事件，如果有其他逻辑依赖年份变化
                const event = new Event('change', { bubbles: true });
                yearInput.dispatchEvent(event);
            }
            
            hideBuildingYearGrid();
        }

        // 处理建筑面积统计年份键盘事件
        function handleBuildingYearGridKeyboard(e) {
            switch(e.key) {
                case 'Escape':
                    hideBuildingYearGrid();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    moveBuildingYearGrid(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    moveBuildingYearGrid(1);
                    break;
            }
        }

        // 点击遮罩层关闭建筑面积统计年份选择器
        document.addEventListener('click', function(e) {
            const overlay = document.getElementById('buildingYearGridOverlay');
            if (e.target === overlay) {
                hideBuildingYearGrid();
            }
        });

        // ========== 用户管理页面功能 ==========
        let users = [];

        // 更新用户管理页面的用户信息
        function updateUserManagementUserInfo(user) {
            const avatarEl = document.getElementById('userAvatar4');
            const nameEl = document.getElementById('userName4');
            const roleEl = document.getElementById('userRole4');
            
            if (avatarEl && nameEl && roleEl) {
                avatarEl.textContent = user.real_name ? user.real_name.charAt(0).toUpperCase() : user.username.charAt(0).toUpperCase();
                nameEl.textContent = user.real_name || user.username;
                
                let roleText = '用户';
                if (user.role === 'admin') roleText = '管理员';
                else if (user.role === 'construction_center') roleText = '基建中心';
                else if (user.role === 'school') roleText = '学校用户';
                
                roleEl.textContent = roleText;
            }
        }

        // 加载用户管理页面内容
        async function loadUserManagementContent() {
            await loadUserList();
        }

        // 获取角色显示名称
        function getRoleDisplayName(role) {
            switch(role) {
                case 'admin':
                    return '管理员';
                case 'construction_center':
                    return '基建中心';
                case 'school':
                    return '学校用户';
                default:
                    return '用户';
            }
        }

        // 获取状态显示样式
        function getStatusBadge(status) {
            if (status === 'active') {
                return '<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: #d4edda; color: #155724;">激活</span>';
            } else {
                return '<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: #f8d7da; color: #721c24;">禁用</span>';
            }
        }

        // 获取角色显示样式
        function getRoleBadge(role) {
            let color, bgColor;
            switch(role) {
                case 'admin':
                    color = '#0c5460';
                    bgColor = '#d1ecf1';
                    break;
                case 'construction_center':
                    color = '#856404';
                    bgColor = '#fff3cd';
                    break;
                case 'school':
                    color = '#155724';
                    bgColor = '#d4edda';
                    break;
                default:
                    color = '#383d41';
                    bgColor = '#e2e3e5';
            }
            return `<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: ${bgColor}; color: ${color};">${getRoleDisplayName(role)}</span>`;
        }

        // 加载用户列表
        async function loadUserList() {
            const loading = document.getElementById('userManagementLoading');
            const tableContainer = document.getElementById('userTableContainer');
            const emptyState = document.getElementById('userEmptyState');
            
            loading.style.display = 'block';
            tableContainer.style.display = 'none';
            emptyState.style.display = 'none';
            
            try {
                const response = await fetch('/api/auth/users');
                const result = await response.json();
                
                if (result.success) {
                    users = result.users;
                    displayUsers(users);
                } else {
                    showUserManagementAlert(result.message || '获取用户列表失败', 'error');
                }
            } catch (error) {
                console.error('获取用户列表失败:', error);
                showUserManagementAlert('网络错误，请稍后重试', 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        // 显示用户列表
        function displayUsers(userList) {
            const tableContainer = document.getElementById('userTableContainer');
            const emptyState = document.getElementById('userEmptyState');
            const tableBody = document.getElementById('userTableBody');
            
            if (userList.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tableContainer.style.display = 'block';
            
            tableBody.innerHTML = '';
            
            userList.forEach(user => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e9ecef';
                row.innerHTML = `
                    <td style="padding: 12px 15px;">${user.username}</td>
                    <td style="padding: 12px 15px;">${user.real_name || '-'}</td>
                    <td style="padding: 12px 15px;">${user.email || '-'}</td>
                    <td style="padding: 12px 15px;">${getRoleBadge(user.role)}</td>
                    <td style="padding: 12px 15px;">${user.school_name || '-'}</td>
                    <td style="padding: 12px 15px;">${getStatusBadge(user.status)}</td>
                    <td style="padding: 12px 15px;">${formatDate(user.created_at)}</td>
                    <td style="padding: 12px 15px;">${user.last_login ? formatDate(user.last_login) : '-'}</td>
                    <td style="padding: 12px 15px;">
                        <div style="display: flex; gap: 8px;">
                            ${user.username !== 'admin' && user.role !== 'admin' ? 
                                (user.status === 'active' ? 
                                    `<button style="padding: 6px 12px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="toggleUserStatus(${user.id}, 'inactive')">禁用</button>` :
                                    `<button style="padding: 6px 12px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="toggleUserStatus(${user.id}, 'active')">启用</button>`
                                ) : 
                                '<span style="padding: 6px 12px; font-size: 12px; color: #6c757d;">系统账户</span>'
                            }
                            ${user.username !== 'admin' && user.role !== 'admin' ? 
                                `<button style="padding: 6px 12px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="deleteUserConfirm(${user.id}, '${user.username}')">删除</button>` :
                                '<span style="padding: 6px 12px; font-size: 12px; color: #6c757d;">不可删除</span>'
                            }
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        }

        // 显示用户管理提示消息
        function showUserManagementAlert(message, type = 'info') {
            const alertEl = document.getElementById('userManagementAlert');
            let bgColor, textColor, borderColor;
            
            switch(type) {
                case 'success':
                    bgColor = '#d4edda';
                    textColor = '#155724';
                    borderColor = '#c3e6cb';
                    break;
                case 'error':
                    bgColor = '#f8d7da';
                    textColor = '#721c24';
                    borderColor = '#f5c6cb';
                    break;
                default:
                    bgColor = '#d1ecf1';
                    textColor = '#0c5460';
                    borderColor = '#bee5eb';
            }
            
            alertEl.style.display = 'block';
            alertEl.style.padding = '15px';
            alertEl.style.borderRadius = '6px';
            alertEl.style.border = `1px solid ${borderColor}`;
            alertEl.style.background = bgColor;
            alertEl.style.color = textColor;
            alertEl.style.fontSize = '12px';
            alertEl.textContent = message;
            
            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 5000);
        }

        // 显示创建用户模态框
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
            // 清空表单
            document.getElementById('createUserForm').reset();
            document.getElementById('schoolNameGroup').style.display = 'none';
        }

        // 隐藏创建用户模态框
        function hideCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
        }

        // 切换学校名称字段显示
        function toggleSchoolNameField() {
            const roleSelect = document.getElementById('createRole');
            const schoolNameGroup = document.getElementById('schoolNameGroup');
            
            if (roleSelect.value === 'school') {
                schoolNameGroup.style.display = 'block';
            } else {
                schoolNameGroup.style.display = 'none';
            }
        }

        // 创建用户
        async function createUser() {
            const form = document.getElementById('createUserForm');
            const formData = new FormData(form);
            
            const userData = {
                username: formData.get('username'),
                password: formData.get('password'),
                real_name: formData.get('real_name'),
                email: formData.get('email'),
                role: formData.get('role'),
                school_name: formData.get('school_name')
            };
            
            // 基本验证
            if (!userData.username || !userData.password || !userData.role) {
                showUserManagementAlert('请填写必填字段', 'error');
                return;
            }
            
            if (userData.role === 'school' && !userData.school_name) {
                showUserManagementAlert('学校用户必须选择学校名称', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/create-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showUserManagementAlert('用户创建成功', 'success');
                    hideCreateUserModal();
                    loadUserList(); // 重新加载用户列表
                } else {
                    showUserManagementAlert(result.message || '创建用户失败', 'error');
                }
            } catch (error) {
                console.error('创建用户失败:', error);
                showUserManagementAlert('网络错误，请稍后重试', 'error');
            }
        }

        // 切换用户状态
        async function toggleUserStatus(userId, newStatus) {
            try {
                const response = await fetch(`/api/auth/user/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showUserManagementAlert(result.message, 'success');
                    loadUserList(); // 重新加载用户列表
                } else {
                    showUserManagementAlert(result.message || '更新用户状态失败', 'error');
                }
            } catch (error) {
                console.error('更新用户状态失败:', error);
                showUserManagementAlert('网络错误，请稍后重试', 'error');
            }
        }

        // 删除用户确认
        function deleteUserConfirm(userId, username) {
            if (confirm(`确定要删除用户 "${username}" 吗？此操作不可撤销。`)) {
                deleteUser(userId);
            }
        }

        // 删除用户
        async function deleteUser(userId) {
            try {
                const response = await fetch(`/api/auth/user/${userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showUserManagementAlert(result.message, 'success');
                    loadUserList(); // 重新加载用户列表
                } else {
                    showUserManagementAlert(result.message || '删除用户失败', 'error');
                }
            } catch (error) {
                console.error('删除用户失败:', error);
                showUserManagementAlert('网络错误，请稍后重试', 'error');
            }
        }
    </script>
</body>
</html>
