<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高校建筑面积缺口测算系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* 左侧菜单样式 */
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid #34495e;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ecf0f1;
            line-height: 1.4;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #95a5a6;
            font-style: italic;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: block;
            padding: 18px 25px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #34495e;
            color: #ecf0f1;
            border-left-color: #3498db;
            transform: translateX(5px);
        }

        .menu-item.active {
            background: #34495e;
            color: #3498db;
            border-left-color: #3498db;
            font-weight: 600;
        }

        .menu-item .icon {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
            display: inline-block;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: 280px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .content-header {
            background: white;
            padding: 25px 30px;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .content-header h2 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .content-header p {
            color: #6c757d;
            font-size: 16px;
            margin: 0;
        }

        .content-body {
            padding: 30px;
            max-width: 1200px;
        }

        /* 页面内容区域 */
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f3f4;
            font-size: 20px;
            font-weight: 600;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 按钮样式 */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-download {
            background: white !important;
            color: #3498db !important;
            border: 2px solid #3498db !important;
        }

        .btn-download:hover {
            background: #3498db !important;
            color: white !important;
            border: 2px solid #3498db !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .stat-card h4 {
            font-size: 14px;
            margin-bottom: 12px;
            opacity: 0.9;
            font-weight: 500;
        }

        .stat-card .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card .stat-unit {
            font-size: 12px;
            opacity: 0.8;
        }

        /* 表格样式 */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th,
        .data-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* 搜索栏 */
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: #f8f9fa;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
        }

        /* 加载动画 */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 16px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e9ecef;
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-left: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 消息提示 */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 100%;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block !important;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .search-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .content-header {
                padding: 20px;
            }

            .content-body {
                padding: 20px;
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* 特殊补助动态表单 */
        .subsidy-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .subsidy-item input {
            flex: 1;
        }

        .remove-subsidy {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
        }

        .school-type-display {
            color: #3498db;
            font-weight: 500;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        /* 表单相关样式 */
        .form-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 25px;
        }

        .data-form {
            max-width: 100%;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f3f4;
            font-size: 18px;
            font-weight: 600;
        }

        .student-category {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .subsidy-item {
            margin-bottom: 0;
        }

        .subsidy-item .form-group {
            margin-bottom: 0;
            min-width: 0; /* 确保宽度正确计算 */
        }

        .subsidy-item .form-row {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) auto;
            gap: 15px;
            align-items: end;
            width: 100%;
        }

        .subsidy-item .form-group:last-child {
            display: flex;
            align-items: flex-end;
        }

        /* 为没有标签的form-group添加顶部间距，使其与有标签的输入框对齐 */
        /* 注释掉，因为我们希望所有补助项紧密排列 */
        /*
        .subsidy-item .form-group:not(:last-child):not(:has(label)) {
            margin-top: 28px;
        }

        .subsidy-item .form-group.no-label {
            margin-top: 28px;
        }
        */

        /* 确保汇总行与明细行完全对齐 */
        .subsidy-summary.subsidy-item .form-row {
            display: grid !important;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) auto !important;
            gap: 15px !important;
            align-items: end !important;
            width: 100% !important;
        }

        .subsidy-summary.subsidy-item .form-group {
            margin-bottom: 0 !important;
        }

        .subsidy-summary.subsidy-item .form-group:last-child {
            display: flex !important;
            align-items: flex-end !important;
        }

        .calculated-field {
            background: #f1f3f4 !important;
            cursor: not-allowed;
        }

        .school-type-display {
            display: block;
            margin-top: 5px;
            color: #3498db;
            font-weight: 600;
            font-size: 12px;
        }

        /* 按钮样式增强 */
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: #3498db;
            border: 2px solid #3498db;
        }

        .btn-outline:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .form-actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .form-actions .btn {
            margin: 0 10px;
        }

        /* 进度条样式 */
        .progress-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin: 25px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f1f3f4;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 结果显示样式 */
        .result-section,
        .school-info-section,
        .analysis-results-section {
            margin: 25px 0;
        }

        /* 优化的计算结果样式 */
        .result-section .card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
        }

        .result-section h3 {
            color: #0c4a6e;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-section h3::before {
            content: '';
            font-size: 0;
        }

        /* 学校信息卡片优化 */
        .school-info-section .card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #22c55e;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
        }

        .school-info-section h3 {
            color: #14532d;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .school-info-section h3::before {
            content: '';
            font-size: 0;
        }

        .school-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .school-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .school-name {
            color: #1f2937;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        .school-type {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .school-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            margin-bottom: 6px;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .stat-value {
            color: #1f2937;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .stat-group {
            grid-column: 1 / -1;
            background: #fafafa;
            border-radius: 8px;
            padding: 15px;
            margin: 8px 0;
        }

        .stat-group-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-group-title::before {
            content: '';
            font-size: 0;
        }

        .stat-group .stat-item {
            margin-bottom: 6px;
            border-left-color: #10b981;
        }

        /* 分析结果卡片优化 */
        .analysis-results-section .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .analysis-results-section h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-results-section h3::before {
            content: '';
            font-size: 0;
        }

        .analysis-summary {
            margin-bottom: 30px;
        }

        .analysis-summary h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: none;
            padding-bottom: 0;
        }

        /* 概况统计卡片样式 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .stat-card h4 {
            font-size: 14px;
            margin-bottom: 12px;
            opacity: 0.9;
            font-weight: 500;
        }

        .stat-card .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card .stat-unit {
            font-size: 12px;
            opacity: 0.8;
        }

        /* 直接分析内容样式，不使用标题和大框 */
        .direct-analysis-content {
            margin-top: 20px;
        }

        .school-analysis-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f3f4f6;
        }

        .school-title {
            color: #1f2937;
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
        }

        .compliance-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .compliance-badge.compliant {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
        }

        .compliance-badge.non-compliant {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .area-type-analysis {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .area-type-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            color: #374151;
        }

        .area-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .area-status.compliant {
            background: #dcfce7;
            color: #166534;
        }

        .area-status.non-compliant {
            background: #fecaca;
            color: #991b1b;
        }

        .area-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .area-details > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: white;
            border-radius: 5px;
            border-left: 2px solid #64748b;
            font-size: 0.9rem;
        }

        .gap-highlight {
            color: #dc2626;
            font-weight: 700;
        }

        .surplus-highlight {
            color: #16a34a;
            font-weight: 700;
        }

        .special-subsidy-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #0ea5e9;
        }

        .special-subsidy-info h5 {
            color: #0c4a6e;
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .subsidy-details {
            display: grid;
            gap: 10px;
        }

        .subsidy-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 4px 16px;
            font-size: 0.9rem;
        }

        .subsidy-details-table {
            max-width: 60%;
        }

        .subsidy-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .subsidy-table th,
        .subsidy-table td {
            padding: 6px 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .subsidy-table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #374151;
        }

        .no-subsidy {
            color: #6b7280;
            font-style: italic;
            font-size: 0.9rem;
        }

        .download-link {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .download-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            /* 特殊补助行在移动端仍保持三列布局 */
            .subsidy-item .form-row {
                grid-template-columns: 2fr 1fr auto;
                gap: 10px;
            }
            
            .form-actions .btn {
                width: 100%;
                margin: 5px 0;
            }

            /* 移动端结果显示优化 */
            .school-stats {
                grid-template-columns: 1fr;
            }

            .stat-group {
                grid-column: 1;
            }

            .summary-stats {
                grid-template-columns: 1fr;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .school-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .analysis-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .subsidy-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 10px 12px;
            }

            .subsidy-details-table {
                max-width: 100%;
            }

            .area-details > div {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                padding: 5px 8px;
                font-size: 0.85rem;
            }
        }

        /* 年份选择器样式 */
        .year-selector-container {
            position: relative;
        }

        .year-input {
            cursor: pointer;
            background: white !important;
        }

        .year-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .year-grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .year-grid-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .year-grid-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .year-nav-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .year-nav-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .year-nav-btn:active {
            transform: scale(0.95);
        }

        .year-range-text {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .year-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .year-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            color: #495057;
            transition: all 0.3s ease;
            position: relative;
        }

        .year-item:hover {
            background: #e3f2fd;
            border-color: #3498db;
            color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .year-item.current {
            background: #3498db;
            border-color: #2980b9;
            color: white;
        }

        .year-item.current:hover {
            background: #2980b9;
            border-color: #1e6091;
            color: white;
        }

        .year-item.selected {
            background: #27ae60;
            border-color: #219a52;
            color: white;
        }

        .year-item.selected:hover {
            background: #219a52;
            border-color: #1e8449;
        }

        .year-grid-footer {
            text-align: center;
        }

        .year-close-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .year-close-btn:hover {
            background: #5a6268;
        }

        /* 移动端年份选择器优化 */
        @media (max-width: 768px) {
            .year-grid-container {
                width: 95%;
                padding: 15px;
            }

            .year-grid {
                gap: 8px;
            }

            .year-item {
                padding: 12px 8px;
                font-size: 14px;
            }

            .year-nav-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }

        /* 学生人数统计字段样式 */
        .calculated-field {
            font-weight: bold !important;
            text-align: center !important;
        }

        .calculated-field[style*="background: #e8f4fd"] {
            color: #2980b9 !important;
            font-size: 16px !important;
        }

        .calculated-field[style*="background: #e8f5e8"] {
            color: #27ae60 !important;
            font-size: 16px !important;
        }

        .calculated-field[style*="background: #f8f9fa"] {
            color: #2c3e50 !important;
            font-size: 18px !important;
            font-weight: 900 !important;
        }

        /* 学生人数输入字段紧凑布局 */
        .student-category .form-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .student-category .form-group {
            flex: 1;
            min-width: 140px;
            max-width: 180px;
        }

        .student-category .form-group label {
            font-size: 13px;
            line-height: 1.2;
            margin-bottom: 6px;
            display: block;
        }

        .student-category .form-group input {
            font-size: 14px;
            padding: 8px 10px;
            height: auto;
        }

        .student-category .form-group small {
            font-size: 11px;
            line-height: 1.2;
            margin-top: 3px;
        }

        /* 总计字段特殊样式 */
        .student-category .form-group:last-child {
            flex: 1.2;
            max-width: 200px;
        }

        .student-category .form-group:last-child input {
            font-weight: bold;
            text-align: center;
            font-size: 15px;
        }

        /* 学生人数字段响应式调整 */
        @media (max-width: 1200px) {
            .student-category .form-group {
                min-width: 120px;
                max-width: 160px;
            }
            
            .student-category .form-group label {
                font-size: 12px;
            }
            
            .student-category .form-group input {
                font-size: 13px;
                padding: 6px 8px;
            }
        }

        @media (max-width: 768px) {
            .student-category .form-row {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .student-category .form-group {
                min-width: calc(50% - 4px);
                max-width: calc(50% - 4px);
                margin-bottom: 10px;
            }
            
            .student-category .form-group:last-child {
                min-width: 100%;
                max-width: 100%;
            }
        }

        /* 批量导出样式 */
        .export-controls {
            margin-top: 15px;
        }
        
        .export-progress {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #495057;
            font-weight: 500;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            border: 1px solid #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
            border-color: #1e7e34;
        }
        
        .btn-success:disabled {
            background: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }

        /* 缺口显示样式 */
        .gap-positive {
            color: #dc2626;
            font-weight: 600;
        }
        
        .gap-negative {
            color: #16a34a;
            font-weight: 600;
        }

    </style>
</head>
<body>
    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
    
    <div class="app-container">
        <!-- 左侧菜单 -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>高校建筑面积缺口测算系统</h1>
                <p>Building Area Gap Analysis System</p>
            </div>
            
            <div class="sidebar-menu">
                <a class="menu-item active" onclick="showPage('data-entry')" id="menu-data-entry">
                    数据填报
                </a>
                <a class="menu-item" onclick="showPage('data-management')" id="menu-data-management">
                    数据管理
                </a>
                <a class="menu-item" onclick="showPage('statistics')" id="menu-statistics">
                    统计分析
                </a>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 数据填报页面 -->
            <div id="page-data-entry" class="page-content active">
                <div class="content-header">
                    <h2>数据填报</h2>
                    <p>填写学校基本信息和建筑面积数据，自动计算建筑面积缺口</p>
                </div>
                <div class="content-body">
                    <!-- 在线数据填写表单 -->
                    <div class="online-form-section" id="onlineFormSection">
                        <div class="form-container">
                        <form id="onlineDataForm" class="data-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="schoolName">学校名称 *</label>
                                    <select id="schoolName" name="schoolName" required class="form-control" style="background: white;">
                                        <option value="">请选择学校</option>
                                        <option value="上海大学">上海大学</option>
                                        <option value="上海交通大学医学院">上海交通大学医学院</option>
                                        <option value="上海理工大学">上海理工大学</option>
                                        <option value="上海师范大学">上海师范大学</option>
                                        <option value="上海科技大学">上海科技大学</option>
                                        <option value="华东政法大学">华东政法大学</option>
                                        <option value="上海海事大学">上海海事大学</option>
                                        <option value="上海海洋大学">上海海洋大学</option>
                                        <option value="上海中医药大学">上海中医药大学</option>
                                        <option value="上海体育大学">上海体育大学</option>
                                        <option value="上海音乐学院">上海音乐学院</option>
                                        <option value="上海戏剧学院">上海戏剧学院</option>
                                        <option value="上海电力大学">上海电力大学</option>
                                        <option value="上海对外经贸大学">上海对外经贸大学</option>
                                        <option value="上海应用技术大学">上海应用技术大学</option>
                                        <option value="上海立信会计金融学院">上海立信会计金融学院</option>
                                        <option value="上海工程技术大学">上海工程技术大学</option>
                                        <option value="上海第二工业大学">上海第二工业大学</option>
                                        <option value="上海商学院">上海商学院</option>
                                        <option value="上海电机学院">上海电机学院</option>
                                        <option value="上海政法学院">上海政法学院</option>
                                        <option value="上海健康医学院">上海健康医学院</option>
                                        <option value="上海出版印刷高等专科学校">上海出版印刷高等专科学校</option>
                                        <option value="上海旅游高等专科学校">上海旅游高等专科学校</option>
                                        <option value="上海城建职业学院">上海城建职业学院</option>
                                        <option value="上海电子信息职业技术学院">上海电子信息职业技术学院</option>
                                        <option value="上海工艺美术职业学院">上海工艺美术职业学院</option>
                                        <option value="上海农林职业技术学院">上海农林职业技术学院</option>
                                        <option value="上海健康医学院附属卫生学校(上海健康护理职业学院(筹))">上海健康医学院附属卫生学校(上海健康护理职业学院(筹))</option>
                                    </select>
                                    <small class="school-type-display" id="schoolTypeDisplay"></small>
                                </div>
                                <div class="form-group">
                                    <label for="year">年份 *</label>
                                    <div class="year-selector-container">
                                        <input type="text" id="year" name="year" value="2025" readonly required class="form-control year-input" onclick="showYearGrid()">
                                        <div class="year-grid-overlay" id="yearGridOverlay" style="display: none;">
                                            <div class="year-grid-container">
                                                <div class="year-grid-header">
                                                    <button type="button" class="year-nav-btn" id="yearPrevBtn" onclick="moveYearGrid(-1)">‹</button>
                                                    <span class="year-range-text" id="yearRangeText"></span>
                                                    <button type="button" class="year-nav-btn" id="yearNextBtn" onclick="moveYearGrid(1)">›</button>
                                                </div>
                                                <div class="year-grid" id="yearGrid">
                                                    <!-- 年份九宫格将在这里动态生成 -->
                                                </div>
                                                <div class="year-grid-footer">
                                                    <button type="button" class="year-close-btn" onclick="hideYearGrid()">关闭</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>学生人数信息</h3>
                                <div class="student-category">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>全日制总数(人)</label>
                                            <input type="text" id="fullTimeTotal" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="fullTimeUndergraduate">全日制本科生(人) *</label>
                                            <input type="number" id="fullTimeUndergraduate" name="fullTimeUndergraduate" min="0" value="0" required class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="fullTimeSpecialist">全日制专科生(人)</label>
                                            <input type="number" id="fullTimeSpecialist" name="fullTimeSpecialist" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="fullTimeMaster">全日制硕士生(人)</label>
                                            <input type="number" id="fullTimeMaster" name="fullTimeMaster" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="fullTimeDoctor">全日制博士生(人)</label>
                                            <input type="number" id="fullTimeDoctor" name="fullTimeDoctor" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd; font-weight: normal; text-align: left;">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>留学生总数(人)</label>
                                            <input type="text" id="internationalTotal" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="internationalUndergraduate">留学生本科生(人)</label>
                                            <input type="number" id="internationalUndergraduate" name="internationalUndergraduate" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="internationalSpecialist">留学生专科生(人)</label>
                                            <input type="number" id="internationalSpecialist" name="internationalSpecialist" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="internationalMaster">留学生硕士生(人)</label>
                                            <input type="number" id="internationalMaster" name="internationalMaster" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd;">
                                        </div>
                                        <div class="form-group">
                                            <label for="internationalDoctor">留学生博士生(人)</label>
                                            <input type="number" id="internationalDoctor" name="internationalDoctor" min="0" value="0" class="form-control" oninput="calculateTotalStudents()" style="background: white; border: 1px solid #ddd; font-weight: normal; text-align: left;">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>学生总人数(人)</label>
                                        <input type="text" id="totalStudents" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd; font-weight: bold;">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>现有建筑面积信息</h3>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1; margin-right: 15px;">
                                        <label for="teachingArea">现有教学及辅助用房面积(m²) *</label>
                                        <input type="number" id="teachingArea" name="teachingArea" min="0" step="0.01" required class="form-control" oninput="calculateTotalBuildingArea()" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">包括教室、实验室、图书馆等</small>
                                    </div>
                                    <div class="form-group" style="flex: 1; margin-right: 15px;">
                                        <label for="officeArea">现有办公用房面积(m²) *</label>
                                        <input type="number" id="officeArea" name="officeArea" min="0" step="0.01" required class="form-control" oninput="calculateTotalBuildingArea()" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">行政办公、教师办公等</small>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="logisticsArea">现有后勤辅助用房面积(m²) *</label>
                                        <input type="number" id="logisticsArea" name="logisticsArea" min="0" step="0.01" required class="form-control" oninput="calculateTotalBuildingArea()" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">设备用房、仓库等</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1; margin-right: 15px;">
                                        <label for="totalLivingArea">现有生活用房总面积(m²) *</label>
                                        <input type="number" id="totalLivingArea" name="totalLivingArea" min="0" step="0.01" required class="form-control" oninput="calculateOtherLivingArea(); calculateTotalBuildingArea();" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">所有生活用房的总面积</small>
                                    </div>
                                    <div class="form-group" style="flex: 1; margin-right: 15px;">
                                        <label for="dormitoryArea">现有学生宿舍面积(m²) *</label>
                                        <input type="number" id="dormitoryArea" name="dormitoryArea" min="0" step="0.01" required class="form-control" oninput="calculateOtherLivingArea(); calculateTotalBuildingArea();" style="background: white; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">学生住宿用房面积</small>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>现有其他生活用房面积(m²)</label>
                                        <input type="text" id="otherLivingArea" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd;">
                                        <small style="color: #6c757d; font-size: 12px;">自动计算：生活用房总面积 - 学生宿舍面积</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>现有建筑总面积(m²)</label>
                                        <input type="text" id="totalBuildingArea" readonly class="form-control calculated-field" style="background: #f5f5f5; border: 1px solid #ddd; font-weight: bold;">
                                        <small style="color: #6c757d; font-size: 12px;">自动计算：现有教学及辅助用房面积+现有办公用房面积+现有生活用房总面积+现有后勤辅助用房面积</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>特殊补助信息</h3>
                                <div id="specialSubsidies">
                                    <!-- 特殊补助项将在这里动态添加 -->
                                </div>
                                <button type="button" class="btn btn-outline" onclick="addSubsidy()" style="background: transparent; color: #3498db; border: 2px solid #3498db; padding: 12px 20px; border-radius: 6px; cursor: pointer;">添加特殊补助</button>
                            </div>
                            
                            <div class="card">
                                <div class="form-group">
                                    <label for="remarks">备注</label>
                                    <textarea id="remarks" name="remarks" rows="3" placeholder="其他需要说明的信息" class="form-control" style="background: white; border: 1px solid #ddd;"></textarea>
                                </div>
                            </div>
                            
                            <div class="form-actions" style="text-align: center; margin-top: 30px;">
                                <button type="button" class="btn btn-outline" onclick="resetForm()" style="background: white; color: #3498db; border: 2px solid #3498db; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin-right: 15px;">重置表单</button>
                                <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: 600;">计算分析</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 计算进度显示 -->
                <div class="progress-section" id="progressSection" style="display: none;">
                    <div class="card">
                        <h3>计算进度</h3>
                        <div class="progress-bar" style="width: 100%; height: 20px; background: #f1f3f4; border-radius: 10px; overflow: hidden; margin: 15px 0;">
                            <div class="progress-fill" id="progressFill" style="height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <p id="progressText" style="text-align: center; color: #6c757d;">准备计算...</p>
                    </div>
                </div>

                <!-- 计算结果显示 -->
                <div class="result-section" id="resultSection" style="display: none;">
                    <div class="card">
                        <h3>计算结果</h3>
                        <div class="result-content" id="resultContent"></div>
                    </div>
                </div>

                <!-- 学校信息显示 -->
                <div class="school-info-section" id="schoolInfoSection" style="display: none;">
                    <div class="card">
                        <h3>学校信息</h3>
                        <div class="school-info-content" id="schoolInfoContent"></div>
                    </div>
                </div>

                <!-- 分析结果详情 -->
                <div class="analysis-results-section" id="analysisResultsSection" style="display: none;">
                    <div class="card">
                        <div class="analysis-results-content" id="analysisResultsContent"></div>
                    </div>
                </div>
                </div>
            </div>

            <!-- 数据管理页面 -->
            <div id="page-data-management" class="page-content">
                <div class="content-header">
                    <h2>数据管理</h2>
                    <p>查看、编辑和管理已提交的学校数据记录</p>
                </div>
                <div class="content-body">
                    <!-- 学校历史查询 -->
                    <div class="card">
                        <h3>学校记录查询</h3>
                        <div class="search-bar">
                            <select id="dataYearFilter" class="search-input">
                                <option value="all">所有年份</option>
                            </select>
                            <select id="dataSchoolNameFilter" class="search-input">
                                <option value="all">所有学校</option>
                                <option value="上海大学">上海大学</option>
                                <option value="上海交通大学医学院">上海交通大学医学院</option>
                                <option value="上海理工大学">上海理工大学</option>
                                <option value="上海师范大学">上海师范大学</option>
                                <option value="上海科技大学">上海科技大学</option>
                                <option value="华东政法大学">华东政法大学</option>
                                <option value="上海海事大学">上海海事大学</option>
                                <option value="上海海洋大学">上海海洋大学</option>
                                <option value="上海中医药大学">上海中医药大学</option>
                                <option value="上海体育大学">上海体育大学</option>
                                <option value="上海音乐学院">上海音乐学院</option>
                                <option value="上海戏剧学院">上海戏剧学院</option>
                                <option value="上海电力大学">上海电力大学</option>
                                <option value="上海对外经贸大学">上海对外经贸大学</option>
                                <option value="上海应用技术大学">上海应用技术大学</option>
                                <option value="上海立信会计金融学院">上海立信会计金融学院</option>
                                <option value="上海工程技术大学">上海工程技术大学</option>
                                <option value="上海第二工业大学">上海第二工业大学</option>
                                <option value="上海商学院">上海商学院</option>
                                <option value="上海电机学院">上海电机学院</option>
                                <option value="上海政法学院">上海政法学院</option>
                                <option value="上海健康医学院">上海健康医学院</option>
                                <option value="上海出版印刷高等专科学校">上海出版印刷高等专科学校</option>
                                <option value="上海旅游高等专科学校">上海旅游高等专科学校</option>
                                <option value="上海城建职业学院">上海城建职业学院</option>
                                <option value="上海电子信息职业技术学院">上海电子信息职业技术学院</option>
                                <option value="上海工艺美术职业学院">上海工艺美术职业学院</option>
                                <option value="上海农林职业技术学院">上海农林职业技术学院</option>
                                <option value="上海健康医学院附属卫生学校(上海健康护理职业学院(筹))">上海健康医学院附属卫生学校(上海健康护理职业学院(筹))</option>
                            </select>

                            <button class="btn btn-primary" onclick="searchDataRecords()">查找</button>
                            <button class="btn btn-secondary" onclick="batchDownloadSearchResults()" id="batchDownloadBtn" style="background: #28a745; color: white; margin-left: 10px;" disabled>批量下载</button>
                        </div>
                        
                        <div id="dataHistoryResults">
                            <div class="alert alert-info">请选择筛选条件并点击查找按钮</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计分析页面 -->
            <div id="page-statistics" class="page-content">
                <div class="content-header">
                    <h2>统计分析</h2>
                    <p>查看系统数据统计和分析报告</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid" id="statsGrid">
                        <!-- 统计卡片将在这里动态生成 -->
                    </div>
                    
                    <div class="card">
                        <h3>数据概览</h3>
                        <div class="search-bar">
                            <select id="statsYearFilter" class="search-input">
                                <option value="all">所有年份</option>
                            </select>
                            <button class="btn btn-primary" onclick="loadStatistics()">刷新数据</button>
                        </div>
                        <div id="statisticsContent">
                            <div class="loading">正在加载统计数据...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入外部脚本 -->
    <script src="script.js"></script>
    
    <script>
        // 添加缺少的hideOnlineForm函数
        function hideOnlineForm() {
            // 此函数不需要实际功能，因为表单已经直接嵌入页面
            console.log('Form is embedded, no need to hide');
        }

        // 页面切换函数
        function showPage(pageId) {
            // 隐藏所有页面
            const allPages = document.querySelectorAll('.page-content');
            allPages.forEach(page => page.classList.remove('active'));
            
            // 移除所有菜单项的活动状态
            const allMenuItems = document.querySelectorAll('.menu-item');
            allMenuItems.forEach(item => item.classList.remove('active'));
            
            // 显示选中的页面
            const targetPage = document.getElementById(`page-${pageId}`);
            const targetMenu = document.getElementById(`menu-${pageId}`);
            
            if (targetPage) targetPage.classList.add('active');
            if (targetMenu) targetMenu.classList.add('active');
            
            // 根据页面类型加载相应内容
            if (pageId === 'statistics') {
                setTimeout(() => loadStatisticsContent(), 300);
            } else if (pageId === 'data-management') {
                setTimeout(() => loadDataManagementContent(), 300);
            }
            
            // 移动端自动关闭菜单
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        }

        // 移动端菜单切换
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('open');
        }

        // 加载统计分析内容
        async function loadStatisticsContent() {
            await loadAvailableYears();
            // 默认加载当前年份的统计数据
            const currentYear = new Date().getFullYear();
            await loadStatistics(currentYear.toString());
        }

        // 加载统计数据
        async function loadStatistics(year = null) {
            try {
                const yearFilter = document.getElementById('statsYearFilter');
                const selectedYear = year || (yearFilter ? yearFilter.value : 'all');
                
                const url = selectedYear === 'all' ? '/api/statistics' : `/api/statistics?year=${selectedYear}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayStatistics(result.data);
                    updateStatisticsTable(selectedYear);
                } else {
                    console.error('获取统计数据失败:', result.error);
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 显示统计数据
        function displayStatistics(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            if (statsGrid) {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h4>学校总数</h4>
                        <div class="stat-value">${stats.total_schools || 0}</div>
                        <div class="stat-unit">所学校</div>
                    </div>
                    <div class="stat-card">
                        <h4>学生总数</h4>
                        <div class="stat-value">${stats.total_students_sum ? Math.round(stats.total_students_sum).toLocaleString() : 0}</div>
                        <div class="stat-unit">名学生</div>
                    </div>
                    <div class="stat-card">
                        <h4>平均学生数</h4>
                        <div class="stat-value">${stats.avg_students ? Math.round(stats.avg_students).toLocaleString() : 0}</div>
                        <div class="stat-unit">人/校</div>
                    </div>
                    <div class="stat-card">
                        <h4>总教学面积</h4>
                        <div class="stat-value">${stats.total_teaching_area_sum ? Math.round(stats.total_teaching_area_sum).toLocaleString() : 0}</div>
                        <div class="stat-unit">平方米</div>
                    </div>
                `;
            }
        }

        // 更新统计表格
        async function updateStatisticsTable(year) {
            try {
                const url = year === 'all' ? '/api/schools/latest' : `/api/schools/latest?year=${year}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    const content = document.getElementById('statisticsContent');
                    if (result.data.length === 0) {
                        content.innerHTML = '<div class="alert alert-info">暂无数据记录</div>';
                    } else {
                        let tableHtml = '<div class="table-container"><table class="data-table"><thead><tr>';
                        tableHtml += '<th>学校名称</th><th>学校类型</th><th>年份</th><th>学生总数</th><th>教学面积</th><th>最后更新</th>';
                        tableHtml += '</tr></thead><tbody>';
                        
                        result.data.forEach(school => {
                            const updateDate = new Date(school.created_at).toLocaleDateString('zh-CN');
                            tableHtml += `<tr>
                                <td><strong>${school.school_name || '未知'}</strong></td>
                                <td>${school.school_type || '未指定'}</td>
                                <td>${school.year || '未知'}</td>
                                <td>${(school.total_students || 0).toLocaleString()}人</td>
                                <td>${(school.teaching_area || 0).toLocaleString()}㎡</td>
                                <td>${updateDate}</td>
                            </tr>`;
                        });
                        
                        tableHtml += '</tbody></table></div>';
                        content.innerHTML = tableHtml;
                    }
                }
            } catch (error) {
                console.error('更新统计表格失败:', error);
                const content = document.getElementById('statisticsContent');
                content.innerHTML = '<div class="alert alert-danger">加载数据失败</div>';
            }
        }

        // 加载可用年份
        async function loadAvailableYears() {
            try {
                const response = await fetch('/api/years');
                const result = await response.json();
                
                if (result.success) {
                    const yearSelect = document.getElementById('statsYearFilter');
                    if (yearSelect) {
                        const currentYear = new Date().getFullYear();
                        yearSelect.innerHTML = '<option value="all">所有年份</option>';
                        
                        result.data.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year + '年';
                            // 默认选中当前年份
                            if (year === currentYear) {
                                option.selected = true;
                            }
                            yearSelect.appendChild(option);
                        });
                        
                        // 添加年份变化事件
                        yearSelect.onchange = function() {
                            loadStatistics(this.value);
                        };
                    }
                }
            } catch (error) {
                console.error('加载年份失败:', error);
            }
        }

        // 检查数据库连接状态
        async function checkDatabaseStatus() {
            try {
                const response = await fetch('/api/statistics');
                const dbStatusEl = document.getElementById('dbStatus');
                if (dbStatusEl) {
                    if (response.ok) {
                        dbStatusEl.textContent = '数据库已连接';
                        dbStatusEl.className = 'btn btn-success';
                    } else {
                        dbStatusEl.textContent = '数据库连接异常';
                        dbStatusEl.className = 'btn btn-danger';
                    }
                }
            } catch (error) {
                const dbStatusEl = document.getElementById('dbStatus');
                if (dbStatusEl) {
                    dbStatusEl.textContent = '数据库离线';
                    dbStatusEl.className = 'btn btn-danger';
                }
            }
        }

        // ========== 数据管理页面功能 ==========
        let allDataSchoolsData = []; // 存储所有学校数据

        // 加载数据管理页面内容
        async function loadDataManagementContent() {
            await loadDataAvailableYears();
            // 自动搜索加载所有数据
            setTimeout(() => {
                searchDataRecords();
            }, 100);
        }

        // 搜索数据记录
        async function searchDataRecords() {
            const yearFilter = document.getElementById('dataYearFilter');
            const schoolFilter = document.getElementById('dataSchoolNameFilter');
            const year = yearFilter ? yearFilter.value : 'all';
            const school = schoolFilter ? schoolFilter.value : 'all';
            
            console.log('开始搜索数据记录，筛选条件:', { year, school });
            
            const resultsContainer = document.getElementById('dataHistoryResults');
            const batchDownloadBtn = document.getElementById('batchDownloadBtn');
            resultsContainer.innerHTML = '<div class="loading">正在搜索...</div>';
            
            // 禁用批量下载按钮
            if (batchDownloadBtn) {
                batchDownloadBtn.disabled = true;
            }
            
            try {
                let url = '/api/schools/latest';
                const params = [];
                
                if (year !== 'all') {
                    params.push(`year=${year}`);
                }
                
                if (school !== 'all') {
                    params.push(`school=${encodeURIComponent(school)}`);
                }
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                console.log('请求URL:', url);
                
                const response = await fetch(url, {
                    cache: 'no-cache',  // 禁用缓存
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();
                
                console.log('搜索API响应:', result);
                
                if (result.success) {
                    allDataSchoolsData = result.data;
                    console.log('搜索成功，加载了', result.data.length, '条记录');
                    console.log('记录ID列表:', result.data.map(r => r.id));
                    displayDataSchoolsResults(result.data);
                    
                    // 如果有搜索结果，启用批量下载按钮
                    if (batchDownloadBtn && result.data.length > 0) {
                        batchDownloadBtn.disabled = false;
                    }
                } else {
                    console.error('搜索失败:', result.error);
                    showDataError('搜索失败: ' + result.error);
                }
            } catch (error) {
                console.error('搜索失败:', error);
                showDataError('搜索失败: ' + error.message);
            }
        }

        // 加载可用年份
        async function loadDataAvailableYears() {
            try {
                const response = await fetch('/api/years');
                const result = await response.json();
                
                if (result.success) {
                    const yearSelect = document.getElementById('dataYearFilter');
                    if (yearSelect) {
                        yearSelect.innerHTML = '<option value="all">所有年份</option>';
                        
                        result.data.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year + '年';
                            yearSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('加载年份失败:', error);
            }
        }

        // 加载学校数据（保留但不自动调用）
        async function loadDataSchoolsData() {
            // 该函数已被 searchDataRecords 替代
            console.log('使用 searchDataRecords 函数进行搜索');
        }

        // 按学校名称筛选（已不再使用）
        function filterDataSchools() {
            // 该函数已被移除，使用下拉选择器替代
            console.log('使用下拉选择器进行筛选');
        }

        // 清空筛选
        function clearDataFilter() {
            document.getElementById('dataYearFilter').value = 'all';
            document.getElementById('dataSchoolNameFilter').value = 'all';
            
            // 清空结果显示
            const resultsContainer = document.getElementById('dataHistoryResults');
            resultsContainer.innerHTML = '<div class="alert alert-info">请选择筛选条件并点击查找按钮</div>';
            
            // 清空数据
            allDataSchoolsData = [];
            
            // 禁用批量下载按钮
            const batchDownloadBtn = document.getElementById('batchDownloadBtn');
            if (batchDownloadBtn) {
                batchDownloadBtn.disabled = true;
            }
        }

        // 批量下载搜索结果
        async function batchDownloadSearchResults() {
            const yearFilter = document.getElementById('dataYearFilter');
            const schoolFilter = document.getElementById('dataSchoolNameFilter');
            const batchDownloadBtn = document.getElementById('batchDownloadBtn');
            
            const year = yearFilter ? yearFilter.value : 'all';
            const school = schoolFilter ? schoolFilter.value : 'all';
            
            if (!allDataSchoolsData || allDataSchoolsData.length === 0) {
                showMessage('没有可下载的数据，请先进行搜索', 'error');
                return;
            }
            
            try {
                // 显示加载状态
                const originalText = batchDownloadBtn.textContent;
                batchDownloadBtn.disabled = true;
                batchDownloadBtn.textContent = '下载中...';
                
                // 构建请求参数
                const requestBody = {
                    exportType: 'filtered'
                };
                
                if (year !== 'all') {
                    requestBody.year = year;
                }
                if (school !== 'all') {
                    requestBody.school = school;
                }
                
                console.log('批量下载请求参数:', requestBody);
                
                // 发送批量导出请求
                const response = await fetch('/api/batch-export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '批量下载失败');
                }
                
                // 成功后自动下载文件
                if (result.success) {
                    // 直接触发下载
                    window.location.href = result.downloadUrl;
                    
                    // 显示成功消息
                    showMessage(`批量下载成功！共下载 ${result.recordCount} 条记录`, 'info');
                } else {
                    throw new Error(result.error || '批量下载失败');
                }
                
            } catch (error) {
                console.error('批量下载失败:', error);
                showMessage('批量下载失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                batchDownloadBtn.disabled = false;
                batchDownloadBtn.textContent = '批量下载';
            }
        }

        // 显示消息提示
        function showMessage(message, type = 'info') {
            // 创建消息提示元素
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                z-index: 9999;
                font-weight: 500;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: opacity 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // 根据类型设置颜色
            switch (type) {
                case 'success':
                    messageDiv.style.background = '#28a745';
                    break;
                case 'error':
                    messageDiv.style.background = '#dc3545';
                    break;
                case 'warning':
                    messageDiv.style.background = '#ffc107';
                    messageDiv.style.color = '#212529';
                    break;
                default:
                    messageDiv.style.background = '#17a2b8';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3秒后自动消失
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        // 显示数据错误
        function showDataError(message) {
            const container = document.getElementById('dataHistoryResults');
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        // 显示学校数据结果
        function displayDataSchoolsResults(schoolsData) {
            const container = document.getElementById('dataHistoryResults');
            
            if (!schoolsData || schoolsData.length === 0) {
                container.innerHTML = '<div class="alert alert-info">没有找到相关数据</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="data-table"><thead><tr>';
            html += '<th>学校名称</th><th>年份</th><th>最后更新时间</th><th>操作</th>';
            html += '</tr></thead><tbody>';
            
            schoolsData.forEach(school => {
                const date = new Date(school.created_at).toLocaleDateString('zh-CN');
                const time = new Date(school.created_at).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
                
                html += `<tr>
                    <td><strong>${school.school_name || '未知'}</strong></td>
                    <td>${school.year || '未知'}</td>
                    <td>${date} ${time}</td>
                    <td>
                        <button style="background: white; color: #3498db; border: 2px solid #3498db; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 5px;" onclick="viewDataSchoolDetails(${school.id})">详情</button>
                        <button style="background: white; color: #3498db; border: 2px solid #3498db; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 5px;" onclick="downloadRecord(${school.id})">下载</button>
                        <button style="background: white; color: #f39c12; border: 2px solid #f39c12; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 5px;" onclick="editDataRecord(${school.id})">编辑</button>
                        <button style="background: white; color: #e74c3c; border: 2px solid #e74c3c; padding: 8px 16px; border-radius: 4px; cursor: pointer;" onclick="deleteDataRecord(${school.id})">删除</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            html += `<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #3498db;">
                <p style="margin: 0; color: #6c757d; font-size: 14px;">
                    <strong>共找到 ${schoolsData.length} 条记录</strong> | 
                    可以使用上方的"批量下载"按钮下载所有搜索结果
                </p>
            </div>`;
            container.innerHTML = html;
        }

        // 显示最近分析记录
        function loadDataRecentAnalysis(recentData) {
            // 已移除最近分析记录功能
        }

        // 查看学校详情
        function viewDataSchoolDetails(schoolId) {
            const school = allDataSchoolsData.find(s => s.id === schoolId);
            if (!school) {
                alert('找不到学校详情');
                return;
            }
            
            // 调试：打印学校数据
            console.log('学校详情数据:', school);
            console.log('计算结果字段检查:');
            console.log('  current_building_area:', school.current_building_area, typeof school.current_building_area);
            console.log('  required_building_area:', school.required_building_area, typeof school.required_building_area);
            console.log('  total_area_gap:', school.total_area_gap, typeof school.total_area_gap);
            
            let detailsHtml = `
                <div style="max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white;">
                    <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                        ${school.school_name} - ${school.year}年详细信息
                    </h3>
                    
                    <div style="margin: 15px 0;">
                        <h4>基本信息</h4>
                        <p><strong>学校类型：</strong>${school.school_type || '未指定'}</p>
                        <p><strong>提交时间：</strong>${new Date(school.created_at).toLocaleString('zh-CN')}</p>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <h4>学生人数</h4>
                        <p><strong>全日制本专科生：</strong>${(school.full_time_undergraduate || 0).toLocaleString()}人</p>
                        <p><strong>全日制硕士生：</strong>${(school.full_time_master || 0).toLocaleString()}人</p>
                        <p><strong>全日制博士生：</strong>${(school.full_time_doctor || 0).toLocaleString()}人</p>
                        <p><strong>留学生本科生：</strong>${(school.international_undergraduate || 0).toLocaleString()}人</p>
                        <p><strong>留学生硕士生：</strong>${(school.international_master || 0).toLocaleString()}人</p>
                        <p><strong>留学生博士生：</strong>${(school.international_doctor || 0).toLocaleString()}人</p>
                        <p><strong>学生总数：</strong>${(school.total_students || 0).toLocaleString()}人</p>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <h4>房屋面积</h4>
                        <p><strong>教学及辅助用房：</strong>${(school.teaching_area || 0).toLocaleString()}㎡</p>
                        <p><strong>办公用房：</strong>${(school.office_area || 0).toLocaleString()}㎡</p>
                        <p><strong>生活用房总面积：</strong>${(school.total_living_area || 0).toLocaleString()}㎡</p>
                        <p><strong>学生宿舍：</strong>${(school.dormitory_area || 0).toLocaleString()}㎡</p>
                        <p><strong>后勤辅助用房：</strong>${(school.logistics_area || 0).toLocaleString()}㎡</p>
                    </div>
            `;
            
            // 显示计算结果（如果有） - 修改条件判断
            console.log('条件判断结果:', !!(school.current_building_area !== null && school.current_building_area !== undefined));
            if (school.current_building_area !== null && school.current_building_area !== undefined) {
                console.log('显示计算结果部分');
                detailsHtml += `
                    <div style="margin: 15px 0;">
                        <h4>计算结果</h4>
                        <p><strong>现有建筑总面积：</strong>${(school.current_building_area || 0).toLocaleString()}㎡</p>
                        <p><strong>应配建筑总面积：</strong>${(school.required_building_area || 0).toLocaleString()}㎡</p>
                        <p><strong>教学及辅助用房缺口：</strong>${(school.teaching_area_gap || 0).toLocaleString()}㎡</p>
                        <p><strong>办公用房缺口：</strong>${(school.office_area_gap || 0).toLocaleString()}㎡</p>
                        <p><strong>学生宿舍缺口：</strong>${(school.dormitory_area_gap || 0).toLocaleString()}㎡</p>
                        <p><strong>其他生活用房缺口：</strong>${(school.other_living_area_gap || 0).toLocaleString()}㎡</p>
                        <p><strong>后勤辅助用房缺口：</strong>${(school.logistics_area_gap || 0).toLocaleString()}㎡</p>
                        <p><strong>总缺口面积：</strong>${(school.total_area_gap || 0).toLocaleString()}㎡</p>
                        <p><strong>特殊补助总面积：</strong>${(school.special_subsidy_total || 0).toLocaleString()}㎡</p>
                        <p><strong>整体达标情况：</strong><span style="color: ${school.overall_compliance ? '#27ae60' : '#e74c3c'}; font-weight: bold;">${school.overall_compliance ? '达标' : '不达标'}</span></p>
                    </div>
                `;
            } else {
                console.log('计算结果条件不满足，不显示计算结果部分');
            }
            
            // 显示特殊补助信息
            let subsidiesData = [];
            if (school.special_subsidies) {
                try {
                    if (typeof school.special_subsidies === 'string') {
                        subsidiesData = JSON.parse(school.special_subsidies);
                    } else if (Array.isArray(school.special_subsidies)) {
                        subsidiesData = school.special_subsidies;
                    }
                } catch (error) {
                    console.error('解析特殊补助数据失败:', error);
                }
            }
            
            if (subsidiesData && subsidiesData.length > 0) {
                detailsHtml += `
                    <div style="margin: 15px 0;">
                        <h4>特殊补助项目</h4>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">补助名称</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">补助面积</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                subsidiesData.forEach(subsidy => {
                    detailsHtml += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${subsidy['特殊用房补助名称'] || subsidy.subsidy_name || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${((subsidy['补助面积（m²）'] || subsidy.subsidy_area) || 0).toLocaleString()}㎡</td>
                        </tr>
                    `;
                });
                
                detailsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (school.remarks) {
                detailsHtml += `
                    <div style="margin: 15px 0;">
                        <h4>备注</h4>
                        <p style="background: #f8f9fa; padding: 10px; border-radius: 5px;">${school.remarks}</p>
                    </div>
                `;
            }
            
            detailsHtml += `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            // 创建遮罩层并显示详情
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;
            `;
            overlay.innerHTML = detailsHtml;
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            document.body.appendChild(overlay);
        }

        // 编辑记录 - 将数据回填到数据填报界面
        function editDataRecord(recordId) {
            const school = allDataSchoolsData.find(s => s.id === recordId);
            if (!school) {
                alert('找不到记录数据');
                return;
            }
            
            // 直接切换到数据填报页面
            showPage('data-entry');
            
            // 等待页面切换完成后填充数据
            setTimeout(() => {
                fillFormWithData(school);
            }, 100);
        }

        // 将历史数据填充到表单中
        function fillFormWithData(school) {
            try {
                // 先确保表单已经完全初始化
                console.log('开始填充表单数据，学校:', school.school_name);
                
                // 等待表单完全加载
                setTimeout(() => {
                    // 确保表单初始化完成
                    if (typeof initializeOnlineForm === 'function') {
                        console.log('重新初始化表单');
                        initializeOnlineForm();
                    }
                    
                    // 基本信息
                    const schoolNameEl = document.getElementById('schoolName');
                    if (schoolNameEl) schoolNameEl.value = school.school_name || '';
                    
                    const yearEl = document.getElementById('year');
                    if (yearEl) yearEl.value = school.year || 2025;
                    
                    // 学生人数信息
                    // 对于历史数据的本专科生，优先放到本科生字段，专科生字段为0
                    const fullTimeUndergraduateEl = document.getElementById('fullTimeUndergraduate');
                    if (fullTimeUndergraduateEl) fullTimeUndergraduateEl.value = school.full_time_undergraduate || 0;
                    
                    const fullTimeSpecialistEl = document.getElementById('fullTimeSpecialist');
                    if (fullTimeSpecialistEl) fullTimeSpecialistEl.value = 0; // 历史数据没有单独的专科生字段
                    
                    const fullTimeMasterEl = document.getElementById('fullTimeMaster');
                    if (fullTimeMasterEl) fullTimeMasterEl.value = school.full_time_master || 0;
                    
                    const fullTimeDoctorEl = document.getElementById('fullTimeDoctor');
                    if (fullTimeDoctorEl) fullTimeDoctorEl.value = school.full_time_doctor || 0;
                    
                    const internationalUndergraduateEl = document.getElementById('internationalUndergraduate');
                    if (internationalUndergraduateEl) internationalUndergraduateEl.value = school.international_undergraduate || 0;
                    
                    const internationalSpecialistEl = document.getElementById('internationalSpecialist');
                    if (internationalSpecialistEl) internationalSpecialistEl.value = 0; // 历史数据没有留学生专科生字段
                    
                    const internationalMasterEl = document.getElementById('internationalMaster');
                    if (internationalMasterEl) internationalMasterEl.value = school.international_master || 0;
                    
                    const internationalDoctorEl = document.getElementById('internationalDoctor');
                    if (internationalDoctorEl) internationalDoctorEl.value = school.international_doctor || 0;
                    
                    // 建筑面积信息
                    const teachingAreaEl = document.getElementById('teachingArea');
                    if (teachingAreaEl) teachingAreaEl.value = school.teaching_area || 0;
                    
                    const officeAreaEl = document.getElementById('officeArea');
                    if (officeAreaEl) officeAreaEl.value = school.office_area || 0;
                    
                    const totalLivingAreaEl = document.getElementById('totalLivingArea');
                    if (totalLivingAreaEl) totalLivingAreaEl.value = school.total_living_area || 0;
                    
                    const dormitoryAreaEl = document.getElementById('dormitoryArea');
                    if (dormitoryAreaEl) dormitoryAreaEl.value = school.dormitory_area || 0;
                    
                    const logisticsAreaEl = document.getElementById('logisticsArea');
                    if (logisticsAreaEl) logisticsAreaEl.value = school.logistics_area || 0;
                    
                    // 备注
                    const remarksEl = document.getElementById('remarks');
                    if (remarksEl) remarksEl.value = school.remarks || '';
                    
                    // 触发学校名称变化事件（更新学校类型显示）
                    if (schoolNameEl) {
                        updateSchoolType();
                    }
                    
                    // 触发学生人数和面积计算
                    calculateTotalStudents();
                    calculateOtherLivingArea();
                    calculateTotalBuildingArea();
                    
                    // 延迟一点再处理特殊补助，确保基本表单已经完全填充
                    setTimeout(() => {
                        fillSpecialSubsidies(school);
                    }, 300);
                    
                    // 滚动到页面顶部
                    window.scrollTo(0, 0);
                    
                }, 200);
                
            } catch (error) {
                console.error('填充表单数据失败:', error);
                // 静默处理错误，不显示弹窗
            }
        }

        // 填充特殊补助信息 - 独立函数
        function fillSpecialSubsidies(school) {
            // 填充特殊补助信息
            console.log('开始填充特殊补助，原始数据:', school.special_subsidies);
            
            if (school.special_subsidies) {
                let subsidiesData = [];
                
                // 尝试解析特殊补助数据
                try {
                    if (typeof school.special_subsidies === 'string') {
                        subsidiesData = JSON.parse(school.special_subsidies);
                    } else if (Array.isArray(school.special_subsidies)) {
                        subsidiesData = school.special_subsidies;
                    }
                    
                    console.log('解析后的特殊补助数据:', subsidiesData);
                    
                    if (subsidiesData && subsidiesData.length > 0) {
                        // 先清空现有的特殊补助
                        const subsidiesContainer = document.getElementById('specialSubsidies');
                        if (subsidiesContainer) {
                            console.log('清空现有特殊补助容器');
                            subsidiesContainer.innerHTML = '';
                        }
                        
                        // 添加历史的特殊补助项 - 使用递归确保时序正确
                        function addSubsidyRecursively(index) {
                            if (index >= subsidiesData.length) {
                                // 所有补助项都处理完成，更新汇总
                                console.log('所有特殊补助项处理完成，更新汇总');
                                if (typeof updateSubsidySummary === 'function') {
                                    updateSubsidySummary();
                                }
                                return;
                            }
                            
                            const subsidy = subsidiesData[index];
                            console.log(`处理第${index + 1}个特殊补助项:`, subsidy);
                            
                            if (typeof addSubsidy === 'function') {
                                addSubsidy();
                                
                                    // 使用更长的延迟确保DOM更新完成
                                    setTimeout(() => {
                                        // 查找所有补助项，排除汇总行
                                        const subsidyItems = document.querySelectorAll('.subsidy-item:not(.subsidy-summary)');
                                        console.log(`当前页面上的补助项数量（排除汇总）: ${subsidyItems.length}`);
                                        console.log('所有补助项元素（排除汇总）:', subsidyItems);
                                        
                                        if (subsidyItems.length > 0) {
                                            const lastItem = subsidyItems[subsidyItems.length - 1];
                                            console.log('最后一个补助项元素（排除汇总）:', lastItem);
                                            console.log('最后一个补助项的HTML:', lastItem.outerHTML);
                                            
                                            // 尝试多种选择器
                                            const nameInput1 = lastItem.querySelector('input[name="subsidyName[]"]');
                                            const nameInput2 = lastItem.querySelector('input[placeholder*="重点实验室"]');
                                            const nameInput3 = lastItem.querySelector('input[type="text"]:not([readonly])');
                                            const allInputs = lastItem.querySelectorAll('input:not([readonly])');
                                            
                                            console.log('查找名称输入框的多种尝试:');
                                            console.log('  by name属性:', nameInput1);
                                            console.log('  by placeholder:', nameInput2);
                                            console.log('  by type=text非readonly:', nameInput3);
                                            console.log('  所有非readonly input元素:', allInputs);
                                            
                                            const areaInput1 = lastItem.querySelector('input[name="subsidyArea[]"]');
                                            const areaInput2 = lastItem.querySelector('input[type="number"]:not([readonly])');
                                            
                                            console.log('查找面积输入框的多种尝试:');
                                            console.log('  by name属性:', areaInput1);
                                            console.log('  by type=number非readonly:', areaInput2);
                                            
                                            // 使用找到的元素 - 优先使用name属性
                                            const nameInput = nameInput1 || nameInput3 || nameInput2 || (allInputs.length > 0 ? allInputs[0] : null);
                                            const areaInput = areaInput1 || areaInput2 || (allInputs.length > 1 ? allInputs[1] : null);
                                            
                                            console.log('最终选择的输入元素:', { nameInput, areaInput });                                        // 尝试不同的字段名，使用多种访问方式
                                        console.log('补助项的所有字段:', Object.keys(subsidy));
                                        console.log('补助项完整内容:', JSON.stringify(subsidy, null, 2));
                                        
                                        // 尝试多种方式获取名称
                                        let name = '';
                                        const nameFields = ['特殊用房补助名称', 'subsidy_name', 'name', '补助名称', '名称'];
                                        for (const field of nameFields) {
                                            if (subsidy[field] !== undefined && subsidy[field] !== null && subsidy[field] !== '') {
                                                name = subsidy[field];
                                                console.log(`名称匹配字段: ${field} = "${name}"`);
                                                break;
                                            }
                                        }
                                        
                                        // 尝试多种方式获取面积
                                        let area = 0;
                                        const areaFields = ['补助面积（m²）', 'subsidy_area', 'area', '补助面积', '面积'];
                                        for (const field of areaFields) {
                                            if (subsidy[field] !== undefined && subsidy[field] !== null) {
                                                area = subsidy[field];
                                                console.log(`面积匹配字段: ${field} = "${area}"`);
                                                break;
                                            }
                                        }
                                        
                                        console.log(`最终匹配结果 - 名称: "${name}", 面积: "${area}"`);
                                        
                                        if (nameInput) {
                                            console.log(`设置前名称输入框值: "${nameInput.value}"`);
                                            console.log(`名称输入框placeholder: "${nameInput.placeholder}"`);
                                            console.log(`名称输入框类型: ${nameInput.type}`);
                                            
                                            nameInput.value = String(name || '');
                                            console.log(`设置后名称输入框值: "${nameInput.value}"`);
                                            
                                            // 强制刷新显示 - 多种方式
                                            nameInput.setAttribute('value', String(name || ''));
                                            
                                            // 触发多种事件
                                            nameInput.dispatchEvent(new Event('input', { bubbles: true }));
                                            nameInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            nameInput.dispatchEvent(new Event('keyup', { bubbles: true }));
                                            
                                            // 强制触发重绘
                                            nameInput.style.display = 'none';
                                            nameInput.offsetHeight; // 触发重排
                                            nameInput.style.display = '';
                                            
                                            console.log(`最终检查名称输入框值: "${nameInput.value}"`);
                                        } else {
                                            console.error('所有尝试都未找到名称输入框！');
                                            console.error('补助项HTML结构:', lastItem ? lastItem.outerHTML : '无lastItem');
                                        }
                                        
                                        if (areaInput) {
                                            console.log(`设置前面积输入框值: "${areaInput.value}"`);
                                            console.log(`面积输入框类型: ${areaInput.type}`);
                                            
                                            areaInput.value = String(area || 0);
                                            console.log(`设置后面积输入框值: "${areaInput.value}"`);
                                            
                                            // 强制刷新显示 - 多种方式
                                            areaInput.setAttribute('value', String(area || 0));
                                            
                                            // 触发多种事件
                                            areaInput.dispatchEvent(new Event('input', { bubbles: true }));
                                            areaInput.dispatchEvent(new Event('change', { bubbles: true }));
                                            areaInput.dispatchEvent(new Event('keyup', { bubbles: true }));
                                            
                                            // 强制触发重绘
                                            areaInput.style.display = 'none';
                                            areaInput.offsetHeight; // 触发重排
                                            areaInput.style.display = '';
                                            
                                            console.log(`最终检查面积输入框值: "${areaInput.value}"`);
                                        } else {
                                            console.error('所有尝试都未找到面积输入框！');
                                            console.error('补助项HTML结构:', lastItem ? lastItem.outerHTML : '无lastItem');
                                        }
                                    } else {
                                        console.error('未找到任何补助项元素');
                                    }
                                    
                                    // 处理下一个补助项
                                    addSubsidyRecursively(index + 1);
                                }, 500); // 增加延迟时间确保DOM完全更新
                            } else {
                                console.error('addSubsidy 函数不存在');
                                addSubsidyRecursively(index + 1);
                            }
                        }
                        
                        // 开始递归处理
                        addSubsidyRecursively(0);
                    }
                } catch (error) {
                    console.error('解析特殊补助数据失败:', error);
                    console.log('原始数据类型:', typeof school.special_subsidies);
                    console.log('原始数据内容:', school.special_subsidies);
                }
            }
        }

        // 删除记录
        async function deleteDataRecord(recordId) {
            if (!confirm('确定要删除这条记录吗？此操作不可恢复。')) {
                return;
            }
            
            console.log('开始删除记录ID:', recordId);
            
            // 显示删除进度
            const progressDiv = document.createElement('div');
            progressDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                            z-index: 2000; text-align: center;">
                    <h4>正在删除记录...</h4>
                    <p>请稍候，正在处理删除请求</p>
                </div>
            `;
            document.body.appendChild(progressDiv);
            
            try {
                const response = await fetch(`/api/school-record/${recordId}`, {
                    method: 'DELETE',
                    cache: 'no-cache',  // 禁用缓存
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                const result = await response.json();
                console.log('删除API响应:', result);
                
                // 移除进度提示
                progressDiv.remove();
                
                if (result.success) {
                    alert('记录删除成功！页面将自动刷新数据列表。');
                    console.log('删除成功，开始刷新数据列表...');
                    
                    // 清空当前显示的数据
                    allDataSchoolsData = [];
                    
                    // 立即显示加载状态
                    const resultsContainer = document.getElementById('dataHistoryResults');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '<div class="loading">正在刷新数据列表...</div>';
                    }
                    
                    // 延迟一点时间再刷新，确保数据库操作完成
                    setTimeout(() => {
                        console.log('执行数据刷新...');
                        searchDataRecords().then(() => {
                            console.log('数据刷新完成');
                            alert('数据列表已刷新！');
                        }).catch(err => {
                            console.error('刷新数据失败:', err);
                            alert('刷新数据失败，请手动点击"查找"按钮重新加载。');
                        });
                    }, 1000);
                } else {
                    console.error('删除失败:', result.error);
                    showDataError('删除失败: ' + result.error);
                }
            } catch (error) {
                // 移除进度提示
                progressDiv.remove();
                console.error('删除失败:', error);
                showDataError('删除失败: ' + error.message);
            }
        }

        // 下载记录
        async function downloadRecord(recordId) {
            try {
                const response = await fetch(`/api/download-record/${recordId}`);
                
                if (!response.ok) {
                    throw new Error('下载失败');
                }
                
                // 获取文件名
                const contentDisposition = response.headers.get('content-disposition');
                let filename = '学校记录.xlsx';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }
                
                // 创建下载链接
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('下载失败:', error);
                alert('下载失败: ' + error.message);
            }
        }

        // 显示错误信息
        function showDataError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;
            
            // 插入到数据管理页面顶部
            const container = document.querySelector('#page-data-management .content-body');
            if (container) {
                container.insertBefore(errorDiv, container.firstChild);
                
                // 3秒后自动移除
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 3000);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查数据库状态
            checkDatabaseStatus();
            
            // 移动端点击外部关闭菜单
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const menuBtn = document.querySelector('.mobile-menu-btn');
                    
                    if (sidebar && menuBtn && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                        closeSidebar();
                    }
                }
            });

            // 初始加载统计数据（如果在统计页面）
            const currentPage = document.querySelector('.page-content.active');
            if (currentPage && currentPage.id === 'page-statistics') {
                loadStatisticsContent();
            }
        });

        // ========== 年份选择器功能 ==========
        let currentYearGridIndex = 0; // 当前显示的年份组索引
        const currentYear = new Date().getFullYear(); // 当前年份
        const selectedYear = currentYear; // 已选择的年份

        // 显示年份选择器
        function showYearGrid() {
            const overlay = document.getElementById('yearGridOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
                
                // 计算当前年份应该在哪个组
                const yearInput = document.getElementById('year');
                const inputYear = parseInt(yearInput.value) || currentYear;
                currentYearGridIndex = Math.floor((inputYear - (currentYear - 4)) / 9);
                
                updateYearGrid();
                
                // 添加键盘事件监听
                document.addEventListener('keydown', handleYearGridKeyboard);
            }
        }

        // 隐藏年份选择器
        function hideYearGrid() {
            const overlay = document.getElementById('yearGridOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                
                // 移除键盘事件监听
                document.removeEventListener('keydown', handleYearGridKeyboard);
            }
        }

        // 移动年份网格
        function moveYearGrid(direction) {
            currentYearGridIndex += direction;
            updateYearGrid();
        }

        // 更新年份网格显示
        function updateYearGrid() {
            const yearGrid = document.getElementById('yearGrid');
            const yearRangeText = document.getElementById('yearRangeText');
            const yearInput = document.getElementById('year');
            const inputYear = parseInt(yearInput.value) || currentYear;
            
            if (!yearGrid || !yearRangeText) return;
            
            // 计算当前组的起始年份（以当前年份为中心，前后各4年，总共9年一组）
            const baseYear = currentYear - 4 + (currentYearGridIndex * 9);
            const years = [];
            
            for (let i = 0; i < 9; i++) {
                years.push(baseYear + i);
            }
            
            // 更新范围文本
            yearRangeText.textContent = `${years[0]} - ${years[8]}`;
            
            // 生成年份网格
            yearGrid.innerHTML = '';
            years.forEach(year => {
                const yearItem = document.createElement('div');
                yearItem.className = 'year-item';
                yearItem.textContent = year;
                yearItem.onclick = () => selectYear(year);
                
                // 标记当前年份
                if (year === currentYear) {
                    yearItem.classList.add('current');
                }
                
                // 标记已选择的年份
                if (year === inputYear) {
                    yearItem.classList.add('selected');
                }
                
                yearGrid.appendChild(yearItem);
            });
        }

        // 选择年份
        function selectYear(year) {
            const yearInput = document.getElementById('year');
            if (yearInput) {
                yearInput.value = year;
                
                // 触发change事件，如果有其他逻辑依赖年份变化
                const event = new Event('change', { bubbles: true });
                yearInput.dispatchEvent(event);
            }
            
            hideYearGrid();
        }

        // 处理键盘事件
        function handleYearGridKeyboard(e) {
            switch(e.key) {
                case 'Escape':
                    hideYearGrid();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    moveYearGrid(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    moveYearGrid(1);
                    break;
            }
        }

        // 点击遮罩层关闭年份选择器
        document.addEventListener('click', function(e) {
            const overlay = document.getElementById('yearGridOverlay');
            if (e.target === overlay) {
                hideYearGrid();
            }
        });
    </script>
</body>
</html>
